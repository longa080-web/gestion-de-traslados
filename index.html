<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Traslados de Taxi - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (versión CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .text-inter-accent-yellow { color: #FDD000; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }
        #transferTableBody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #005BAA;
            color: white;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-6xl bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <header class="text-center mb-6 bg-inter-primary rounded-t-xl py-6 relative overflow-hidden">
            <h1 class="text-4xl font-extrabold text-white mb-2 relative z-10">
                Control de Traslados de Taxi
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-md text-white mt-2 relative z-10">Registro y gestión de solicitudes de traslados de taxi</p>
            <div id="connectionStatus" class="absolute top-4 right-4 flex items-center">
                <span class="text-white text-sm mr-2">Conectado</span>
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </header>

        <!-- Pestañas de navegación -->
        <div class="mb-6 flex space-x-2 border-b border-gray-200">
            <button id="tabDashboard" class="tab-button active px-4 py-2 rounded-t-lg bg-inter-primary text-white font-semibold">
                Dashboard
            </button>
            <button id="tabReports" class="tab-button px-4 py-2 rounded-t-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300">
                Reportes Financieros
            </button>
        </div>

        <!-- Contenido del Dashboard (pestaña principal) -->
        <div id="dashboardContent">
            <section id="registerSection" class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Registrar Nuevo Traslado</h2>
                <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    
                    <div>
                        <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre del Solicitante
                        </label>
                        <input type="text" id="requesterName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                               placeholder="Ej. Juan Pérez">
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento/Área
                        </label>
                        <select id="department" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="" disabled selected>Selecciona un Departamento</option>
                            <option value="Administracion">Administración</option>
                            <option value="Area Comercial">Área Comercial</option>
                            <option value="Area tecnica">Área Técnica</option>
                            <option value="Obras">Obras</option>
                            <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                            <option value="Sistemas">Sistemas</option>
                            <option value="MSO">MSO</option>
                            <option value="Gerencia Senior">Gerencia Senior</option>
                        </select>
                    </div>
                    <div id="msoDepartmentsContainer" class="hidden col-span-1 md:col-span-3">
                        <label for="msoDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento MSO (Observaciones)
                        </label>
                        <select id="msoDepartment"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="" disabled selected>Selecciona departamento MSO</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Presidencia">Presidencia</option>
                            <option value="Interconexiones">Interconexiones</option>
                            <option value="Importaciones">Importaciones</option>
                            <option value="RRHH MSO">RRHH MSO</option>
                            <option value="Documentacion de obras">Documentación de Obras</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="originPlace" class="block text-sm font-medium text-gray-700 mb-1">
                            Lugar de Origen - Punto de Partida
                        </label>
                        <input type="text" id="originPlace" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                               placeholder="Ej. Sede Principal, Cliente X, Aeropuerto">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="destinationPlace" class="block text-sm font-medium text-gray-700 mb-1">
                            Lugar de Origen - Punto de Llegada
                        </label>
                        <input type="text" id="destinationPlace" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                               placeholder="Ej. Oficina Central, Hotel, Terminal">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="returnAddress" class="block text-sm font-medium text-gray-700 mb-1">
                            Dirección de Vuelta - Punto de Partida
                        </label>
                        <input type="text" id="returnAddress"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                               placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="returnDestination" class="block text-sm font-medium text-gray-700 mb-1">
                            Dirección de Vuelta - Destino Final
                        </label>
                        <input type="text" id="returnDestination"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                               placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                    </div>
                    <div>
                        <label for="transferDate" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha del Traslado
                        </label>
                        <input type="date" id="transferDate" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo del Traslado (USD $)
                        </label>
                        <input type="number" id="cost" step="0.01" min="0" value="0.00" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div>
                        <label for="authorizerName" class="block text-sm font-medium text-gray-700 mb-1">
                            Quién Autoriza
                        </label>
                        <select id="authorizerName" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="" disabled selected>Selecciona Autorizador</option>
                            <option value="Jorge Basualdo">Jorge Basualdo</option>
                        </select>
                    </div>
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                            Empresa de Traslado
                        </label>
                        <select id="companyName" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="" disabled selected>Selecciona Empresa</option>
                            <option value="Yummy">Yummy</option>
                            <option value="Andrew">Andrew</option>
                            <option value="Oscar">Oscar</option>
                            <option value="Neomar">Neomar</option>
                            <option value="Jose">Jose</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-3 flex justify-end space-x-4">
                        <button type="button" id="cancelEditBtn"
                                class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            Cancelar Edición
                        </button>
                        <button type="submit" id="submitButton"
                                class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                            Registrar Traslado
                        </button>
                    </div>
                </form>
                <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
            </section>

            <section class="mb-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Resumen de Gastos de Traslados</h2>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                        <p id="dailyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                        <p id="weeklyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                        <p id="monthlyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-semibold text-gray-700">Gastos Anuales</h3>
                        <p id="annualTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                </div>
            </section>

            <section class="p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Historial de Traslados</h2>

                <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-4">
                    <label for="filterRequester" class="text-sm font-medium text-gray-700 whitespace-nowrap">
                        Filtrar por Solicitante:
                    </label>
                    <input type="text" id="filterRequester"
                           class="w-full md:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Nombre del solicitante">
                    <button id="clearFilterBtn"
                            class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Limpiar Filtro
                    </button>
                    <button id="exportCsvBtn"
                            class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Exportar a Excel
                    </button>
                    <button id="importExcelBtn"
                            class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Importar de Excel
                    </button>
                    <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx">
                    <button id="deleteSelectedBtn"
                            class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Eliminar Seleccionados
                    </button>
                </div>

                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Solicitante</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Depto. MSO</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Origen Partida</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Origen Destino</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Vuelta Partida</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Vuelta Destino</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Quién Autoriza</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo ($)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transferTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="noTransfersMessage" class="text-center text-gray-500 mt-4 hidden">No hay traslados registrados aún.</p>
            </section>
            
            <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Gastos por Empresa de Traslado</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Mensual por Empresa</h3>
                        <div class="w-full max-w-lg h-64">
                            <canvas id="monthlyCompanyChart"></canvas>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Anual por Empresa</h3>
                        <div class="w-full max-w-lg h-64">
                            <canvas id="annualCompanyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Gastos por Departamento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Mensual por Departamento</h3>
                        <div class="w-full max-w-lg h-64">
                            <canvas id="monthlyDepartmentChart"></canvas>
                        </div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Anual por Departamento</h3>
                        <div class="w-full max-w-lg h-64">
                            <canvas id="annualDepartmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Estadísticas de Traslados por Departamento</h2>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Traslados Mensuales</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Mensual ($)</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Traslados Anuales</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Anual ($)</th>
                            </tr>
                        </thead>
                        <tbody id="departmentStatsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="noStatsMessage" class="text-center text-gray-500 mt-4 hidden">No hay datos de estadísticas disponibles.</p>
            </section>
        </div>

        <!-- Contenido de Reportes Financieros (nueva pestaña) -->
        <div id="reportsContent" class="hidden">
            <section class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Reportes Financieros de Traslados</h2>
                <div class="mb-6 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label for="reportMonth" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Mes
                        </label>
                        <select id="reportMonth" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label for="reportYear" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Año
                        </label>
                        <select id="reportYear" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="generateReportBtn" class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                            Generar Reporte
                        </button>
                    </div>
                </div>

                <!-- Botones de exportación -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <button id="exportReportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Exportar a Excel
                    </button>
                    <button id="exportReportPDFBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Exportar a PDF
                    </button>
                </div>

                <!-- Reporte: Departamentos que utilizan servicio de traslado -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 40%;">DEPARTAMENTOS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">UN CCS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsReportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Datos se cargarán aquí -->
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL CCS</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                    <td id="totalCCS" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                    <td id="totalMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                                <tr class="bg-inter-accent-light">
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL, CCS + MSO</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                    <td id="totalCCSMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Reporte: Empresas proveedoras de servicio CCS y MSO -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">EMPRESA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody id="companiesReportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Datos se cargarán aquí -->
                            </tbody>
                            <tfoot class="bg-inter-accent-light">
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL, CCS + MSO</td>
                                    <td id="totalCompanies" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Resumen por unidad -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">RESUMEN POR UNIDAD</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">UNIDAD</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">CCS</td>
                                    <td id="unitCCS" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">MSO</td>
                                    <td id="unitMSO" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                </tr>
                                <tr class="bg-inter-accent-light">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">TOTAL</td>
                                    <td id="unitTotal" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCfEP2_MYdPRCb4gKnXLEV-tUNNFkQmkOo",
            authDomain: "gestion-de-traslados.firebaseapp.com",
            projectId: "gestion-de-traslados",
            storageBucket: "gestion-de-traslados.firebasestorage.app",
            messagingSenderId: "547255399573",
            appId: "1:547255399573:web:c636870e286428fb81979c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        Chart.register(ChartDataLabels);
        
        // Elementos del Dashboard
        const transferForm = document.getElementById('transferForm');
        const requesterNameInput = document.getElementById('requesterName');
        const departmentInput = document.getElementById('department');
        const msoDepartmentsContainer = document.getElementById('msoDepartmentsContainer');
        const msoDepartmentInput = document.getElementById('msoDepartment');
        const originPlaceInput = document.getElementById('originPlace');
        const destinationPlaceInput = document.getElementById('destinationPlace');
        const returnAddressInput = document.getElementById('returnAddress');
        const returnDestinationInput = document.getElementById('returnDestination');
        const transferDateInput = document.getElementById('transferDate');
        const costInput = document.getElementById('cost');
        const authorizerNameInput = document.getElementById('authorizerName');
        const companyNameInput = document.getElementById('companyName');
        const messageBox = document.getElementById('messageBox');
        const transferTableBody = document.getElementById('transferTableBody');
        const departmentStatsTableBody = document.getElementById('departmentStatsTableBody');
        const dailyTotalSpan = document.getElementById('dailyTotal');
        const weeklyTotalSpan = document.getElementById('weeklyTotal');
        const monthlyTotalSpan = document.getElementById('monthlyTotal');
        const annualTotalSpan = document.getElementById('annualTotal');
        const noTransfersMessage = document.getElementById('noTransfersMessage');
        const noStatsMessage = document.getElementById('noStatsMessage');
        const submitButton = document.getElementById('submitButton');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const registerSection = document.getElementById('registerSection');
        const connectionStatus = document.getElementById('connectionStatus');

        // Elementos de pestañas
        const tabDashboard = document.getElementById('tabDashboard');
        const tabReports = document.getElementById('tabReports');
        const dashboardContent = document.getElementById('dashboardContent');
        const reportsContent = document.getElementById('reportsContent');

        // Elementos de reportes
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearSelect = document.getElementById('reportYear');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportReportExcelBtn = document.getElementById('exportReportExcelBtn');
        const exportReportPDFBtn = document.getElementById('exportReportPDFBtn');
        const departmentsReportTableBody = document.getElementById('departmentsReportTableBody');
        const companiesReportTableBody = document.getElementById('companiesReportTableBody');
        const totalCCS = document.getElementById('totalCCS');
        const totalMSO = document.getElementById('totalMSO');
        const totalCCSMSO = document.getElementById('totalCCSMSO');
        const totalCompanies = document.getElementById('totalCompanies');
        const unitCCS = document.getElementById('unitCCS');
        const unitMSO = document.getElementById('unitMSO');
        const unitTotal = document.getElementById('unitTotal');

        // Gráficos
        const monthlyCompanyChartCtx = document.getElementById('monthlyCompanyChart').getContext('2d');
        const annualCompanyChartCtx = document.getElementById('annualCompanyChart').getContext('2d');
        const monthlyDepartmentChartCtx = document.getElementById('monthlyDepartmentChart').getContext('2d');
        const annualDepartmentChartCtx = document.getElementById('annualDepartmentChart').getContext('2d');
        
        let monthlyCompanyChart;
        let annualCompanyChart;
        let monthlyDepartmentChart;
        let annualDepartmentChart;

        const filterRequesterInput = document.getElementById('filterRequester');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const fileInput = document.getElementById('fileInput');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');

        let transfers = [];
        let editingId = null;
        let unsubscribeTransfers = null;

        // Lista de departamentos para reportes (según el formato Word)
        const reportDepartments = [
            { name: "ADMINISTRACION", code: "Administracion" },
            { name: "AREA COMERCIAL", code: "Area Comercial" },
            { name: "AREA TECNICA", code: "Area tecnica" },
            { name: "DPTO DE OBRAS", code: "Obras" },
            { name: "RRHH y Seguridad Laboral", code: "RRHH y Seguridad Laboral" },
            { name: "G. SENIOR", code: "Gerencia Senior" },
            { name: "MSO", code: "MSO" }
        ];

        // Lista de empresas para reportes
        const reportCompanies = [
            { name: "YUMMY", code: "Yummy" },
            { name: "ANDREW", code: "Andrew" },
            { name: "NEOMAR", code: "Neomar" },
            { name: "OSCAR", code: "Oscar" },
            { name: "JOSE", code: "Jose" }
        ];

        function showMessage(message, type = 'info', box = messageBox) {
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        function normalizeDateToStartOfDay(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Manejar cambio en departamento MSO
        departmentInput.addEventListener('change', function() {
            if (this.value === 'MSO') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.required = true;
            } else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
                msoDepartmentInput.value = '';
            }
        });

        // Función para cargar traslados desde Firestore
        function loadTransfers() {
            try {
                showMessage("Conectando a la base de datos...", "info");
                
                // Usar Firestore directamente
                const transfersRef = db.collection('transfers');
                
                // Suscribirse a cambios en tiempo real
                unsubscribeTransfers = transfersRef.orderBy('dateTime', 'asc')
                    .onSnapshot((querySnapshot) => {
                        transfers = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            transfers.push({
                                id: doc.id,
                                ...data,
                                dateTime: normalizeDateToStartOfDay(new Date(data.dateTime))
                            });
                        });
                        
                        renderTransfers();
                        updateSummaries();
                        updateConnectionStatus(true);
                        showMessage("Datos cargados correctamente", "success");
                        
                        // Generar reporte del mes actual por defecto
                        generateReport();
                    }, (error) => {
                        console.error("Error en tiempo real:", error);
                        updateConnectionStatus(false);
                        showMessage("Error de conexión con la base de datos", "error");
                    });

            } catch (e) {
                console.error("Error al cargar datos de Firestore:", e);
                showMessage("Error al cargar datos. Verifica tu conexión a internet.", "error");
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusText = connectionStatus.querySelector('span');
            const statusDot = connectionStatus.querySelector('div');
            
            if (connected) {
                statusText.textContent = 'Conectado';
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
            } else {
                statusText.textContent = 'Desconectado';
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
        }

        // Función para guardar un traslado en Firestore
        async function saveTransfer(transferData) {
            try {
                // Convertir fecha a string ISO para Firestore
                const dataToSave = {
                    ...transferData,
                    dateTime: transferData.dateTime.toISOString()
                };
                
                if (editingId) {
                    // Actualizar documento existente
                    await db.collection('transfers').doc(editingId).update(dataToSave);
                    showMessage("¡Traslado actualizado con éxito!", "success");
                } else {
                    // Crear nuevo documento
                    await db.collection('transfers').add(dataToSave);
                    showMessage("¡Traslado registrado con éxito!", "success");
                }
                
                return true;
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
                showMessage("Error al guardar los datos. Verifica tu conexión.", "error");
                return false;
            }
        }

        // Función para eliminar traslados de Firestore
        async function deleteTransfers(ids) {
            try {
                const deletePromises = ids.map(id => {
                    return db.collection('transfers').doc(id).delete();
                });
                
                await Promise.all(deletePromises);
                showMessage("Traslados eliminados con éxito.", "success");
                return true;
            } catch (e) {
                console.error("Error al eliminar de Firestore:", e);
                showMessage("Error al eliminar los datos. Verifica tu conexión.", "error");
                return false;
            }
        }

        function renderTransfers() {
            transferTableBody.innerHTML = '';
            selectAllCheckboxes.checked = false;

            const filterText = filterRequesterInput.value.trim().toLowerCase();
            let displayTransfers = [...transfers];
            if (filterText) {
                displayTransfers = displayTransfers.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(filterText)
                );
            }

            const requesterCounts = {};
            transfers.forEach(transfer => {
                const name = transfer.requesterName.toLowerCase();
                requesterCounts[name] = (requesterCounts[name] || 0) + 1;
            });
            let maxCount = 0;
            if (Object.keys(requesterCounts).length > 0) {
                maxCount = Math.max(...Object.values(requesterCounts));
            }

            const topRequesters = Object.keys(requesterCounts).filter(name => requesterCounts[name] === maxCount && maxCount > 0);
            const sortedTransfers = displayTransfers.sort((a, b) => b.dateTime.getTime() - a.dateTime.getTime());

            if (sortedTransfers.length === 0) {
                noTransfersMessage.classList.remove('hidden');
            } else {
                noTransfersMessage.classList.add('hidden');
                sortedTransfers.forEach((transfer) => {
                    const row = document.createElement('tr');
                    const isTopRequester = topRequesters.includes(transfer.requesterName.toLowerCase());
                    const requesterClass = isTopRequester ? 'font-bold text-inter-accent-yellow' : '';

                    const formattedDate = transfer.dateTime.toLocaleDateString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${transfer.id}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${requesterClass}">${transfer.requesterName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.department || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.msoDepartment || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.originPlace || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.destinationPlace || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.returnAddress || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.returnDestination || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.authorizerName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.companyName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">$${transfer.cost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="startEditTransfer('${transfer.id}')" 
                                class="text-inter-primary hover:text-blue-700 font-bold text-xs py-1 px-2 rounded-md border border-inter-primary hover:border-blue-700 transition duration-150">
                                Editar
                            </button>
                        </td>
                    `;
                    transferTableBody.appendChild(row);
                });
            }
        }
        
        function startEditTransfer(id) {
            const transfer = transfers.find(t => t.id === id);
            if (!transfer) {
                showMessage("Error: Traslado no encontrado.", "error");
                return;
            }

            // Cargar datos en el formulario
            requesterNameInput.value = transfer.requesterName;
            departmentInput.value = transfer.department;
            
            if (transfer.department === 'MSO') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.value = transfer.msoDepartment || '';
                msoDepartmentInput.required = true;
            } else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
            }
            
            originPlaceInput.value = transfer.originPlace || '';
            destinationPlaceInput.value = transfer.destinationPlace || '';
            returnAddressInput.value = transfer.returnAddress || '';
            returnDestinationInput.value = transfer.returnDestination || '';
            transferDateInput.value = transfer.dateTime.toISOString().slice(0, 10);
            costInput.value = transfer.cost.toFixed(2);
            authorizerNameInput.value = transfer.authorizerName;
            companyNameInput.value = transfer.companyName;

            // Establecer el modo edición
            editingId = id;
            submitButton.textContent = 'Guardar Cambios';
            cancelEditBtn.classList.remove('hidden');

            // Desplazarse al formulario
            registerSection.scrollIntoView({ behavior: 'smooth' });
            showMessage(`Modo Edición: Editando traslado de ${transfer.requesterName}.`, "info");
        }

        function cancelEdit() {
            editingId = null;
            transferForm.reset();
            submitButton.textContent = 'Registrar Traslado';
            cancelEditBtn.classList.add('hidden');
            msoDepartmentsContainer.classList.add('hidden');
            msoDepartmentInput.required = false;
            transferDateInput.value = new Date().toISOString().slice(0, 10);
            showMessage("Modo de registro restaurado.", "success");
        }

        cancelEditBtn.addEventListener('click', cancelEdit);

        function updateSummaries() {
            const now = new Date();
            const todayStart = normalizeDateToStartOfDay(now);
            const dailyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() === todayStart.getTime());
            const dailyTotal = dailyTransfers.reduce((sum, t) => sum + t.cost, 0);
            dailyTotalSpan.textContent = `$${dailyTotal.toFixed(2)}`;
            
            const dayOfWeek = (now.getDay() + 6) % 7;
            const startOfWeek = normalizeDateToStartOfDay(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            const weeklyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfWeek.getTime());
            const weeklyTotal = weeklyTransfers.reduce((sum, t) => sum + t.cost, 0);
            weeklyTotalSpan.textContent = `$${weeklyTotal.toFixed(2)}`;

            const startOfMonth = normalizeDateToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
            const monthlyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            const monthlyTotal = monthlyTransfers.reduce((sum, t) => sum + t.cost, 0);
            monthlyTotalSpan.textContent = `$${monthlyTotal.toFixed(2)}`;

            const startOfYear = normalizeDateToStartOfDay(new Date(now.getFullYear(), 0, 1));
            const annualTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime());
            const annualTotal = annualTransfers.reduce((sum, t) => sum + t.cost, 0);
            annualTotalSpan.textContent = `$${annualTotal.toFixed(2)}`;

            updateCompanyCharts();
            updateDepartmentCharts();
            renderDepartmentStats();
        }

        function updateCompanyCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyCompanyExpenses = {};
            monthlyTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                monthlyCompanyExpenses[company] = (monthlyCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualCompanyExpenses = {};
            annualTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                annualCompanyExpenses[company] = (annualCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Gráfico mensual
            const monthlyCompanyLabels = Object.keys(monthlyCompanyExpenses);
            const monthlyCompanyData = Object.values(monthlyCompanyExpenses);
            
            if (monthlyCompanyChart) { monthlyCompanyChart.destroy(); }
            monthlyCompanyChart = new Chart(monthlyCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyCompanyLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyCompanyData,
                        backgroundColor: '#5CE1E6',
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });

            // Gráfico anual
            const annualCompanyLabels = Object.keys(annualCompanyExpenses);
            const annualCompanyData = Object.values(annualCompanyExpenses);
            
            if (annualCompanyChart) { annualCompanyChart.destroy(); }
            annualCompanyChart = new Chart(annualCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: annualCompanyLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualCompanyData,
                        backgroundColor: '#005BAA',
                        borderColor: '#003366',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#FFFFFF',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        function updateDepartmentCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyDepartmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                monthlyDepartmentExpenses[department] = (monthlyDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualDepartmentExpenses = {};
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                annualDepartmentExpenses[department] = (annualDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Gráfico mensual
            const monthlyDepartmentLabels = Object.keys(monthlyDepartmentExpenses);
            const monthlyDepartmentData = Object.values(monthlyDepartmentExpenses);
            
            if (monthlyDepartmentChart) { monthlyDepartmentChart.destroy(); }
            monthlyDepartmentChart = new Chart(monthlyDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Gráfico anual
            const annualDepartmentLabels = Object.keys(annualDepartmentExpenses);
            const annualDepartmentData = Object.values(annualDepartmentExpenses);
            
            if (annualDepartmentChart) { annualDepartmentChart.destroy(); }
            annualDepartmentChart = new Chart(annualDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: annualDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderDepartmentStats() {
            departmentStatsTableBody.innerHTML = '';
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );

            const departmentStats = {};

            // Procesar datos mensuales
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].monthlyCount++;
                departmentStats[department].monthlyCost += transfer.cost;
            });

            // Procesar datos anuales
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].annualCount++;
                departmentStats[department].annualCost += transfer.cost;
            });

            const departments = Object.keys(departmentStats).sort();
            
            if (departments.length === 0) {
                noStatsMessage.classList.remove('hidden');
            } else {
                noStatsMessage.classList.add('hidden');
                departments.forEach(department => {
                    const stats = departmentStats[department];
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${department}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.monthlyCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">$${stats.monthlyCost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${stats.annualCount}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">$${stats.annualCost.toFixed(2)}</td>
                    `;
                    departmentStatsTableBody.appendChild(row);
                });
            }
        }

        // Función para generar reporte financiero
        function generateReport() {
            const month = parseInt(reportMonthSelect.value);
            const year = parseInt(reportYearSelect.value);
            
            // Filtrar traslados por mes y año seleccionados
            const filteredTransfers = transfers.filter(transfer => {
                const transferDate = transfer.dateTime;
                return transferDate.getMonth() === month && transferDate.getFullYear() === year;
            });
            
            // Calcular totales por departamento
            const departmentTotals = {};
            let totalCCSAmount = 0;
            let totalMSOAmount = 0;
            
            reportDepartments.forEach(dept => {
                departmentTotals[dept.code] = 0;
            });
            
            filteredTransfers.forEach(transfer => {
                const department = transfer.department;
                const cost = transfer.cost || 0;
                
                if (department && departmentTotals.hasOwnProperty(department)) {
                    departmentTotals[department] += cost;
                    
                    // Sumar a CCS o MSO según corresponda
                    if (department === 'MSO') {
                        totalMSOAmount += cost;
                    } else {
                        totalCCSAmount += cost;
                    }
                }
            });
            
            // Actualizar tabla de departamentos
            departmentsReportTableBody.innerHTML = '';
            reportDepartments.forEach(dept => {
                const amount = departmentTotals[dept.code] || 0;
                const isMSO = dept.code === 'MSO';
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${dept.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${isMSO ? 'MSO' : 'UN CCS'}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">$${amount.toFixed(2)}</td>
                `;
                departmentsReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de departamentos
            totalCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            totalMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            const totalCCSMSOTotal = totalCCSAmount + totalMSOAmount;
            totalCCSMSO.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
            
            // Calcular totales por empresa
            const companyTotals = {};
            let totalCompaniesAmount = 0;
            
            reportCompanies.forEach(company => {
                companyTotals[company.code] = 0;
            });
            
            filteredTransfers.forEach(transfer => {
                const company = transfer.companyName;
                const cost = transfer.cost || 0;
                
                if (company && companyTotals.hasOwnProperty(company)) {
                    companyTotals[company] += cost;
                    totalCompaniesAmount += cost;
                }
            });
            
            // Actualizar tabla de empresas
            companiesReportTableBody.innerHTML = '';
            reportCompanies.forEach(company => {
                const amount = companyTotals[company.code] || 0;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${company.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">$${amount.toFixed(2)}</td>
                `;
                companiesReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de empresas
            totalCompanies.textContent = `$${totalCompaniesAmount.toFixed(2)}`;
            
            // Actualizar resumen por unidad
            unitCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            unitMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            unitTotal.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
        }

        // Función para exportar reporte a Excel
        function exportReportToExcel() {
            const month = parseInt(reportMonthSelect.value);
            const year = parseInt(reportYearSelect.value);
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Crear workbook
            const workbook = XLSX.utils.book_new();
            
            // Hoja 1: Departamentos
            const departmentsData = [
                ['MES:', `${monthNames[month]} ${year}`],
                [],
                ['DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO'],
                ['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']
            ];
            
            // Agregar filas de departamentos
            reportDepartments.forEach(dept => {
                const amount = parseFloat(document.querySelector(`#departmentsReportTableBody tr:nth-child(${reportDepartments.indexOf(dept) + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                const isMSO = dept.code === 'MSO';
                departmentsData.push([dept.name, isMSO ? 'MSO' : 'UN CCS', amount]);
            });
            
            // Agregar totales
            departmentsData.push(['TOTAL CCS', '', parseFloat(totalCCS.textContent.replace('$', '')) || 0]);
            departmentsData.push(['MSO', 'MSO', parseFloat(totalMSO.textContent.replace('$', '')) || 0]);
            departmentsData.push(['TOTAL, CCS + MSO', '', parseFloat(totalCCSMSO.textContent.replace('$', '')) || 0]);
            
            const departmentsSheet = XLSX.utils.aoa_to_sheet(departmentsData);
            XLSX.utils.book_append_sheet(workbook, departmentsSheet, 'Departamentos');
            
            // Hoja 2: Empresas
            const companiesData = [
                ['MES:', `${monthNames[month]} ${year}`],
                [],
                ['EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO'],
                ['EMPRESA', 'IMPORTE']
            ];
            
            // Agregar filas de empresas
            reportCompanies.forEach((company, index) => {
                const amount = parseFloat(document.querySelector(`#companiesReportTableBody tr:nth-child(${index + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                companiesData.push([company.name, amount]);
            });
            
            // Agregar total
            companiesData.push(['TOTAL, CCS + MSO', parseFloat(totalCompanies.textContent.replace('$', '')) || 0]);
            
            const companiesSheet = XLSX.utils.aoa_to_sheet(companiesData);
            XLSX.utils.book_append_sheet(workbook, companiesSheet, 'Empresas');
            
            // Hoja 3: Resumen por unidad
            const unitData = [
                ['MES:', `${monthNames[month]} ${year}`],
                [],
                ['RESUMEN POR UNIDAD'],
                ['UNIDAD', 'IMPORTE'],
                ['CCS', parseFloat(unitCCS.textContent.replace('$', '')) || 0],
                ['MSO', parseFloat(unitMSO.textContent.replace('$', '')) || 0],
                ['TOTAL', parseFloat(unitTotal.textContent.replace('$', '')) || 0]
            ];
            
            const unitSheet = XLSX.utils.aoa_to_sheet(unitData);
            XLSX.utils.book_append_sheet(workbook, unitSheet, 'Resumen Unidad');
            
            // Descargar archivo
            const fileName = `Reporte_Traslados_${monthNames[month]}_${year}.xlsx`;
            XLSX.writeFile(workbook, fileName);
            
            showMessage(`Reporte exportado a Excel: ${fileName}`, "success");
        }

        // Función para exportar reporte a PDF
        function exportReportToPDF() {
            const month = parseInt(reportMonthSelect.value);
            const year = parseInt(reportYearSelect.value);
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Crear nuevo documento PDF
            const doc = new jsPDF();
            
            // Título principal
            doc.setFontSize(16);
            doc.setTextColor(0, 91, 170); // Color inter-primary
            doc.text('REPORTE FINANCIERO DE TRASLADOS', 105, 20, null, null, 'center');
            
            // Mes y año
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`MES: ${monthNames[month]} ${year}`, 105, 30, null, null, 'center');
            
            let yPos = 40;
            
            // Sección 1: Departamentos que utilizan servicio de traslado
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de departamentos
            const departmentsData = [];
            reportDepartments.forEach(dept => {
                const amount = parseFloat(document.querySelector(`#departmentsReportTableBody tr:nth-child(${reportDepartments.indexOf(dept) + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                const isMSO = dept.code === 'MSO';
                departmentsData.push([
                    dept.name,
                    isMSO ? 'MSO' : 'UN CCS',
                    `$${amount.toFixed(2)}`
                ]);
            });
            
            // Agregar totales a la tabla
            departmentsData.push([
                'TOTAL CCS',
                '',
                totalCCS.textContent
            ]);
            departmentsData.push([
                'MSO',
                'MSO',
                totalMSO.textContent
            ]);
            departmentsData.push([
                'TOTAL, CCS + MSO',
                '',
                totalCCSMSO.textContent
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']],
                body: departmentsData,
                theme: 'striped',
                headStyles: { fillColor: [0, 91, 170], textColor: [255, 255, 255] },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Sección 2: Empresas proveedoras
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de empresas
            const companiesData = [];
            reportCompanies.forEach((company, index) => {
                const amount = parseFloat(document.querySelector(`#companiesReportTableBody tr:nth-child(${index + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                companiesData.push([
                    company.name,
                    `$${amount.toFixed(2)}`
                ]);
            });
            
            // Agregar total
            companiesData.push([
                'TOTAL, CCS + MSO',
                totalCompanies.textContent
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['EMPRESA', 'IMPORTE']],
                body: companiesData,
                theme: 'striped',
                headStyles: { fillColor: [92, 225, 230], textColor: [0, 0, 0] }, // Color inter-accent-light
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Sección 3: Resumen por unidad
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('RESUMEN POR UNIDAD', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de resumen por unidad
            const unitData = [
                ['CCS', unitCCS.textContent],
                ['MSO', unitMSO.textContent],
                ['TOTAL', unitTotal.textContent]
            ];
            
            doc.autoTable({
                startY: yPos,
                head: [['UNIDAD', 'IMPORTE']],
                body: unitData,
                theme: 'striped',
                headStyles: { fillColor: [0, 91, 170], textColor: [255, 255, 255] },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            // Información de generación
            const finalY = doc.autoTable.previous.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 105, finalY, null, null, 'center');
            doc.text('Sistema de Control de Traslados de Taxi - Inter', 105, finalY + 5, null, null, 'center');
            
            // Guardar PDF
            const fileName = `Reporte_Traslados_${monthNames[month]}_${year}.pdf`;
            doc.save(fileName);
            
            showMessage(`Reporte exportado a PDF: ${fileName}`, "success");
        }

        // Event Listeners para pestañas
        tabDashboard.addEventListener('click', () => {
            tabDashboard.classList.add('active', 'bg-inter-primary', 'text-white');
            tabDashboard.classList.remove('bg-gray-200', 'text-gray-700');
            tabReports.classList.remove('active', 'bg-inter-primary', 'text-white');
            tabReports.classList.add('bg-gray-200', 'text-gray-700');
            dashboardContent.classList.remove('hidden');
            reportsContent.classList.add('hidden');
        });

        tabReports.addEventListener('click', () => {
            tabReports.classList.add('active', 'bg-inter-primary', 'text-white');
            tabReports.classList.remove('bg-gray-200', 'text-gray-700');
            tabDashboard.classList.remove('active', 'bg-inter-primary', 'text-white');
            tabDashboard.classList.add('bg-gray-200', 'text-gray-700');
            reportsContent.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            generateReport();
        });

        // Event Listeners para reportes
        generateReportBtn.addEventListener('click', generateReport);
        exportReportExcelBtn.addEventListener('click', exportReportToExcel);
        exportReportPDFBtn.addEventListener('click', exportReportToPDF);

        // Event Listeners del Dashboard
        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = submitButton;
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            document.body.classList.add('loading');

            try {
                const transferData = {
                    requesterName: requesterNameInput.value.trim(),
                    department: departmentInput.value,
                    msoDepartment: departmentInput.value === 'MSO' ? msoDepartmentInput.value : '',
                    originPlace: originPlaceInput.value.trim(),
                    destinationPlace: destinationPlaceInput.value.trim(),
                    returnAddress: returnAddressInput.value.trim(),
                    returnDestination: returnDestinationInput.value.trim(),
                    dateTime: normalizeDateToStartOfDay(new Date(transferDateInput.value)),
                    cost: parseFloat(costInput.value),
                    authorizerName: authorizerNameInput.value,
                    companyName: companyNameInput.value
                };

                const success = await saveTransfer(transferData);
                if (success) {
                    transferForm.reset();
                    msoDepartmentsContainer.classList.add('hidden');
                    msoDepartmentInput.required = false;
                    transferDateInput.value = new Date().toISOString().slice(0, 10);
                    if (editingId) {
                        cancelEdit();
                    }
                }
            } catch (error) {
                console.error("Error al procesar el formulario:", error);
                showMessage("Error al procesar la solicitud.", "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                document.body.classList.remove('loading');
            }
        });

        filterRequesterInput.addEventListener('input', renderTransfers);
        clearFilterBtn.addEventListener('click', () => {
            filterRequesterInput.value = '';
            renderTransfers();
        });

        exportCsvBtn.addEventListener('click', () => {
            if (transfers.length === 0) {
                showMessage("No hay datos para exportar.", "error");
                return;
            }
        
            const dataToExport = transfers.map(t => ({
                'Fecha': t.dateTime.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                'Solicitante': t.requesterName,
                'Departamento': t.department,
                'Depto. MSO': t.msoDepartment || '',
                'Origen Partida': t.originPlace || '',
                'Origen Destino': t.destinationPlace || '',
                'Vuelta Partida': t.returnAddress || '',
                'Vuelta Destino': t.returnDestination || '',
                'Quién Autoriza': t.authorizerName,
                'Empresa de Traslado': t.companyName,
                'Costo ($)': t.cost
            }));

            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const monthlyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            
            const departmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                departmentExpenses[department] = (departmentExpenses[department] || 0) + transfer.cost;
            });

            const departmentSummaryData = Object.entries(departmentExpenses).map(([department, cost]) => ({
                'Departamento': department,
                'Gasto Mensual Total ($)': cost
            }));
            
            const mainWorksheet = XLSX.utils.json_to_sheet(dataToExport);
            const summaryWorksheet = XLSX.utils.json_to_sheet(departmentSummaryData);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, mainWorksheet, 'Historial');
            XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'Resumen por Departamento');
            XLSX.writeFile(workbook, `traslados_taxi_${new Date().toISOString().slice(0,10)}.xlsx`);
        });

        importExcelBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Saltar la fila de encabezado y procesar datos
                const importedTransfers = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 11) {
                        const [dateStr, requesterName, department, msoDepartment, originPlace, destinationPlace, returnAddress, returnDestination, authorizerName, companyName, cost] = row;
                        
                        // Parsear fecha
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: msoDepartment?.toString() || '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: destinationPlace?.toString() || '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: returnDestination?.toString() || '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    } else if (row.length >= 8) {
                        // Formato antiguo (compatibilidad con archivos antiguos)
                        const [dateStr, requesterName, department, originPlace, returnAddress, authorizerName, companyName, cost] = row;
                        
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    }
                }

                // Guardar todos los traslados importados
                let successCount = 0;
                for (const transfer of importedTransfers) {
                    const success = await saveTransfer(transfer);
                    if (success) successCount++;
                }

                showMessage(`Importación completada: ${successCount}/${importedTransfers.length} traslados importados.`, "success");
                fileInput.value = '';

            } catch (error) {
                console.error("Error al importar archivo:", error);
                showMessage("Error al importar el archivo. Verifica el formato.", "error");
            }
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage("Por favor, selecciona al menos un traslado para eliminar.", "error");
                return;
            }

            if (!confirm(`¿Estás seguro de que deseas eliminar ${checkboxes.length} traslado(s)? Esta acción no se puede deshacer.`)) {
                return;
            }

            const idsToDelete = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            const success = await deleteTransfers(idsToDelete);
            if (success) {
                selectAllCheckboxes.checked = false;
            }
        });

        selectAllCheckboxes.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            transferDateInput.value = new Date().toISOString().slice(0, 10);
            
            // Establecer mes actual en el selector de reportes
            const currentMonth = new Date().getMonth();
            reportMonthSelect.value = currentMonth.toString();
            
            loadTransfers();
        });

        // Limpiar suscripción al cerrar la página
        window.addEventListener('beforeunload', () => {
            if (unsubscribeTransfers) {
                unsubscribeTransfers();
            }
        });

        // Hacer la función accesible globalmente
        window.startEditTransfer = startEditTransfer;
    </script>
</body>
</html>
