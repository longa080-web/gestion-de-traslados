<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Traslados de Taxi - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .text-inter-accent-yellow { color: #FDD000; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }
        #transferTableBody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #005BAA;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <span class="ml-3 text-inter-primary font-semibold">Cargando datos...</span>
    </div>

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <header class="text-center mb-6 bg-inter-primary rounded-t-xl py-6 relative overflow-hidden">
            <h1 class="text-4xl font-extrabold text-white mb-2 relative z-10">
                Control de Traslados de Taxi
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-md text-white mt-2 relative z-10">Registro y gestión de solicitudes de traslados de taxi</p>
            <div id="connectionStatus" class="absolute top-4 right-4 text-sm bg-green-500 px-2 py-1 rounded hidden text-white">
                Conectado a Firebase
            </div>
        </header>

        <section id="registerSection" class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Registrar Nuevo Traslado</h2>
            <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                
                <div>
                    <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nombre del Solicitante
                    </label>
                    <input type="text" id="requesterName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Juan Pérez">
                </div>
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento/Área
                    </label>
                    <select id="department" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="Administracion">Administración</option>
                        <option value="Area Comercial">Área Comercial</option>
                        <option value="Area tecnica">Área Técnica</option>
                        <option value="Obras">Obras</option>
                        <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                        <option value="Sistemas">Sistemas</option>
                        <option value="MSO">MSO</option>
                        <option value="Gerencia Senior">Gerencia Senior</option>
                    </select>
                </div>
                <div>
                    <label for="originPlace" class="block text-sm font-medium text-gray-700 mb-1">
                        Lugar de Origen
                    </label>
                    <input type="text" id="originPlace" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Sede Principal, Cliente X, Aeropuerto">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="returnAddress" class="block text-sm font-medium text-gray-700 mb-1">
                        Dirección de Vuelta (Opcional, si aplica)
                    </label>
                    <input type="text" id="returnAddress"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                </div>
                <div>
                    <label for="transferDate" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha del Traslado
                    </label>
                    <input type="date" id="transferDate" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo del Traslado (USD $)
                    </label>
                    <input type="number" id="cost" step="0.01" min="0" value="0.00" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label for="authorizerName" class="block text-sm font-medium text-gray-700 mb-1">
                        Quién Autoriza
                    </label>
                    <select id="authorizerName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona Autorizador</option>
                        <option value="Jorge Basualdo">Jorge Basualdo</option>
                        <option value="Lais Troncoso">Lais Troncoso</option>
                    </select>
                </div>
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                        Empresa de Traslado
                    </label>
                    <select id="companyName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona Empresa</option>
                        <option value="Yummy">Yummy</option>
                        <option value="Andrew">Andrew</option>
                        <option value="Oscar">Oscar</option>
                        <option value="Neomar">Neomar</option>
                        <option value="Jose">Jose</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-3 flex justify-end space-x-4">
                    <button type="button" id="cancelEditBtn"
                            class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edición
                    </button>
                    <button type="submit" id="submitButton"
                            class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Registrar Traslado
                    </button>
                </div>
            </form>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Resumen de Gastos de Traslados</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                    <p id="dailyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                    <p id="weeklyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                    <p id="monthlyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Anuales</h3>
                    <p id="annualTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
            </div>
        </section>

        <section class="p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Historial de Traslados</h2>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-4">
                <label for="filterRequester" class="text-sm font-medium text-gray-700 whitespace-nowrap">
                    Filtrar por Solicitante:
                </label>
                <input type="text" id="filterRequester"
                       class="w-full md:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                       placeholder="Nombre del solicitante">
                <button id="clearFilterBtn"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Limpiar Filtro
                </button>
                <button id="exportCsvBtn"
                        class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Exportar a Excel (CSV)
                </button>
                <button id="importExcelBtn"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Importar de Excel
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx">
                <button id="deleteSelectedBtn"
                        class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Eliminar Seleccionados
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Solicitante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Origen</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Dirección Vuelta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Quién Autoriza</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo ($)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th> </tr>
                    </thead>
                    <tbody id="transferTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="noTransfersMessage" class="text-center text-gray-500 mt-4 hidden">No hay traslados registrados aún.</p>
        </section>
        
        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Análisis de Gastos Mensual y Anual</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                    <h3 id="chartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Control de Gastos Mensual por Año</h3>
                    <div class="w-full max-w-lg h-64">
                        <canvas id="annualExpensesChart"></canvas>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                    <h3 id="companyExpensesChartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Anual por Empresa de Traslado</h3>
                    <div class="w-full max-w-lg h-64">
                        <canvas id="companyExpensesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Pagos a Proveedores de Traslados</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Mensual Total ($)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo Unitario Promedio ($)</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="noPaymentsMessage" class="text-center text-gray-500 mt-4 hidden">No hay datos de pagos para este mes.</p>
        </section>

        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Análisis de Gasto Mensual por Departamento</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Total de Traslados por Departamento (Mensual)</h3>
                <div class="w-full max-w-lg h-64">
                    <canvas id="departmentExpensesChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <!-- Firebase SDK al final del body -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfEP2_MYdPRCb4gKnXLEV-tUNNFkQmkOo",
            authDomain: "gestion-de-traslados.firebaseapp.com",
            databaseURL: "https://gestion-de-traslados-default-rtdb.firebaseio.com",
            projectId: "gestion-de-traslados",
            storageBucket: "gestion-de-traslados.firebasestorage.app",
            messagingSenderId: "547255399573",
            appId: "1:547255399573:web:c636870e286428fb81979c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Hacer disponible la base de datos globalmente
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;

        console.log('Firebase inicializado correctamente');
    </script>

    <!-- Código principal de la aplicación -->
    <script>
        // Esperar a que todo esté cargado
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM completamente cargado, iniciando aplicación...');
            initializeApplication();
        });

        async function initializeApplication() {
            try {
                console.log('Inicializando aplicación...');
                
                // 1. Inicializar variables y elementos DOM
                initializeVariables();
                
                // 2. Esperar a que Firebase esté listo
                await waitForFirebase();
                console.log('Firebase listo');
                
                // 3. Configurar event listeners
                setupEventListeners();
                console.log('Event listeners configurados');
                
                // 4. Cargar datos desde Firebase
                await loadAllDataFromFirebase();
                console.log('Datos cargados desde Firebase');
                
                // 5. Configurar fecha por defecto
                if (window.transferDateInput) {
                    window.transferDateInput.value = new Date().toISOString().slice(0, 10);
                }
                
                console.log('Aplicación inicializada correctamente');
                
            } catch (error) {
                console.error('Error en la inicialización:', error);
                showMessage('Error al inicializar la aplicación: ' + error.message, 'error');
            }
        }

        // Inicializar todas las variables globales
        function initializeVariables() {
            console.log('Inicializando variables...');
            
            // Elementos del formulario
            window.transferForm = document.getElementById('transferForm');
            window.requesterNameInput = document.getElementById('requesterName');
            window.departmentInput = document.getElementById('department');
            window.originPlaceInput = document.getElementById('originPlace');
            window.returnAddressInput = document.getElementById('returnAddress');
            window.transferDateInput = document.getElementById('transferDate');
            window.costInput = document.getElementById('cost');
            window.authorizerNameInput = document.getElementById('authorizerName');
            window.companyNameInput = document.getElementById('companyName');
            window.messageBox = document.getElementById('messageBox');
            window.submitButton = document.getElementById('submitButton');
            window.cancelEditBtn = document.getElementById('cancelEditBtn');
            window.registerSection = document.getElementById('registerSection');
            
            // Elementos de tablas
            window.transferTableBody = document.getElementById('transferTableBody');
            window.paymentsTableBody = document.getElementById('paymentsTableBody');
            window.noTransfersMessage = document.getElementById('noTransfersMessage');
            window.noPaymentsMessage = document.getElementById('noPaymentsMessage');
            
            // Elementos de resumen
            window.dailyTotalSpan = document.getElementById('dailyTotal');
            window.weeklyTotalSpan = document.getElementById('weeklyTotal');
            window.monthlyTotalSpan = document.getElementById('monthlyTotal');
            window.annualTotalSpan = document.getElementById('annualTotal');
            
            // Elementos de filtros y botones
            window.filterRequesterInput = document.getElementById('filterRequester');
            window.clearFilterBtn = document.getElementById('clearFilterBtn');
            window.exportCsvBtn = document.getElementById('exportCsvBtn');
            window.importExcelBtn = document.getElementById('importExcelBtn');
            window.fileInput = document.getElementById('fileInput');
            window.deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            window.selectAllCheckboxes = document.getElementById('selectAllCheckboxes');
            
            // Elementos de gráficos
            window.chartTitleElement = document.getElementById('chartTitle');
            window.companyExpensesChartTitle = document.getElementById('companyExpensesChartTitle');
            
            // Contextos de gráficos
            const annualExpensesCanvas = document.getElementById('annualExpensesChart');
            const companyExpensesCanvas = document.getElementById('companyExpensesChart');
            const departmentExpensesCanvas = document.getElementById('departmentExpensesChart');
            
            if (annualExpensesCanvas) window.annualExpensesChartCtx = annualExpensesCanvas.getContext('2d');
            if (companyExpensesCanvas) window.companyExpensesChartCtx = companyExpensesCanvas.getContext('2d');
            if (departmentExpensesCanvas) window.departmentExpensesChartCtx = departmentExpensesCanvas.getContext('2d');
            
            // Estado de la aplicación
            window.transfers = [];
            window.editingIndex = -1;
            window.annualBudgetTarget = 12000;
            
            // Gráficos
            window.annualExpensesChart = null;
            window.companyExpensesChart = null;
            window.departmentExpensesChart = null;

            console.log('Variables inicializadas correctamente');
        }

        // Configurar todos los event listeners
        function setupEventListeners() {
            console.log('Configurando event listeners...');
            
            // Formulario principal
            if (window.transferForm) {
                window.transferForm.addEventListener('submit', handleFormSubmit);
            }
            
            // Botón cancelar edición
            if (window.cancelEditBtn) {
                window.cancelEditBtn.addEventListener('click', cancelEdit);
            }
            
            // Filtros
            if (window.filterRequesterInput) {
                window.filterRequesterInput.addEventListener('input', renderTransfers);
            }
            
            if (window.clearFilterBtn) {
                window.clearFilterBtn.addEventListener('click', () => {
                    if (window.filterRequesterInput) {
                        window.filterRequesterInput.value = '';
                        renderTransfers();
                    }
                });
            }
            
            // Botones de importación/exportación
            if (window.importExcelBtn) {
                window.importExcelBtn.addEventListener('click', () => {
                    if (window.fileInput) window.fileInput.click();
                });
            }
            
            if (window.fileInput) {
                window.fileInput.addEventListener('change', handleFileImport);
            }
            
            if (window.exportCsvBtn) {
                window.exportCsvBtn.addEventListener('click', exportToExcel);
            }
            
            // Eliminación múltiple
            if (window.selectAllCheckboxes) {
                window.selectAllCheckboxes.addEventListener('change', (e) => {
                    const isChecked = e.target.checked;
                    document.querySelectorAll('.row-checkbox').forEach(checkbox => {
                        checkbox.checked = isChecked;
                    });
                });
            }
            
            if (window.deleteSelectedBtn) {
                window.deleteSelectedBtn.addEventListener('click', deleteSelectedTransfers);
            }
            
            console.log('Event listeners configurados correctamente');
        }

        // FUNCIONES PRINCIPALES DE LA APLICACIÓN

        async function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDatabase) {
                        const connectionStatus = document.getElementById('connectionStatus');
                        if (connectionStatus) {
                            connectionStatus.classList.remove('hidden');
                        }
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        function setLoadingState(loading) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay) {
                loadingOverlay.style.display = loading ? 'flex' : 'none';
            }
        }

        async function saveToFirebase(collection, data) {
            try {
                const dbRef = window.firebaseRef(window.firebaseDatabase, collection);
                await window.firebaseSet(dbRef, data);
                return true;
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                showMessage('Error al guardar los datos: ' + error.message, "error");
                return false;
            }
        }

        async function loadFromFirebase(collection) {
            try {
                const dbRef = window.firebaseRef(window.firebaseDatabase, collection);
                const snapshot = await window.firebaseGet(dbRef);
                if (snapshot.exists()) {
                    return snapshot.val();
                } else {
                    return [];
                }
            } catch (error) {
                console.error('Error cargando desde Firebase:', error);
                showMessage('Error al cargar los datos: ' + error.message, "error");
                return [];
            }
        }

        async function loadAllDataFromFirebase() {
            try {
                setLoadingState(true);
                
                const transfersData = await loadFromFirebase('transfers');
                window.transfers = Array.isArray(transfersData) ? transfersData : [];
                
                // Convertir fechas string a objetos Date
                window.transfers = window.transfers.map(transfer => {
                    try {
                        let dateObj = new Date(transfer.dateTime);
                        dateObj.setHours(0, 0, 0, 0);
                        
                        if (isNaN(dateObj.getTime())) {
                            dateObj = new Date();
                            dateObj.setHours(0, 0, 0, 0);
                        }
                        return {
                            ...transfer,
                            dateTime: dateObj
                        };
                    } catch (error) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        return {
                            ...transfer,
                            dateTime: today
                        };
                    }
                });

                window.transfers.sort((a, b) => a.dateTime.getTime() - b.dateTime.getTime());
                renderTransfers();
                updateSummaries();
                showMessage('Datos cargados correctamente', 'success');

            } catch (error) {
                console.error('Error cargando datos:', error);
                showMessage('Error al cargar los datos: ' + error.message, "error");
            } finally {
                setLoadingState(false);
            }
        }

        async function saveTransfers() {
            try {
                const transfersToStore = window.transfers.map(t => ({
                    ...t,
                    dateTime: t.dateTime.toISOString().slice(0, 10)
                }));
                
                const success = await saveToFirebase('transfers', transfersToStore);
                return success;
            } catch (e) {
                console.error("Error al guardar datos en Firebase:", e);
                showMessage("Error al guardar datos.", "error");
                return false;
            }
        }

        function showMessage(message, type = 'info') {
            if (!window.messageBox) {
                console.log(`[${type.toUpperCase()}] ${message}`);
                return;
            }
            
            try {
                window.messageBox.textContent = message;
                window.messageBox.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
                
                if (type === 'error') {
                    window.messageBox.classList.add('bg-red-100', 'text-red-700');
                } else if (type === 'success') {
                    window.messageBox.classList.add('bg-green-100', 'text-green-700');
                } else {
                    window.messageBox.classList.add('bg-yellow-100', 'text-yellow-700');
                }
                
                window.messageBox.classList.remove('hidden');
                setTimeout(() => {
                    if (window.messageBox) {
                        window.messageBox.classList.add('hidden');
                    }
                }, 5000);
            } catch (error) {
                console.warn('Error mostrando mensaje:', error);
            }
        }

        // ... (el resto de las funciones se mantienen igual pero usando window.variable)

        // Hacer funciones globales necesarias
        window.startEditTransfer = function(index) {
            try {
                const transfer = window.transfers[index];
                if (!transfer) {
                    showMessage("Error: Traslado no encontrado.", "error");
                    return;
                }

                if (window.requesterNameInput) window.requesterNameInput.value = transfer.requesterName;
                if (window.departmentInput) window.departmentInput.value = transfer.department;
                if (window.originPlaceInput) window.originPlaceInput.value = transfer.originPlace;
                if (window.returnAddressInput) window.returnAddressInput.value = transfer.returnAddress;
                if (window.transferDateInput) window.transferDateInput.value = transfer.dateTime.toISOString().slice(0, 10);
                if (window.costInput) window.costInput.value = transfer.cost.toFixed(2);
                if (window.authorizerNameInput) window.authorizerNameInput.value = transfer.authorizerName;
                if (window.companyNameInput) window.companyNameInput.value = transfer.companyName;

                window.editingIndex = index;
                if (window.submitButton) window.submitButton.textContent = 'Guardar Cambios';
                if (window.cancelEditBtn) window.cancelEditBtn.classList.remove('hidden');

                if (window.registerSection) {
                    window.registerSection.scrollIntoView({ behavior: 'smooth' });
                }
                showMessage(`Modo Edición: Editando traslado de ${transfer.requesterName}.`, "info");
            } catch (error) {
                console.error('Error iniciando edición:', error);
                showMessage('Error al iniciar la edición', 'error');
            }
        };

        // Las demás funciones (renderTransfers, updateSummaries, etc.) se mantienen igual
        // pero usando las variables globales window.*

    </script>
</body>
</html>
