<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Traslados de Taxi - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, push, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfEP2_MYdPRCb4gKnXLEV-tUNNFkQmkOo",
            authDomain: "gestion-de-traslados.firebaseapp.com",
            databaseURL: "https://gestion-de-traslados-default-rtdb.firebaseio.com",
            projectId: "gestion-de-traslados",
            storageBucket: "gestion-de-traslados.firebasestorage.app",
            messagingSenderId: "547255399573",
            appId: "1:547255399573:web:c636870e286428fb81979c"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Hacer disponible la base de datos globalmente
        window.firebaseDatabase = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseUpdate = update;
        window.firebaseRemove = remove;
    </script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .text-inter-accent-yellow { color: #FDD000; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }
        #transferTableBody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .loading { opacity: 0.6; pointer-events: none; }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #005BAA;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 min-h-screen flex flex-col items-center">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <span class="ml-3 text-inter-primary font-semibold">Cargando datos...</span>
    </div>

    <div class="w-full max-w-5xl bg-white rounded-xl shadow-lg p-6 md:p-8 mb-8">
        <header class="text-center mb-6 bg-inter-primary rounded-t-xl py-6 relative overflow-hidden">
            <h1 class="text-4xl font-extrabold text-white mb-2 relative z-10">
                Control de Traslados de Taxi
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-md text-white mt-2 relative z-10">Registro y gestión de solicitudes de traslados de taxi</p>
            <div id="connectionStatus" class="absolute top-4 right-4 text-sm bg-green-500 px-2 py-1 rounded hidden text-white">
                Conectado a Firebase
            </div>
        </header>

        <section id="registerSection" class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Registrar Nuevo Traslado</h2>
            <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                
                <div>
                    <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">
                        Nombre del Solicitante
                    </label>
                    <input type="text" id="requesterName" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Juan Pérez">
                </div>
                <div>
                    <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                        Departamento/Área
                    </label>
                    <select id="department" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona un Departamento</option>
                        <option value="Administracion">Administración</option>
                        <option value="Area Comercial">Área Comercial</option>
                        <option value="Area tecnica">Área Técnica</option>
                        <option value="Obras">Obras</option>
                        <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                        <option value="Sistemas">Sistemas</option>
                        <option value="MSO">MSO</option>
                        <option value="Gerencia Senior">Gerencia Senior</option>
                    </select>
                </div>
                <div>
                    <label for="originPlace" class="block text-sm font-medium text-gray-700 mb-1">
                        Lugar de Origen
                    </label>
                    <input type="text" id="originPlace" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Sede Principal, Cliente X, Aeropuerto">
                </div>
                <div class="col-span-1 md:col-span-2">
                    <label for="returnAddress" class="block text-sm font-medium text-gray-700 mb-1">
                        Dirección de Vuelta (Opcional, si aplica)
                    </label>
                    <input type="text" id="returnAddress"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                           placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                </div>
                <div>
                    <label for="transferDate" class="block text-sm font-medium text-gray-700 mb-1">
                        Fecha del Traslado
                    </label>
                    <input type="date" id="transferDate" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                        Costo del Traslado (USD $)
                    </label>
                    <input type="number" id="cost" step="0.01" min="0" value="0.00" required
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                </div>
                <div>
                    <label for="authorizerName" class="block text-sm font-medium text-gray-700 mb-1">
                        Quién Autoriza
                    </label>
                    <select id="authorizerName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona Autorizador</option>
                        <option value="Jorge Basualdo">Jorge Basualdo</option>
                        <option value="Lais Troncoso">Lais Troncoso</option>
                    </select>
                </div>
                <div>
                    <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                        Empresa de Traslado
                    </label>
                    <select id="companyName" required
                            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                        <option value="" disabled selected>Selecciona Empresa</option>
                        <option value="Yummy">Yummy</option>
                        <option value="Andrew">Andrew</option>
                        <option value="Oscar">Oscar</option>
                        <option value="Neomar">Neomar</option>
                        <option value="Jose">Jose</option>
                    </select>
                </div>
                <div class="col-span-1 md:col-span-3 flex justify-end space-x-4">
                    <button type="button" id="cancelEditBtn"
                            class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Cancelar Edición
                    </button>
                    <button type="submit" id="submitButton"
                            class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        Registrar Traslado
                    </button>
                </div>
            </form>
            <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
        </section>

        <section class="mb-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Resumen de Gastos de Traslados</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-center">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                    <p id="dailyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                    <p id="weeklyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                    <p id="monthlyTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-700">Gastos Anuales</h3>
                    <p id="annualTotal" class="text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                </div>
            </div>
        </section>

        <section class="p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Historial de Traslados</h2>

            <div class="mb-4 p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-4">
                <label for="filterRequester" class="text-sm font-medium text-gray-700 whitespace-nowrap">
                    Filtrar por Solicitante:
                </label>
                <input type="text" id="filterRequester"
                       class="w-full md:w-auto flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary"
                       placeholder="Nombre del solicitante">
                <button id="clearFilterBtn"
                        class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Limpiar Filtro
                </button>
                <button id="exportCsvBtn"
                        class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Exportar a Excel (CSV)
                </button>
                <button id="importExcelBtn"
                        class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Importar de Excel
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx">
                <button id="deleteSelectedBtn"
                        class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out">
                    Eliminar Seleccionados
                </button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Solicitante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Origen</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Dirección Vuelta</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Quién Autoriza</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo ($)</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th> </tr>
                    </thead>
                    <tbody id="transferTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="noTransfersMessage" class="text-center text-gray-500 mt-4 hidden">No hay traslados registrados aún.</p>
        </section>
        
        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Análisis de Gastos Mensual y Anual</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                    <h3 id="chartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Control de Gastos Mensual por Año</h3>
                    <div class="w-full max-w-lg h-64">
                        <canvas id="annualExpensesChart"></canvas>
                    </div>
                </div>
                <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                    <h3 id="companyExpensesChartTitle" class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Anual por Empresa de Traslado</h3>
                    <div class="w-full max-w-lg h-64">
                        <canvas id="companyExpensesChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Pagos a Proveedores de Traslados</h2>
            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Mensual Total ($)</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo Unitario Promedio ($)</th>
                        </tr>
                    </thead>
                    <tbody id="paymentsTableBody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
            <p id="noPaymentsMessage" class="text-center text-gray-500 mt-4 hidden">No hay datos de pagos para este mes.</p>
        </section>

        <section class="mt-8 p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
            <h2 class="text-2xl font-bold text-inter-primary mb-4">Análisis de Gasto Mensual por Departamento</h2>
            <div class="p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                <h3 class="text-xl font-bold text-inter-primary mb-4 text-center">Gasto Total de Traslados por Departamento (Mensual)</h3>
                <div class="w-full max-w-lg h-64">
                    <canvas id="departmentExpensesChart"></canvas>
                </div>
            </div>
        </section>
    </div>

    <script>
        Chart.register(ChartDataLabels);
        const transferForm = document.getElementById('transferForm');
        const requesterNameInput = document.getElementById('requesterName');
        const departmentInput = document.getElementById('department');
        const originPlaceInput = document.getElementById('originPlace');
        const returnAddressInput = document.getElementById('returnAddress');
        const transferDateInput = document.getElementById('transferDate');
        const costInput = document.getElementById('cost');
        const authorizerNameInput = document.getElementById('authorizerName');
        const companyNameInput = document.getElementById('companyName');
        const messageBox = document.getElementById('messageBox');
        const transferTableBody = document.getElementById('transferTableBody');
        const paymentsTableBody = document.getElementById('paymentsTableBody');
        const dailyTotalSpan = document.getElementById('dailyTotal');
        const weeklyTotalSpan = document.getElementById('weeklyTotal');
        const monthlyTotalSpan = document.getElementById('monthlyTotal');
        const annualTotalSpan = document.getElementById('annualTotal');
        const noTransfersMessage = document.getElementById('noTransfersMessage');
        const noPaymentsMessage = document.getElementById('noPaymentsMessage');
        const submitButton = document.getElementById('submitButton');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const registerSection = document.getElementById('registerSection');
        const connectionStatus = document.getElementById('connectionStatus');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const annualExpensesChartCtx = document.getElementById('annualExpensesChart').getContext('2d');
        const companyExpensesChartCtx = document.getElementById('companyExpensesChart').getContext('2d');
        const departmentExpensesChartCtx = document.getElementById('departmentExpensesChart').getContext('2d');
        const chartTitleElement = document.getElementById('chartTitle');
        const companyExpensesChartTitle = document.getElementById('companyExpensesChartTitle');
        let annualExpensesChart;
        let companyExpensesChart;
        let departmentExpensesChart;

        const annualBudgetTarget = 12000;

        const filterRequesterInput = document.getElementById('filterRequester');
        const clearFilterBtn = document.getElementById('clearFilterBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const fileInput = document.getElementById('fileInput');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');

        let transfers = [];
        let editingIndex = -1;

        // FUNCIONES DE FIREBASE - CORREGIDAS

        // Función para esperar a que Firebase esté listo
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firebaseDatabase) {
                        if (connectionStatus) {
                            connectionStatus.classList.remove('hidden');
                        }
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Función para mostrar estado de carga - CORREGIDA
        function setLoadingState(loading) {
            if (!loadingOverlay) return;
            
            if (loading) {
                loadingOverlay.style.display = 'flex';
                // También deshabilitar el formulario
                const inputs = transferForm.querySelectorAll('input, select, button');
                inputs.forEach(input => {
                    input.disabled = true;
                });
            } else {
                loadingOverlay.style.display = 'none';
                // Habilitar el formulario
                const inputs = transferForm.querySelectorAll('input, select, button');
                inputs.forEach(input => {
                    input.disabled = false;
                });
            }
        }

        // Guardar datos en Firebase
        async function saveToFirebase(collection, data) {
            try {
                const dbRef = firebaseRef(firebaseDatabase, collection);
                await firebaseSet(dbRef, data);
                return true;
            } catch (error) {
                console.error('Error guardando en Firebase:', error);
                showMessage('Error al guardar los datos: ' + error.message, "error");
                return false;
            }
        }

        // Cargar datos desde Firebase
        async function loadFromFirebase(collection) {
            try {
                const dbRef = firebaseRef(firebaseDatabase, collection);
                const snapshot = await firebaseGet(dbRef);
                if (snapshot.exists()) {
                    return snapshot.val();
                } else {
                    return [];
                }
            } catch (error) {
                console.error('Error cargando desde Firebase:', error);
                showMessage('Error al cargar los datos: ' + error.message, "error");
                return [];
            }
        }

        // Cargar todos los datos desde Firebase - CORREGIDA
        async function loadAllDataFromFirebase() {
            try {
                setLoadingState(true);
                
                const transfersData = await loadFromFirebase('transfers');
                
                // Convertir datos de Firebase a formato de aplicación
                transfers = Array.isArray(transfersData) ? transfersData : [];
                
                // Convertir fechas string a objetos Date
                transfers = transfers.map(transfer => {
                    let dateObj = new Date(transfer.dateTime);
                    dateObj = normalizeDateToStartOfDay(dateObj);
                    
                    if (isNaN(dateObj.getTime())) {
                        console.warn("Invalid date found in stored data, using current date as fallback:", transfer.dateTime);
                        dateObj = normalizeDateToStartOfDay(new Date());
                    }
                    return {
                        ...transfer,
                        dateTime: dateObj
                    };
                });

                transfers.sort((a, b) => a.dateTime.getTime() - b.dateTime.getTime());
                renderTransfers();
                updateSummaries();

            } catch (error) {
                console.error('Error cargando datos:', error);
                showMessage('Error al cargar los datos: ' + error.message, "error");
            } finally {
                setLoadingState(false);
            }
        }

        // Guardar traslados en Firebase
        async function saveTransfers() {
            try {
                // Convertir fechas a string para almacenamiento
                const transfersToStore = transfers.map(t => ({
                    ...t,
                    dateTime: t.dateTime.toISOString().slice(0, 10)
                }));
                
                const success = await saveToFirebase('transfers', transfersToStore);
                return success;
            } catch (e) {
                console.error("Error al guardar datos en Firebase:", e);
                showMessage("Error al guardar datos.", "error");
                return false;
            }
        }

        // EL RESTO DEL CÓDIGO PERMANECE IGUAL...

        function showMessage(message, type = 'info', box = messageBox) {
            if (!box) return;
            
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        function normalizeDateToStartOfDay(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        function renderTransfers() {
            if (!transferTableBody) return;
            
            transferTableBody.innerHTML = '';
            if (selectAllCheckboxes) {
                selectAllCheckboxes.checked = false;
            }

            const filterText = filterRequesterInput ? filterRequesterInput.value.trim().toLowerCase() : '';
            let displayTransfers = [...transfers];
            if (filterText) {
                displayTransfers = displayTransfers.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(filterText)
                );
            }

            const requesterCounts = {};
            transfers.forEach(transfer => {
                const name = transfer.requesterName.toLowerCase();
                requesterCounts[name] = (requesterCounts[name] || 0) + 1;
            });
            let maxCount = 0;
            if (Object.keys(requesterCounts).length > 0) {
                maxCount = Math.max(...Object.values(requesterCounts));
            }

            const topRequesters = Object.keys(requesterCounts).filter(name => requesterCounts[name] === maxCount && maxCount > 0);
            const sortedTransfers = displayTransfers.sort((a, b) => b.dateTime.getTime() - a.dateTime.getTime());

            if (sortedTransfers.length === 0) {
                if (noTransfersMessage) noTransfersMessage.classList.remove('hidden');
            } else {
                if (noTransfersMessage) noTransfersMessage.classList.add('hidden');
                sortedTransfers.forEach((transfer, displayIndex) => {
                    const row = document.createElement('tr');
                    const originalIndex = transfers.indexOf(transfer);
                    if (originalIndex === -1) return;

                    const isTopRequester = topRequesters.includes(transfer.requesterName.toLowerCase());
                    const requesterClass = isTopRequester ? 'font-bold text-inter-accent-yellow' : '';

                    const formattedDate = transfer.dateTime.toLocaleDateString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-index="${originalIndex}">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 ${requesterClass}">${transfer.requesterName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.department || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.originPlace}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.returnAddress || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.authorizerName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${transfer.companyName || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium text-gray-900">$${transfer.cost.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="startEditTransfer(${originalIndex})" 
                                class="text-inter-primary hover:text-blue-700 font-bold text-xs py-1 px-2 rounded-md border border-inter-primary hover:border-blue-700 transition duration-150">
                                Editar
                            </button>
                        </td>
                    `;
                    transferTableBody.appendChild(row);
                });
            }
        }
        
        function startEditTransfer(index) {
            const transfer = transfers[index];
            if (!transfer) {
                showMessage("Error: Traslado no encontrado.", "error");
                return;
            }

            requesterNameInput.value = transfer.requesterName;
            departmentInput.value = transfer.department;
            originPlaceInput.value = transfer.originPlace;
            returnAddressInput.value = transfer.returnAddress;
            transferDateInput.value = transfer.dateTime.toISOString().slice(0, 10);
            costInput.value = transfer.cost.toFixed(2);
            authorizerNameInput.value = transfer.authorizerName;
            companyNameInput.value = transfer.companyName;

            editingIndex = index;
            submitButton.textContent = 'Guardar Cambios';
            cancelEditBtn.classList.remove('hidden');

            if (registerSection) {
                registerSection.scrollIntoView({ behavior: 'smooth' });
            }
            showMessage(`Modo Edición: Editando traslado de ${transfer.requesterName}.`, "info");
        }

        function cancelEdit() {
            editingIndex = -1;
            transferForm.reset();
            submitButton.textContent = 'Registrar Traslado';
            cancelEditBtn.classList.add('hidden');
            transferDateInput.value = new Date().toISOString().slice(0, 10);
            showMessage("Modo de registro restaurado.", "success");
        }

        if (cancelEditBtn) {
            cancelEditBtn.addEventListener('click', cancelEdit);
        }

        // MODIFICAR EL EVENTO SUBMIT PARA USAR FIREBASE
        if (transferForm) {
            transferForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                setLoadingState(true);
                
                const dateValue = new Date(transferDateInput.value); 
                const transferData = {
                    dateTime: normalizeDateToStartOfDay(dateValue), 
                    requesterName: requesterNameInput.value,
                    department: departmentInput.value,
                    originPlace: originPlaceInput.value,
                    returnAddress: returnAddressInput.value,
                    cost: parseFloat(costInput.value),
                    authorizerName: authorizerNameInput.value,
                    companyName: companyNameInput.value
                };

                if (editingIndex > -1) {
                    // Modo Edición: Actualizar el traslado existente
                    transfers[editingIndex] = transferData;
                    const success = await saveTransfers();
                    if (success) {
                        showMessage("¡Traslado actualizado con éxito!", "success");
                        cancelEdit();
                    }
                } else {
                    // Modo Registro: Añadir un nuevo traslado
                    transfers.push(transferData);
                    const success = await saveTransfers();
                    if (success) {
                        showMessage("¡Traslado registrado con éxito!", "success");
                        transferForm.reset();
                        transferDateInput.value = new Date().toISOString().slice(0, 10);
                    }
                }

                transfers.sort((a, b) => a.dateTime.getTime() - b.dateTime.getTime());
                renderTransfers();
                updateSummaries();
                setLoadingState(false);
            });
        }

        // EL RESTO DEL CÓDIGO PERMANECE IGUAL...

        // MODIFICAR FUNCIONES DE ELIMINACIÓN PARA USAR FIREBASE
        if (deleteSelectedBtn) {
            deleteSelectedBtn.addEventListener('click', async () => {
                const selectedIndices = Array.from(document.querySelectorAll('.row-checkbox:checked'))
                    .map(cb => parseInt(cb.dataset.index, 10))
                    .sort((a, b) => b - a);
                if (selectedIndices.length > 0) {
                    if (confirm(`¿Estás seguro de que quieres eliminar ${selectedIndices.length} traslados seleccionados?`)) {
                        setLoadingState(true);
                        selectedIndices.forEach(index => {
                            transfers.splice(index, 1);
                        });
                        const success = await saveTransfers();
                        if (success) {
                            renderTransfers();
                            updateSummaries();
                            showMessage("Traslados eliminados con éxito.", "success");
                        }
                        setLoadingState(false);
                    }
                } else {
                    showMessage("Por favor, selecciona al menos un traslado para eliminar.", "info");
                }
            });
        }

        // INICIALIZACIÓN MODIFICADA
        document.addEventListener('DOMContentLoaded', async () => {
            await waitForFirebase();
            await loadAllDataFromFirebase();
            renderTransfers();
            updateSummaries();
            if (transferDateInput) {
                transferDateInput.value = new Date().toISOString().slice(0, 10);
            }
        });

        // Hacer la función startEditTransfer accesible globalmente
        window.startEditTransfer = startEditTransfer;

        // Las funciones updateSummaries, updateMonthlyExpensesChart, updateCompanyExpensesChart, 
        // updateDepartmentExpensesChart, renderPaymentsTable, importCsv, y los event listeners 
        // restantes permanecen exactamente igual que en tu código original
        // Solo se han modificado las funciones relacionadas con Firebase y el manejo de estados

        function updateSummaries() {
            const now = new Date();
            const todayStart = normalizeDateToStartOfDay(now);
            const dailyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() === todayStart.getTime());
            const dailyTotal = dailyTransfers.reduce((sum, t) => sum + t.cost, 0);
            if (dailyTotalSpan) dailyTotalSpan.textContent = `$${dailyTotal.toFixed(2)}`;
            
            const dayOfWeek = (now.getDay() + 6) % 7;
            const startOfWeek = normalizeDateToStartOfDay(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            const weeklyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfWeek.getTime());
            const weeklyTotal = weeklyTransfers.reduce((sum, t) => sum + t.cost, 0);
            if (weeklyTotalSpan) weeklyTotalSpan.textContent = `$${weeklyTotal.toFixed(2)}`;

            const startOfMonth = normalizeDateToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
            const monthlyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            const monthlyTotal = monthlyTransfers.reduce((sum, t) => sum + t.cost, 0);
            if (monthlyTotalSpan) monthlyTotalSpan.textContent = `$${monthlyTotal.toFixed(2)}`;

            const startOfYear = normalizeDateToStartOfDay(new Date(now.getFullYear(), 0, 1));
            const annualTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime());
            const annualTotal = annualTransfers.reduce((sum, t) => sum + t.cost, 0);
            if (annualTotalSpan) annualTotalSpan.textContent = `$${annualTotal.toFixed(2)}`;

            updateMonthlyExpensesChart(annualTotal);
            updateCompanyExpensesChart();
            renderPaymentsTable();
            updateDepartmentExpensesChart();
        }

        // ... (el resto de las funciones de gráficos y tablas permanecen igual)

    </script>
</body>
</html>
