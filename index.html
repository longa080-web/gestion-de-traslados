<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Traslados de Taxi - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (versi√≥n CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Flatpickr para selecci√≥n de fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .text-inter-accent-yellow { color: #FDD000; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }
        #transferTableBody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-button {
            transition: all 0.3s ease;
            flex: 1;
            max-width: 200px;
            text-align: center;
        }
        .tab-button.active {
            background-color: #005BAA;
            color: white;
            font-weight: bold;
        }
        .compact-row {
            max-height: 60px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .compact-row.expanded {
            max-height: 500px;
        }
        .compact-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .compact-cell.expanded {
            max-width: none;
            white-space: normal;
            word-wrap: break-word;
        }
        .expand-btn {
            cursor: pointer;
            color: #005BAA;
            font-size: 12px;
        }
        .filter-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .filter-section.collapsed {
            max-height: 60px;
        }
        .filter-section.expanded {
            max-height: 500px;
        }
        .date-range-display {
            font-size: 0.875rem;
            color: #666;
            margin-top: 4px;
        }
        .service-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 5px;
        }
        .badge-ccs {
            background-color: #005BAA;
            color: white;
        }
        .badge-mso {
            background-color: #FDD000;
            color: #333;
        }
        @media (max-width: 768px) {
            .responsive-table {
                display: block;
            }
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
            }
            .responsive-table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table tbody td:last-child {
                border-bottom: none;
            }
            .responsive-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #005BAA;
                min-width: 120px;
            }
        }
        
        /* Estilos para el nuevo dise√±o */
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #005BAA 0%, #003366 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #003366 0%, #002244 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 59, 114, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #5CE1E6 0%, #2BB5BA 100%);
            color: #333;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-secondary:hover {
            background: linear-gradient(135deg, #2BB5BA 0%, #1A8B90 100%);
            color: white;
            transform: translateY(-1px);
        }
        
        .btn-accent {
            background: linear-gradient(135deg, #FDD000 0%, #FFB300 100%);
            color: #333;
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-accent:hover {
            background: linear-gradient(135deg, #FFB300 0%, #FF8C00 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(253, 208, 0, 0.3);
        }
        
        .form-control {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px 12px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #005BAA;
            box-shadow: 0 0 0 3px rgba(0, 91, 170, 0.1);
            outline: none;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #005BAA 0%, #5CE1E6 100%);
        }
        
        .table-header {
            background: linear-gradient(135deg, #005BAA 0%, #003366 100%);
            color: white;
        }
        
        .animated-gradient {
            background: linear-gradient(-45deg, #005BAA, #5CE1E6, #FDD000, #005BAA);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .floating-action {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-blue-50 p-2 md:p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-7xl card bg-white mb-8 overflow-hidden animated-gradient">
        <header class="text-center py-6 md:py-8 relative overflow-hidden glass-effect">
            <div class="absolute inset-0 bg-black opacity-5"></div>
            <h1 class="text-2xl md:text-4xl lg:text-5xl font-extrabold text-white mb-3 relative z-10 floating-action">
                üöñ Control de Traslados de Taxi
            </h1>
            <p class="text-base md:text-lg text-white/90 relative z-10 mb-4">Inter - Tu mundo, nuestro compromiso</p>
            <div class="relative z-10">
                <div class="inline-flex items-center bg-white/20 backdrop-blur-sm px-4 py-2 rounded-full">
                    <span class="text-white text-sm font-medium mr-2">Estado del Sistema:</span>
                    <div id="connectionStatus" class="flex items-center">
                        <span class="text-white text-sm mr-2">Conectado</span>
                        <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg"></div>
                    </div>
                </div>
            </div>
            <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2">
                <div class="w-48 h-1 bg-gradient-to-r from-transparent via-white to-transparent opacity-50"></div>
            </div>
        </header>

        <!-- Pesta√±as de navegaci√≥n con dise√±o mejorado -->
        <div class="px-4 md:px-6 lg:px-8 pt-6">
            <div class="flex justify-center mb-6">
                <div class="flex space-x-1 bg-gradient-to-r from-blue-50 to-cyan-50 p-1 rounded-xl shadow-inner">
                    <button id="tabDashboard" 
                            class="tab-button px-6 py-3 rounded-lg btn-primary font-semibold text-base transition-all duration-300 relative overflow-hidden group">
                        <span class="relative z-10">üìä Dashboard</span>
                        <div class="absolute inset-0 bg-gradient-to-r from-blue-600 to-blue-800 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
                    </button>
                    <button id="tabReports" 
                            class="tab-button px-6 py-3 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 text-base transition-all duration-300 hover:scale-105">
                        üìà Reportes Financieros
                    </button>
                </div>
            </div>

            <!-- Contenido del Dashboard (pesta√±a principal) -->
            <div id="dashboardContent" class="space-y-6">
                <!-- Tarjeta de Registro -->
                <div class="card bg-gradient-to-br from-white to-blue-50 border border-blue-100">
                    <div class="p-5 md:p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl md:text-2xl font-bold text-inter-primary flex items-center">
                                <span class="mr-3">üìù</span> Registrar Nuevo Traslado
                            </h2>
                            <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-3 py-1 rounded-full">
                                Registro en Tiempo Real
                            </span>
                        </div>
                        <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            
                            <div class="space-y-2">
                                <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üë§</span> Nombre del Solicitante
                                    </span>
                                </label>
                                <input type="text" id="requesterName" required
                                       class="form-control w-full"
                                       placeholder="Ej. Juan P√©rez">
                            </div>
                            <div class="space-y-2">
                                <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üè¢</span> Departamento/√Årea
                                    </span>
                                </label>
                                <select id="department" required
                                        class="form-control w-full">
                                    <option value="" disabled selected>Selecciona un Departamento</option>
                                    <option value="Administracion">Administraci√≥n</option>
                                    <option value="Area Comercial">√Årea Comercial</option>
                                    <option value="Area tecnica">√Årea T√©cnica</option>
                                    <option value="Obras">Obras</option>
                                    <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                                    <option value="Sistemas">Sistemas</option>
                                    <option value="Gerencia Senior">Gerencia Senior</option>
                                    <option value="Limpieza">Limpieza</option>
                                    <option value="Colaboradores">Colaboradores</option>
                                    <option value="MSO">MSO</option>
                                </select>
                                <div id="serviceTypeBadge" class="mt-1 text-xs font-semibold hidden">
                                    Tipo de servicio: 
                                    <span id="serviceTypeText" class="service-type-badge"></span>
                                </div>
                            </div>
                            <div id="msoDepartmentsContainer" class="hidden col-span-1 md:col-span-3 space-y-2">
                                <label for="msoDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üè∑Ô∏è</span> Departamento MSO (Observaciones)
                                    </span>
                                </label>
                                <select id="msoDepartment"
                                        class="form-control w-full">
                                    <option value="" disabled selected>Selecciona departamento MSO</option>
                                    <option value="Marketing">Marketing</option>
                                    <option value="Presidencia">Presidencia</option>
                                    <option value="Interconexiones">Interconexiones</option>
                                    <option value="Importaciones">Importaciones</option>
                                    <option value="RRHH MSO">RRHH MSO</option>
                                    <option value="Documentacion de obras">Documentaci√≥n de Obras</option>
                                    <option value="Limpieza">Limpieza</option>
                                    <option value="Colaboradores">Colaboradores</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-2 space-y-2">
                                <label for="originPlace" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üìç</span> Lugar de Origen - Punto de Partida
                                    </span>
                                </label>
                                <input type="text" id="originPlace" required
                                       class="form-control w-full"
                                       placeholder="Ej. Sede Principal, Cliente X, Aeropuerto">
                            </div>
                            <div class="col-span-1 md:col-span-2 space-y-2">
                                <label for="destinationPlace" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üéØ</span> Lugar de Origen - Punto de Llegada
                                    </span>
                                </label>
                                <input type="text" id="destinationPlace" required
                                       class="form-control w-full"
                                       placeholder="Ej. Oficina Central, Hotel, Terminal">
                            </div>
                            <div class="col-span-1 md:col-span-2 space-y-2">
                                <label for="returnAddress" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üîÑ</span> Direcci√≥n de Vuelta - Punto de Partida
                                    </span>
                                </label>
                                <input type="text" id="returnAddress"
                                       class="form-control w-full"
                                       placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                            </div>
                            <div class="col-span-1 md:col-span-2 space-y-2">
                                <label for="returnDestination" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üèÅ</span> Direcci√≥n de Vuelta - Destino Final
                                    </span>
                                </label>
                                <input type="text" id="returnDestination"
                                       class="form-control w-full"
                                       placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                            </div>
                            <div class="space-y-2">
                                <label for="transferDate" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üìÖ</span> Fecha del Traslado
                                    </span>
                                </label>
                                <input type="date" id="transferDate" required
                                       class="form-control w-full">
                            </div>
                            <div class="space-y-2">
                                <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üí∞</span> Costo del Traslado (USD $)
                                    </span>
                                </label>
                                <input type="number" id="cost" step="0.01" min="0" value="0.00" required
                                       class="form-control w-full">
                            </div>
                            <div class="space-y-2">
                                <label for="authorizerName" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">‚úÖ</span> Qui√©n Autoriza
                                    </span>
                                </label>
                                <select id="authorizerName" required
                                        class="form-control w-full">
                                    <option value="" disabled selected>Selecciona Autorizador</option>
                                    <option value="Jorge Basualdo">Jorge Basualdo (CCS)</option>
                                    <option value="Mario Fernandez">Mario Fernandez (MSO)</option>
                                </select>
                            </div>
                            <div class="space-y-2">
                                <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                                    <span class="flex items-center">
                                        <span class="mr-2">üöó</span> Empresa de Traslado
                                    </span>
                                </label>
                                <select id="companyName" required
                                        class="form-control w-full">
                                    <option value="" disabled selected>Selecciona Empresa</option>
                                    <option value="Yummy">Yummy</option>
                                    <option value="Andrew">Andrew</option>
                                    <option value="Oscar">Oscar</option>
                                    <option value="Neomar">Neomar</option>
                                    <option value="Jose">Jose</option>
                                </select>
                            </div>
                            <div class="col-span-1 md:col-span-3 flex justify-end space-x-3 pt-4">
                                <button type="button" id="cancelEditBtn"
                                        class="hidden bg-gradient-to-r from-gray-500 to-gray-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 hover:scale-105 text-sm md:text-base hover:shadow-lg">
                                    ‚ùå Cancelar
                                </button>
                                <button type="submit" id="submitButton"
                                        class="btn-primary font-bold py-3 px-8 rounded-lg shadow-md transition-all duration-300 hover:scale-105 text-sm md:text-base hover:shadow-lg">
                                    <span class="flex items-center justify-center">
                                        <span class="mr-2">üíæ</span> Registrar Traslado
                                    </span>
                                </button>
                            </div>
                        </form>
                        <div id="messageBox" class="mt-6 p-4 rounded-lg text-sm hidden"></div>
                    </div>
                </div>

                <!-- Estad√≠sticas R√°pidas -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-600">Hoy</h3>
                            <span class="text-blue-500">üìä</span>
                        </div>
                        <p id="dailyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary">$0.00</p>
                        <div class="mt-2 text-xs text-gray-500">Gastos diarios</div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-600">Esta Semana</h3>
                            <span class="text-cyan-500">üìÖ</span>
                        </div>
                        <p id="weeklyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary">$0.00</p>
                        <div class="mt-2 text-xs text-gray-500">Gastos semanales</div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-600">Este Mes</h3>
                            <span class="text-yellow-500">üìà</span>
                        </div>
                        <p id="monthlyTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary">$0.00</p>
                        <div class="mt-2 text-xs text-gray-500">Gastos mensuales</div>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="text-sm font-semibold text-gray-600">Este A√±o</h3>
                            <span class="text-green-500">üí∞</span>
                        </div>
                        <p id="annualTotal" class="text-2xl md:text-3xl font-extrabold text-inter-primary">$0.00</p>
                        <div class="mt-2 text-xs text-gray-500">Gastos anuales</div>
                    </div>
                </div>

                <!-- Historial con Filtros Avanzados -->
                <div class="card bg-white border border-gray-200">
                    <div class="p-5 md:p-6">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                            <div>
                                <h2 class="text-xl md:text-2xl font-bold text-inter-primary flex items-center">
                                    <span class="mr-3">üìã</span> Historial de Traslados
                                </h2>
                                <p class="text-sm text-gray-600 mt-1">Gestione y filtre todos los traslados registrados</p>
                            </div>
                            <button id="toggleFiltersBtn" class="btn-secondary font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                <span class="flex items-center">
                                    <span id="toggleFiltersText">üîç Mostrar Filtros</span>
                                    <span id="toggleFiltersIcon" class="ml-2">‚ñº</span>
                                </span>
                            </button>
                        </div>

                        <!-- Filtros Avanzados -->
                        <div id="filtersSection" class="filter-section collapsed mb-6 p-5 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                <div class="space-y-2">
                                    <label for="filterName" class="block text-sm font-medium text-gray-700">
                                        üë§ Nombre/Apellido
                                    </label>
                                    <input type="text" id="filterName"
                                           class="form-control w-full"
                                           placeholder="Buscar por nombre o apellido">
                                </div>
                                
                                <div class="space-y-2">
                                    <label for="filterDepartment" class="block text-sm font-medium text-gray-700">
                                        üè¢ Departamento
                                    </label>
                                    <select id="filterDepartment" 
                                            class="form-control w-full">
                                        <option value="">Todos los departamentos</option>
                                        <option value="Administracion">Administraci√≥n</option>
                                        <option value="Area Comercial">√Årea Comercial</option>
                                        <option value="Area tecnica">√Årea T√©cnica</option>
                                        <option value="Obras">Obras</option>
                                        <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                                        <option value="Sistemas">Sistemas</option>
                                        <option value="Gerencia Senior">Gerencia Senior</option>
                                        <option value="Limpieza">Limpieza</option>
                                        <option value="Colaboradores">Colaboradores</option>
                                        <option value="MSO">MSO</option>
                                    </select>
                                </div>
                                
                                <div class="space-y-2">
                                    <label for="filterCompany" class="block text-sm font-medium text-gray-700">
                                        üöó Empresa de Traslado
                                    </label>
                                    <select id="filterCompany" 
                                            class="form-control w-full">
                                        <option value="">Todas las empresas</option>
                                        <option value="Yummy">Yummy</option>
                                        <option value="Andrew">Andrew</option>
                                        <option value="Oscar">Oscar</option>
                                        <option value="Neomar">Neomar</option>
                                        <option value="Jose">Jose</option>
                                    </select>
                                </div>
                                
                                <div class="space-y-2">
                                    <label for="filterAuthorizer" class="block text-sm font-medium text-gray-700">
                                        ‚úÖ Qui√©n Autoriza
                                    </label>
                                    <select id="filterAuthorizer" 
                                            class="form-control w-full">
                                        <option value="">Todos los autorizadores</option>
                                        <option value="Jorge Basualdo">Jorge Basualdo (CCS)</option>
                                        <option value="Mario Fernandez">Mario Fernandez (MSO)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label for="filterDateRange" class="block text-sm font-medium text-gray-700">
                                        üìÖ Rango de Fechas
                                    </label>
                                    <input type="text" id="filterDateRange"
                                           class="form-control w-full"
                                           placeholder="Seleccionar rango de fechas">
                                    <div id="dateRangeDisplay" class="date-range-display"></div>
                                </div>
                                
                                <div class="space-y-2">
                                    <label class="block text-sm font-medium text-gray-700">
                                        üí∞ Rango de Costo ($)
                                    </label>
                                    <div class="flex space-x-3">
                                        <input type="number" id="filterMinCost" step="0.01" min="0"
                                               class="form-control w-1/2"
                                               placeholder="M√≠nimo">
                                        <input type="number" id="filterMaxCost" step="0.01" min="0"
                                               class="form-control w-1/2"
                                               placeholder="M√°ximo">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-6 flex flex-wrap gap-3">
                                <button id="applyFiltersBtn" class="btn-primary font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                    ‚úÖ Aplicar Filtros
                                </button>
                                <button id="clearAllFiltersBtn" class="bg-gradient-to-r from-gray-400 to-gray-500 text-white font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                    üóëÔ∏è Limpiar Todos los Filtros
                                </button>
                                <button id="toggleViewBtn" class="btn-accent font-bold py-2 px-5 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                    <span id="toggleViewText">üì± Vista Compacta</span>
                                </button>
                            </div>
                        </div>

                        <!-- Barra de Herramientas -->
                        <div class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                                <div class="flex items-center space-x-4">
                                    <div class="text-sm font-medium text-gray-700 bg-white px-3 py-1 rounded-full shadow-sm">
                                        üìä Resultados: <span id="resultsCount" class="font-bold text-inter-primary">0</span> traslados
                                    </div>
                                    <div class="text-xs text-gray-500 bg-white/50 px-2 py-1 rounded">
                                        <span id="selectedCount">0 seleccionados</span>
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-3">
                                    <button id="exportCsvBtn"
                                            class="btn-secondary font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                        <span class="flex items-center">
                                            üìä Exportar a Excel
                                        </span>
                                    </button>
                                    <button id="importExcelBtn"
                                            class="bg-gradient-to-r from-green-500 to-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                        <span class="flex items-center">
                                            üì• Importar
                                        </span>
                                    </button>
                                    <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx">
                                    <button id="deleteSelectedBtn"
                                            class="bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                        <span class="flex items-center">
                                            üóëÔ∏è Eliminar Seleccionados
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Tabla de Historial -->
                        <div class="rounded-xl shadow-sm overflow-hidden border border-gray-200">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 responsive-table">
                                    <thead class="table-header">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">
                                                <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-white rounded">
                                            </th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üìÖ Fecha</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üë§ Solicitante</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üè¢ Departamento</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üè∑Ô∏è Tipo Servicio</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üìç Origen</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üéØ Destino</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üöó Empresa</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">üí∞ Costo ($)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider">‚ö° Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody id="transferTableBody" class="bg-white divide-y divide-gray-200">
                                        <!-- Los datos se cargar√°n aqu√≠ -->
                                    </tbody>
                                </table>
                            </div>
                            <p id="noTransfersMessage" class="text-center text-gray-500 py-8 hidden">
                                üì≠ No hay traslados registrados a√∫n. ¬°Comienza registrando el primero!
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Gr√°ficos y Estad√≠sticas -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gastos por Empresa -->
                    <div class="card bg-white border border-gray-200">
                        <div class="p-5 md:p-6">
                            <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-4 flex items-center">
                                <span class="mr-2">üìä</span> Gastos por Empresa de Traslado
                            </h3>
                            <div class="grid grid-cols-1 gap-6">
                                <div class="p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-100">
                                    <h4 class="text-base font-bold text-inter-primary mb-3 text-center">üíº Gasto Mensual por Empresa</h4>
                                    <div class="w-full h-48 md:h-60">
                                        <canvas id="monthlyCompanyChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-4 bg-gradient-to-br from-blue-50 to-white rounded-lg border border-blue-100">
                                    <h4 class="text-base font-bold text-inter-primary mb-3 text-center">üìà Gasto Anual por Empresa</h4>
                                    <div class="w-full h-48 md:h-60">
                                        <canvas id="annualCompanyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Gastos por Departamento -->
                    <div class="card bg-white border border-gray-200">
                        <div class="p-5 md:p-6">
                            <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-4 flex items-center">
                                <span class="mr-2">üè¢</span> Gastos por Departamento
                            </h3>
                            <div class="grid grid-cols-1 gap-6">
                                <div class="p-4 bg-gradient-to-br from-cyan-50 to-white rounded-lg border border-cyan-100">
                                    <h4 class="text-base font-bold text-inter-primary mb-3 text-center">üíº Gasto Mensual por Departamento</h4>
                                    <div class="w-full h-48 md:h-60">
                                        <canvas id="monthlyDepartmentChart"></canvas>
                                    </div>
                                </div>
                                <div class="p-4 bg-gradient-to-br from-cyan-50 to-white rounded-lg border border-cyan-100">
                                    <h4 class="text-base font-bold text-inter-primary mb-3 text-center">üìà Gasto Anual por Departamento</h4>
                                    <div class="w-full h-48 md:h-60">
                                        <canvas id="annualDepartmentChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Estad√≠sticas Detalladas -->
                <div class="card bg-white border border-gray-200">
                    <div class="p-5 md:p-6">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-4 flex items-center">
                            <span class="mr-2">üìà</span> Estad√≠sticas de Traslados por Departamento
                        </h3>
                        <div class="overflow-x-auto rounded-lg border border-gray-200">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo Servicio</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">üìÖ Traslados Mensuales</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">üí∞ Gasto Mensual ($)</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">üìä Traslados Anuales</th>
                                        <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">üí∞ Gasto Anual ($)</th>
                                    </tr>
                                </thead>
                                <tbody id="departmentStatsTableBody" class="bg-white divide-y divide-gray-200">
                                </tbody>
                            </table>
                        </div>
                        <p id="noStatsMessage" class="text-center text-gray-500 mt-4 py-4 hidden">
                            üìä No hay datos de estad√≠sticas disponibles.
                        </p>
                    </div>
                </div>
            </div>

            <!-- Contenido de Reportes Financieros -->
            <div id="reportsContent" class="hidden space-y-6">
                <div class="card bg-gradient-to-br from-white to-blue-50 border border-blue-100">
                    <div class="p-5 md:p-6">
                        <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4 flex items-center">
                            <span class="mr-3">üìà</span> Reportes Financieros de Traslados
                        </h2>
                        
                        <!-- Configuraci√≥n de Reportes -->
                        <div class="mb-8 p-5 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100">
                            <h3 class="text-lg font-bold text-inter-primary mb-4">‚öôÔ∏è Configuraci√≥n del Reporte</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="space-y-2">
                                    <label for="reportPeriodType" class="block text-sm font-medium text-gray-700">
                                        üìÖ Tipo de Periodo
                                    </label>
                                    <select id="reportPeriodType" class="form-control w-full">
                                        <option value="month" selected>üìÖ Mes</option>
                                        <option value="week">üìÖ Semana</option>
                                        <option value="fortnight">üìÖ Quincena</option>
                                        <option value="custom">‚öôÔ∏è Personalizado</option>
                                    </select>
                                </div>
                                <div id="monthYearContainer" class="space-y-2">
                                    <label for="reportMonth" class="block text-sm font-medium text-gray-700">
                                        üóìÔ∏è Seleccionar Mes
                                    </label>
                                    <select id="reportMonth" class="form-control w-full">
                                        <option value="0">Enero</option>
                                        <option value="1">Febrero</option>
                                        <option value="2">Marzo</option>
                                        <option value="3">Abril</option>
                                        <option value="4">Mayo</option>
                                        <option value="5">Junio</option>
                                        <option value="6">Julio</option>
                                        <option value="7">Agosto</option>
                                        <option value="8">Septiembre</option>
                                        <option value="9">Octubre</option>
                                        <option value="10">Noviembre</option>
                                        <option value="11">Diciembre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de Semana -->
                            <div id="weekContainer" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                                <div class="space-y-2">
                                    <label for="reportWeekStart" class="block text-sm font-medium text-gray-700">
                                        üìÖ Fecha Inicio Semana
                                    </label>
                                    <input type="date" id="reportWeekStart" 
                                           class="form-control w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="reportWeekEnd" class="block text-sm font-medium text-gray-700">
                                        üìÖ Fecha Fin Semana
                                    </label>
                                    <input type="date" id="reportWeekEnd" 
                                           class="form-control w-full">
                                </div>
                                <div class="flex items-end">
                                    <button id="setCurrentWeekBtn" class="btn-secondary w-full py-2">
                                        üìÖ Semana Actual
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n de Quincena -->
                            <div id="fortnightContainer" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div class="space-y-2">
                                    <label for="reportFortnight" class="block text-sm font-medium text-gray-700">
                                        üìÖ Seleccionar Quincena
                                    </label>
                                    <select id="reportFortnight" class="form-control w-full">
                                        <option value="first">Primera Quincena (1-15)</option>
                                        <option value="second">Segunda Quincena (16-fin de mes)</option>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <label for="reportFortnightMonth" class="block text-sm font-medium text-gray-700">
                                        üóìÔ∏è Mes
                                    </label>
                                    <select id="reportFortnightMonth" class="form-control w-full">
                                        <option value="0">Enero</option>
                                        <option value="1">Febrero</option>
                                        <option value="2">Marzo</option>
                                        <option value="3">Abril</option>
                                        <option value="4">Mayo</option>
                                        <option value="5">Junio</option>
                                        <option value="6">Julio</option>
                                        <option value="7">Agosto</option>
                                        <option value="8">Septiembre</option>
                                        <option value="9">Octubre</option>
                                        <option value="10">Noviembre</option>
                                        <option value="11">Diciembre</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Configuraci√≥n Personalizada -->
                            <div id="customRangeContainer" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                                <div class="space-y-2">
                                    <label for="reportCustomStart" class="block text-sm font-medium text-gray-700">
                                        üìÖ Fecha Inicio
                                    </label>
                                    <input type="date" id="reportCustomStart" 
                                           class="form-control w-full">
                                </div>
                                <div class="space-y-2">
                                    <label for="reportCustomEnd" class="block text-sm font-medium text-gray-700">
                                        üìÖ Fecha Fin
                                    </label>
                                    <input type="date" id="reportCustomEnd" 
                                           class="form-control w-full">
                                </div>
                                <div class="flex items-end">
                                    <button id="setLast30DaysBtn" class="btn-secondary w-full py-2">
                                        üìÖ √öltimos 30 d√≠as
                                    </button>
                                </div>
                            </div>
                            
                            <!-- A√±o y Generar -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="space-y-2">
                                    <label for="reportYear" class="block text-sm font-medium text-gray-700">
                                        üìÖ Seleccionar A√±o
                                    </label>
                                    <select id="reportYear" class="form-control w-full">
                                        <option value="2024">2024</option>
                                        <option value="2025" selected>2025</option>
                                        <option value="2026">2026</option>
                                    </select>
                                </div>
                                <div class="flex items-end">
                                    <button id="generateReportBtn" class="btn-primary w-full py-3">
                                        <span class="flex items-center justify-center">
                                            <span class="mr-2">‚ö°</span> Generar Reporte
                                        </span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Periodo Seleccionado -->
                        <div id="periodDisplay" class="mb-6 p-4 bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl border border-blue-100 hidden">
                            <h3 class="text-lg font-bold text-inter-primary mb-2">üìÖ Periodo del Reporte:</h3>
                            <p id="periodText" class="text-gray-700 font-medium"></p>
                        </div>

                        <!-- Botones de Exportaci√≥n -->
                        <div class="mb-8 flex flex-wrap gap-4">
                            <button id="exportReportExcelBtn" class="btn-secondary font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                <span class="flex items-center">
                                    üìä Exportar a Excel
                                </span>
                            </button>
                            <button id="exportReportPDFBtn" class="bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-3 px-6 rounded-lg shadow-md transition-all duration-300 hover:scale-105">
                                <span class="flex items-center">
                                    üìÑ Exportar a PDF
                                </span>
                            </button>
                        </div>

                        <!-- DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-inter-primary mb-4 flex items-center">
                                <span class="mr-2">üè¢</span> DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO
                            </h3>
                            <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 40%;">DEPARTAMENTOS</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">UN CCS</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">üí∞ IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody id="departmentsReportTableBody" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                    <tfoot class="bg-gray-100">
                                        <tr>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL CCS</td>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                            <td id="totalCCS" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                            <td id="totalMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                        </tr>
                                        <tr class="bg-gradient-to-r from-cyan-100 to-cyan-200">
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL, CCS + MSO</td>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                            <td id="totalCCSMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-inter-primary mb-4 flex items-center">
                                <span class="mr-2">üöó</span> EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO
                            </h3>
                            <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">EMPRESA</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">üì¶ SERVICIOS A CCS</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">üì¶ SERVICIOS A MSO</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">üí∞ TOTAL</th>
                                        </tr>
                                    </thead>
                                    <tbody id="companiesReportTableBody" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                                    <tfoot class="bg-gradient-to-r from-cyan-100 to-cyan-200">
                                        <tr>
                                            <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTALES</td>
                                            <td id="totalCCSServices" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                            <td id="totalMSOServices" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                            <td id="totalCompanies" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- RESUMEN POR UNIDAD -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold text-inter-primary mb-4 flex items-center">
                                <span class="mr-2">üìä</span> RESUMEN POR UNIDAD
                            </h3>
                            <div class="overflow-x-auto rounded-xl shadow-sm border border-gray-200">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gradient-to-r from-blue-50 to-cyan-50">
                                        <tr>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">UNIDAD</th>
                                            <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">üí∞ IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">CCS</td>
                                            <td id="unitCCS" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">MSO</td>
                                            <td id="unitMSO" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                        </tr>
                                        <tr class="bg-gradient-to-r from-cyan-100 to-cyan-200">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">TOTAL</td>
                                            <td id="unitTotal" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">$0.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="px-4 md:px-6 lg:px-8 py-6 mt-8 border-t border-gray-200 bg-gradient-to-r from-blue-50 to-cyan-50">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <p class="text-sm text-gray-600">Sistema de Control de Traslados de Taxi - Inter</p>
                    <p class="text-xs text-gray-500">¬© 2024 - Todos los derechos reservados</p>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-xs text-gray-500">Versi√≥n 2.0</span>
                    <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
                    <span class="text-xs text-gray-500">En l√≠nea</span>
                </div>
            </div>
        </footer>
    </div>

    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCfEP2_MYdPRCb4gKnXLEV-tUNNFkQmkOo",
            authDomain: "gestion-de-traslados.firebaseapp.com",
            projectId: "gestion-de-traslados",
            storageBucket: "gestion-de-traslados.firebasestorage.app",
            messagingSenderId: "547255399573",
            appId: "1:547255399573:web:c636870e286428fb81979c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        Chart.register(ChartDataLabels);
        
        // Elementos del Dashboard
        const transferForm = document.getElementById('transferForm');
        const requesterNameInput = document.getElementById('requesterName');
        const departmentInput = document.getElementById('department');
        const serviceTypeBadge = document.getElementById('serviceTypeBadge');
        const serviceTypeText = document.getElementById('serviceTypeText');
        const msoDepartmentsContainer = document.getElementById('msoDepartmentsContainer');
        const msoDepartmentInput = document.getElementById('msoDepartment');
        const originPlaceInput = document.getElementById('originPlace');
        const destinationPlaceInput = document.getElementById('destinationPlace');
        const returnAddressInput = document.getElementById('returnAddress');
        const returnDestinationInput = document.getElementById('returnDestination');
        const transferDateInput = document.getElementById('transferDate');
        const costInput = document.getElementById('cost');
        const authorizerNameInput = document.getElementById('authorizerName');
        const companyNameInput = document.getElementById('companyName');
        const messageBox = document.getElementById('messageBox');
        const transferTableBody = document.getElementById('transferTableBody');
        const departmentStatsTableBody = document.getElementById('departmentStatsTableBody');
        const dailyTotalSpan = document.getElementById('dailyTotal');
        const weeklyTotalSpan = document.getElementById('weeklyTotal');
        const monthlyTotalSpan = document.getElementById('monthlyTotal');
        const annualTotalSpan = document.getElementById('annualTotal');
        const noTransfersMessage = document.getElementById('noTransfersMessage');
        const noStatsMessage = document.getElementById('noStatsMessage');
        const submitButton = document.getElementById('submitButton');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const registerSection = document.getElementById('registerSection');
        const connectionStatus = document.getElementById('connectionStatus');

        // Elementos de pesta√±as
        const tabDashboard = document.getElementById('tabDashboard');
        const tabReports = document.getElementById('tabReports');
        const dashboardContent = document.getElementById('dashboardContent');
        const reportsContent = document.getElementById('reportsContent');

        // Elementos de reportes
        const reportPeriodType = document.getElementById('reportPeriodType');
        const monthYearContainer = document.getElementById('monthYearContainer');
        const weekContainer = document.getElementById('weekContainer');
        const fortnightContainer = document.getElementById('fortnightContainer');
        const customRangeContainer = document.getElementById('customRangeContainer');
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearSelect = document.getElementById('reportYear');
        const reportWeekStart = document.getElementById('reportWeekStart');
        const reportWeekEnd = document.getElementById('reportWeekEnd');
        const reportFortnight = document.getElementById('reportFortnight');
        const reportFortnightMonth = document.getElementById('reportFortnightMonth');
        const reportCustomStart = document.getElementById('reportCustomStart');
        const reportCustomEnd = document.getElementById('reportCustomEnd');
        const setCurrentWeekBtn = document.getElementById('setCurrentWeekBtn');
        const setLast30DaysBtn = document.getElementById('setLast30DaysBtn');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportReportExcelBtn = document.getElementById('exportReportExcelBtn');
        const exportReportPDFBtn = document.getElementById('exportReportPDFBtn');
        const periodDisplay = document.getElementById('periodDisplay');
        const periodText = document.getElementById('periodText');
        
        const departmentsReportTableBody = document.getElementById('departmentsReportTableBody');
        const companiesReportTableBody = document.getElementById('companiesReportTableBody');
        const totalCCS = document.getElementById('totalCCS');
        const totalMSO = document.getElementById('totalMSO');
        const totalCCSMSO = document.getElementById('totalCCSMSO');
        const totalCCSServices = document.getElementById('totalCCSServices');
        const totalMSOServices = document.getElementById('totalMSOServices');
        const totalCompanies = document.getElementById('totalCompanies');
        const unitCCS = document.getElementById('unitCCS');
        const unitMSO = document.getElementById('unitMSO');
        const unitTotal = document.getElementById('unitTotal');

        // Elementos de filtros
        const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
        const toggleFiltersText = document.getElementById('toggleFiltersText');
        const toggleFiltersIcon = document.getElementById('toggleFiltersIcon');
        const filtersSection = document.getElementById('filtersSection');
        const filterName = document.getElementById('filterName');
        const filterDepartment = document.getElementById('filterDepartment');
        const filterCompany = document.getElementById('filterCompany');
        const filterAuthorizer = document.getElementById('filterAuthorizer');
        const filterDateRange = document.getElementById('filterDateRange');
        const dateRangeDisplay = document.getElementById('dateRangeDisplay');
        const filterMinCost = document.getElementById('filterMinCost');
        const filterMaxCost = document.getElementById('filterMaxCost');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const toggleViewText = document.getElementById('toggleViewText');
        const resultsCount = document.getElementById('resultsCount');
        const selectedCount = document.getElementById('selectedCount');

        // Gr√°ficos
        const monthlyCompanyChartCtx = document.getElementById('monthlyCompanyChart').getContext('2d');
        const annualCompanyChartCtx = document.getElementById('annualCompanyChart').getContext('2d');
        const monthlyDepartmentChartCtx = document.getElementById('monthlyDepartmentChart').getContext('2d');
        const annualDepartmentChartCtx = document.getElementById('annualDepartmentChart').getContext('2d');
        
        let monthlyCompanyChart;
        let annualCompanyChart;
        let monthlyDepartmentChart;
        let annualDepartmentChart;

        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const fileInput = document.getElementById('fileInput');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');

        let transfers = [];
        let editingId = null;
        let unsubscribeTransfers = null;
        let currentFilters = {
            name: '',
            department: '',
            company: '',
            authorizer: '',
            dateStart: null,
            dateEnd: null,
            minCost: null,
            maxCost: null
        };
        let isCompactView = true;
        let expandedRows = new Set();
        
        // Variables para reportes
        let currentReportPeriod = {
            type: 'month',
            startDate: null,
            endDate: null,
            month: null,
            year: null
        };

        // Lista de departamentos CCS para reportes
        const reportDepartments = [
            { name: "ADMINISTRACION", code: "Administracion", serviceType: "CCS" },
            { name: "AREA COMERCIAL", code: "Area Comercial", serviceType: "CCS" },
            { name: "AREA TECNICA", code: "Area tecnica", serviceType: "CCS" },
            { name: "DPTO DE OBRAS", code: "Obras", serviceType: "CCS" },
            { name: "RRHH y Seguridad Laboral", code: "RRHH y Seguridad Laboral", serviceType: "CCS" },
            { name: "SISTEMAS", code: "Sistemas", serviceType: "CCS" },
            { name: "G. SENIOR", code: "Gerencia Senior", serviceType: "CCS" },
            { name: "LIMPIEZA", code: "Limpieza", serviceType: "CCS" },
            { name: "COLABORADORES", code: "Colaboradores", serviceType: "CCS" }
        ];

        // Lista de empresas para reportes
        const reportCompanies = [
            { name: "YUMMY", code: "Yummy" },
            { name: "ANDREW", code: "Andrew" },
            { name: "NEOMAR", code: "Neomar" },
            { name: "OSCAR", code: "Oscar" },
            { name: "JOSE", code: "Jose" }
        ];

        // Funci√≥n para determinar si un departamento es MSO o CCS
        function getServiceType(department) {
            if (department === 'MSO') {
                return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
            } else {
                return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
            }
        }

        // Funci√≥n para determinar si un traslado con msoDepartment es MSO o CCS
        function getServiceTypeWithMSO(department, msoDepartment) {
            // Si el departamento principal es MSO, entonces es MSO
            if (department === 'MSO') {
                return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
            }
            // Si el departamento principal es Limpieza o Colaboradores
            else if (department === 'Limpieza' || department === 'Colaboradores') {
                // Si tiene msoDepartment especificado, entonces es MSO
                if (msoDepartment) {
                    return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
                } else {
                    return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
                }
            }
            // Todos los dem√°s departamentos son CCS
            else {
                return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
            }
        }

        // Funci√≥n para determinar el autorizador apropiado basado en el tipo de servicio
        function getDefaultAuthorizer(department, msoDepartment) {
            const serviceType = getServiceTypeWithMSO(department, msoDepartment);
            if (serviceType.type === 'MSO') {
                return 'Mario Fernandez';
            } else {
                return 'Jorge Basualdo';
            }
        }

        function showMessage(message, type = 'info', box = messageBox) {
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'error') {
                box.classList.add('bg-gradient-to-r', 'from-red-100', 'to-red-200', 'text-red-700', 'border', 'border-red-200');
                box.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ùå</span> ${message}</div>`;
            } else if (type === 'success') {
                box.classList.add('bg-gradient-to-r', 'from-green-100', 'to-green-200', 'text-green-700', 'border', 'border-green-200');
                box.innerHTML = `<div class="flex items-center"><span class="mr-2">‚úÖ</span> ${message}</div>`;
            } else {
                box.classList.add('bg-gradient-to-r', 'from-yellow-100', 'to-yellow-200', 'text-yellow-700', 'border', 'border-yellow-200');
                box.innerHTML = `<div class="flex items-center"><span class="mr-2">‚ÑπÔ∏è</span> ${message}</div>`;
            }
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        // Funci√≥n para normalizar fecha correctamente
        function normalizeDateToStartOfDay(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = d.getMonth();
            const day = d.getDate();
            
            const normalized = new Date(year, month, day, 0, 0, 0, 0);
            return normalized;
        }

        // Inicializar flatpickr para rango de fechas
        let dateRangePicker;
        function initDateRangePicker() {
            dateRangePicker = flatpickr(filterDateRange, {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "es",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const startDate = selectedDates[0];
                        const endDate = selectedDates[1];
                        currentFilters.dateStart = normalizeDateToStartOfDay(startDate);
                        currentFilters.dateEnd = normalizeDateToStartOfDay(endDate);
                        
                        // Mostrar el rango seleccionado
                        dateRangeDisplay.textContent = `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`;
                    } else {
                        currentFilters.dateStart = null;
                        currentFilters.dateEnd = null;
                        dateRangeDisplay.textContent = '';
                    }
                }
            });
        }

        // Manejar cambio en departamento - actualizar tipo de servicio y autorizador por defecto
        departmentInput.addEventListener('change', function() {
            const department = this.value;
            
            if (department === 'MSO') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.required = true;
                serviceTypeBadge.classList.remove('hidden');
                serviceTypeText.textContent = 'MSO';
                serviceTypeText.className = 'service-type-badge badge-mso';
                // Establecer autorizador por defecto para MSO
                authorizerNameInput.value = 'Mario Fernandez';
            } 
            else if (department === 'Limpieza' || department === 'Colaboradores') {
                // Mostrar selector MSO para Limpieza y Colaboradores
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.required = false;
                serviceTypeBadge.classList.remove('hidden');
                // Por defecto, estos departamentos son CCS hasta que se seleccione un departamento MSO
                serviceTypeText.textContent = 'CCS';
                serviceTypeText.className = 'service-type-badge badge-ccs';
                // Establecer autorizador por defecto para CCS
                authorizerNameInput.value = 'Jorge Basualdo';
            }
            else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
                msoDepartmentInput.value = '';
                
                if (department) {
                    serviceTypeBadge.classList.remove('hidden');
                    serviceTypeText.textContent = 'CCS';
                    serviceTypeText.className = 'service-type-badge badge-ccs';
                    // Establecer autorizador por defecto para CCS
                    authorizerNameInput.value = 'Jorge Basualdo';
                } else {
                    serviceTypeBadge.classList.add('hidden');
                    authorizerNameInput.value = '';
                }
            }
        });

        // Manejar cambio en departamento MSO para Limpieza/Colaboradores
        msoDepartmentInput.addEventListener('change', function() {
            const department = departmentInput.value;
            const msoDepartment = this.value;
            
            if ((department === 'Limpieza' || department === 'Colaboradores') && msoDepartment) {
                // Si se selecciona un departamento MSO para Limpieza/Colaboradores, es MSO
                serviceTypeText.textContent = 'MSO';
                serviceTypeText.className = 'service-type-badge badge-mso';
                // Cambiar autorizador a Mario Fernandez para MSO
                authorizerNameInput.value = 'Mario Fernandez';
            } else if ((department === 'Limpieza' || department === 'Colaboradores') && !msoDepartment) {
                // Si se quita el departamento MSO, vuelve a ser CCS
                serviceTypeText.textContent = 'CCS';
                serviceTypeText.className = 'service-type-badge badge-ccs';
                // Cambiar autorizador a Jorge Basualdo para CCS
                authorizerNameInput.value = 'Jorge Basualdo';
            }
        });

        // Funci√≥n para cargar traslados desde Firestore
        function loadTransfers() {
            try {
                showMessage("Conectando a la base de datos...", "info");
                
                // Usar Firestore directamente
                const transfersRef = db.collection('transfers');
                
                // Suscribirse a cambios en tiempo real
                unsubscribeTransfers = transfersRef.orderBy('dateTime', 'asc')
                    .onSnapshot((querySnapshot) => {
                        transfers = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            // Convertir correctamente la fecha desde Firestore
                            let dateTime;
                            if (data.dateTime) {
                                // Si es un objeto Timestamp de Firestore
                                if (data.dateTime.toDate) {
                                    dateTime = normalizeDateToStartOfDay(data.dateTime.toDate());
                                } 
                                // Si es un string ISO
                                else if (typeof data.dateTime === 'string') {
                                    dateTime = normalizeDateToStartOfDay(new Date(data.dateTime));
                                }
                                // Si ya es un objeto Date
                                else if (data.dateTime instanceof Date) {
                                    dateTime = normalizeDateToStartOfDay(data.dateTime);
                                }
                            }
                            
                            transfers.push({
                                id: doc.id,
                                ...data,
                                dateTime: dateTime || normalizeDateToStartOfDay(new Date())
                            });
                        });
                        
                        renderTransfers();
                        updateSummaries();
                        updateConnectionStatus(true);
                        showMessage("‚úÖ Datos cargados correctamente", "success");
                        
                        // Generar reporte del mes actual por defecto
                        generateReport();
                    }, (error) => {
                        console.error("Error en tiempo real:", error);
                        updateConnectionStatus(false);
                        showMessage("‚ùå Error de conexi√≥n con la base de datos", "error");
                    });

            } catch (e) {
                console.error("Error al cargar datos de Firestore:", e);
                showMessage("‚ùå Error al cargar datos. Verifica tu conexi√≥n a internet.", "error");
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusText = connectionStatus.querySelector('span');
            const statusDot = connectionStatus.querySelector('div');
            
            if (connected) {
                statusText.textContent = 'Conectado';
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse shadow-lg';
            } else {
                statusText.textContent = 'Desconectado';
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
        }

        // Funci√≥n para guardar un traslado en Firestore
        async function saveTransfer(transferData) {
            try {
                // Determinar tipo de servicio (CCS o MSO) considerando msoDepartment
                const serviceType = getServiceTypeWithMSO(transferData.department, transferData.msoDepartment);
                
                // Si no se especific√≥ autorizador, asignar uno por defecto seg√∫n el tipo de servicio
                if (!transferData.authorizerName || transferData.authorizerName === '') {
                    transferData.authorizerName = getDefaultAuthorizer(transferData.department, transferData.msoDepartment);
                }
                
                // Asegurarse de que la fecha se guarde correctamente
                const dataToSave = {
                    ...transferData,
                    // Guardar como Timestamp de Firestore para consistencia
                    dateTime: firebase.firestore.Timestamp.fromDate(transferData.dateTime),
                    serviceType: serviceType.type,
                    serviceTypeText: serviceType.text
                };
                
                if (editingId) {
                    // Actualizar documento existente
                    await db.collection('transfers').doc(editingId).update(dataToSave);
                    showMessage("‚úÖ ¬°Traslado actualizado con √©xito!", "success");
                } else {
                    // Crear nuevo documento
                    await db.collection('transfers').add(dataToSave);
                    showMessage("‚úÖ ¬°Traslado registrado con √©xito!", "success");
                }
                
                return true;
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
                showMessage("‚ùå Error al guardar los datos. Verifica tu conexi√≥n.", "error");
                return false;
            }
        }

        // Funci√≥n para eliminar traslados de Firestore
        async function deleteTransfers(ids) {
            try {
                const deletePromises = ids.map(id => {
                    return db.collection('transfers').doc(id).delete();
                });
                
                await Promise.all(deletePromises);
                showMessage("‚úÖ Traslados eliminados con √©xito.", "success");
                
                // Actualizar el reporte inmediatamente despu√©s de eliminar
                // Esto asegura que los reportes se actualicen en tiempo real
                generateReport();
                
                return true;
            } catch (e) {
                console.error("Error al eliminar de Firestore:", e);
                showMessage("‚ùå Error al eliminar los datos. Verifica tu conexi√≥n.", "error");
                return false;
            }
        }

        // Funci√≥n para aplicar filtros
        function applyFilters() {
            // Capturar valores de los filtros
            currentFilters.name = filterName.value.trim().toLowerCase();
            currentFilters.department = filterDepartment.value;
            currentFilters.company = filterCompany.value;
            currentFilters.authorizer = filterAuthorizer.value;
            
            // Capturar filtro de costo
            currentFilters.minCost = filterMinCost.value ? parseFloat(filterMinCost.value) : null;
            currentFilters.maxCost = filterMaxCost.value ? parseFloat(filterMaxCost.value) : null;
            
            renderTransfers();
        }

        // Funci√≥n para limpiar todos los filtros
        function clearAllFilters() {
            filterName.value = '';
            filterDepartment.value = '';
            filterCompany.value = '';
            filterAuthorizer.value = '';
            filterMinCost.value = '';
            filterMaxCost.value = '';
            filterDateRange.value = '';
            dateRangeDisplay.textContent = '';
            
            // Resetear flatpickr
            if (dateRangePicker) {
                dateRangePicker.clear();
            }
            
            // Resetear filtros actuales
            currentFilters = {
                name: '',
                department: '',
                company: '',
                authorizer: '',
                dateStart: null,
                dateEnd: null,
                minCost: null,
                maxCost: null
            };
            
            renderTransfers();
            showMessage("‚úÖ Todos los filtros han sido limpiados", "success");
        }

        // Funci√≥n para alternar vista compacta/detallada
        function toggleView() {
            isCompactView = !isCompactView;
            toggleViewText.textContent = isCompactView ? 'üì± Vista Compacta' : 'üíª Vista Detallada';
            
            // Actualizar todas las filas visibles
            document.querySelectorAll('.compact-row').forEach(row => {
                if (isCompactView) {
                    row.classList.add('compact-row');
                    row.classList.remove('expanded');
                    row.querySelectorAll('.compact-cell').forEach(cell => {
                        cell.classList.add('compact-cell');
                        cell.classList.remove('expanded');
                    });
                } else {
                    row.classList.remove('compact-row');
                    row.classList.add('expanded');
                    row.querySelectorAll('.compact-cell').forEach(cell => {
                        cell.classList.remove('compact-cell');
                        cell.classList.add('expanded');
                    });
                }
            });
            
            // Resetear filas expandidas
            if (!isCompactView) {
                expandedRows.clear();
            }
        }

        // Funci√≥n para expandir/contraer fila individual
        function toggleRowExpansion(rowId) {
            const row = document.querySelector(`tr[data-id="${rowId}"]`);
            if (!row) return;
            
            if (expandedRows.has(rowId)) {
                // Contraer
                expandedRows.delete(rowId);
                row.classList.remove('expanded');
                row.querySelectorAll('.compact-cell').forEach(cell => {
                    cell.classList.remove('expanded');
                });
            } else {
                // Expandir
                expandedRows.add(rowId);
                row.classList.add('expanded');
                row.querySelectorAll('.compact-cell').forEach(cell => {
                    cell.classList.add('expanded');
                });
            }
        }

        // Funci√≥n para actualizar contador de seleccionados
        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            selectedCount.textContent = `${checkboxes.length} seleccionados`;
        }

        function renderTransfers() {
            transferTableBody.innerHTML = '';
            selectAllCheckboxes.checked = false;
            expandedRows.clear();
            
            // Actualizar contador de seleccionados
            updateSelectedCount();

            // Aplicar filtros
            let filteredTransfers = [...transfers];
            
            // Filtrar por nombre/apellido
            if (currentFilters.name) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(currentFilters.name)
                );
            }
            
            // Filtrar por departamento
            if (currentFilters.department) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.department === currentFilters.department
                );
            }
            
            // Filtrar por empresa
            if (currentFilters.company) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.companyName === currentFilters.company
                );
            }
            
            // Filtrar por autorizador
            if (currentFilters.authorizer) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.authorizerName === currentFilters.authorizer
                );
            }
            
            // Filtrar por rango de fechas
            if (currentFilters.dateStart && currentFilters.dateEnd) {
                filteredTransfers = filteredTransfers.filter(transfer => {
                    const transferDate = transfer.dateTime;
                    return transferDate >= currentFilters.dateStart && transferDate <= currentFilters.dateEnd;
                });
            }
            
            // Filtrar por rango de costo
            if (currentFilters.minCost !== null) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.cost >= currentFilters.minCost
                );
            }
            
            if (currentFilters.maxCost !== null) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.cost <= currentFilters.maxCost
                );
            }

            // Actualizar contador de resultados
            resultsCount.textContent = filteredTransfers.length;

            // Ordenar por fecha (m√°s reciente primero)
            const sortedTransfers = filteredTransfers.sort((a, b) => b.dateTime.getTime() - a.dateTime.getTime());

            if (sortedTransfers.length === 0) {
                noTransfersMessage.classList.remove('hidden');
            } else {
                noTransfersMessage.classList.add('hidden');
                
                // Detectar si es m√≥vil
                const isMobile = window.innerWidth < 768;
                
                sortedTransfers.forEach((transfer, index) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', transfer.id);
                    
                    // Formatear fecha correctamente
                    const formattedDate = transfer.dateTime.toLocaleDateString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    // Obtener tipo de servicio considerando msoDepartment
                    const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                    
                    if (isMobile) {
                        // Vista m√≥vil: dise√±o vertical
                        row.innerHTML = `
                            <td data-label="Seleccionar">
                                <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${transfer.id}" onchange="updateSelectedCount()">
                            </td>
                            <td data-label="Fecha">${formattedDate}</td>
                            <td data-label="Solicitante">${transfer.requesterName}</td>
                            <td data-label="Departamento">${transfer.department || 'N/A'}</td>
                            <td data-label="Tipo Servicio">
                                <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span>
                            </td>
                            <td data-label="Origen">${transfer.originPlace || 'N/A'}</td>
                            <td data-label="Destino">${transfer.destinationPlace || 'N/A'}</td>
                            <td data-label="Empresa">${transfer.companyName || 'N/A'}</td>
                            <td data-label="Costo" class="text-right">$${transfer.cost.toFixed(2)}</td>
                            <td data-label="Acciones">
                                <button onclick="startEditTransfer('${transfer.id}')" 
                                    class="text-inter-primary hover:text-blue-700 font-bold text-xs py-1 px-2 rounded-md border border-inter-primary hover:border-blue-700 transition duration-150">
                                    ‚úèÔ∏è Editar
                                </button>
                                <div class="mt-2">
                                    <button onclick="toggleRowDetails('${transfer.id}')" class="expand-btn text-xs">
                                        <span id="expandIcon-${transfer.id}">‚ñº</span> M√°s info
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        // Agregar fila de detalles para m√≥vil
                        const detailsRow = document.createElement('tr');
                        detailsRow.id = `details-${transfer.id}`;
                        detailsRow.classList.add('hidden', 'bg-gray-50');
                        detailsRow.innerHTML = `
                            <td colspan="10" class="p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <strong>Departamento MSO:</strong> ${transfer.msoDepartment || 'N/A'}<br>
                                        <strong>Vuelta Partida:</strong> ${transfer.returnAddress || 'N/A'}<br>
                                        <strong>Vuelta Destino:</strong> ${transfer.returnDestination || 'N/A'}
                                    </div>
                                    <div>
                                        <strong>Autoriza:</strong> ${transfer.authorizerName || 'N/A'}<br>
                                        <strong>Tipo Servicio:</strong> 
                                        <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span><br>
                                        <strong>ID:</strong> ${transfer.id.substring(0, 8)}...
                                    </div>
                                </div>
                            </td>
                        `;
                        transferTableBody.appendChild(row);
                        transferTableBody.appendChild(detailsRow);
                    } else {
                        // Vista escritorio: dise√±o de tabla normal con filas expandibles
                        const isExpanded = expandedRows.has(transfer.id);
                        const rowClass = isCompactView && !isExpanded ? 'compact-row' : 'expanded';
                        
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${transfer.id}" onchange="updateSelectedCount()">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">${formattedDate}</td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.requesterName}
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.department || 'N/A'}
                                ${transfer.msoDepartment ? `<br><small class="text-gray-500">${transfer.msoDepartment}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span>
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.originPlace || 'N/A'}
                                ${transfer.returnAddress ? `<br><small class="text-gray-500">Vuelta: ${transfer.returnAddress}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.destinationPlace || 'N/A'}
                                ${transfer.returnDestination ? `<br><small class="text-gray-500">Destino vuelta: ${transfer.returnDestination}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">${transfer.companyName || 'N/A'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-right font-bold text-inter-primary">$${transfer.cost.toFixed(2)}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="flex flex-col space-y-2">
                                    <button onclick="startEditTransfer('${transfer.id}')" 
                                        class="btn-primary font-bold text-xs py-1 px-2 rounded-md transition duration-150">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="toggleRowExpansion('${transfer.id}')" class="expand-btn text-xs">
                                        <span id="expandIcon-${transfer.id}">${isExpanded ? '‚ñ≤' : '‚ñº'}</span> ${isExpanded ? 'Menos' : 'M√°s'}
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        if (isCompactView && !isExpanded) {
                            row.classList.add('compact-row');
                        } else {
                            row.classList.add('expanded');
                        }
                        
                        transferTableBody.appendChild(row);
                    }
                });
            }
        }

        // Funci√≥n para mostrar/ocultar detalles en m√≥vil
        function toggleRowDetails(rowId) {
            const detailsRow = document.getElementById(`details-${rowId}`);
            const expandIcon = document.getElementById(`expandIcon-${rowId}`);
            
            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                expandIcon.textContent = '‚ñ≤';
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.textContent = '‚ñº';
            }
        }
        
        function startEditTransfer(id) {
            const transfer = transfers.find(t => t.id === id);
            if (!transfer) {
                showMessage("‚ùå Error: Traslado no encontrado.", "error");
                return;
            }

            // Cargar datos en el formulario
            requesterNameInput.value = transfer.requesterName;
            departmentInput.value = transfer.department;
            
            // Determinar tipo de servicio para mostrar
            const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
            if (transfer.department) {
                serviceTypeBadge.classList.remove('hidden');
                serviceTypeText.textContent = serviceType.text;
                serviceTypeText.className = `service-type-badge ${serviceType.badgeClass}`;
            }
            
            // Manejar departamentos especiales (Limpieza, Colaboradores, MSO)
            if (transfer.department === 'MSO' || transfer.department === 'Limpieza' || transfer.department === 'Colaboradores') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.value = transfer.msoDepartment || '';
                if (transfer.department === 'MSO') {
                    msoDepartmentInput.required = true;
                } else {
                    msoDepartmentInput.required = false;
                }
            } else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
            }
            
            originPlaceInput.value = transfer.originPlace || '';
            destinationPlaceInput.value = transfer.destinationPlace || '';
            returnAddressInput.value = transfer.returnAddress || '';
            returnDestinationInput.value = transfer.returnDestination || '';
            
            // Formatear correctamente la fecha para el input type="date"
            const transferDate = transfer.dateTime;
            const year = transferDate.getFullYear();
            const month = String(transferDate.getMonth() + 1).padStart(2, '0');
            const day = String(transferDate.getDate()).padStart(2, '0');
            transferDateInput.value = `${year}-${month}-${day}`;
            
            costInput.value = transfer.cost.toFixed(2);
            authorizerNameInput.value = transfer.authorizerName;
            companyNameInput.value = transfer.companyName;

            // Establecer el modo edici√≥n
            editingId = id;
            submitButton.textContent = 'üíæ Guardar Cambios';
            cancelEditBtn.classList.remove('hidden');

            // Desplazarse al formulario
            registerSection.scrollIntoView({ behavior: 'smooth' });
            showMessage(`‚úèÔ∏è Modo Edici√≥n: Editando traslado de ${transfer.requesterName}.`, "info");
        }

        function cancelEdit() {
            editingId = null;
            transferForm.reset();
            submitButton.textContent = 'üíæ Registrar Traslado';
            cancelEditBtn.classList.add('hidden');
            msoDepartmentsContainer.classList.add('hidden');
            msoDepartmentInput.required = false;
            serviceTypeBadge.classList.add('hidden');
            
            // Establecer fecha actual
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            transferDateInput.value = `${year}-${month}-${day}`;
            
            // Restablecer autorizador por defecto seg√∫n el departamento seleccionado
            const department = departmentInput.value;
            if (department) {
                const serviceType = getServiceTypeWithMSO(department, '');
                if (serviceType.type === 'MSO') {
                    authorizerNameInput.value = 'Mario Fernandez';
                } else {
                    authorizerNameInput.value = 'Jorge Basualdo';
                }
            } else {
                authorizerNameInput.value = '';
            }
            showMessage("‚úÖ Modo de registro restaurado.", "success");
        }

        cancelEditBtn.addEventListener('click', cancelEdit);

        function updateSummaries() {
            const now = new Date();
            const todayStart = normalizeDateToStartOfDay(now);
            const dailyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() === todayStart.getTime());
            const dailyTotal = dailyTransfers.reduce((sum, t) => sum + t.cost, 0);
            dailyTotalSpan.textContent = `$${dailyTotal.toFixed(2)}`;
            
            const dayOfWeek = (now.getDay() + 6) % 7;
            const startOfWeek = normalizeDateToStartOfDay(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            const weeklyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfWeek.getTime());
            const weeklyTotal = weeklyTransfers.reduce((sum, t) => sum + t.cost, 0);
            weeklyTotalSpan.textContent = `$${weeklyTotal.toFixed(2)}`;

            const startOfMonth = normalizeDateToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
            const monthlyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            const monthlyTotal = monthlyTransfers.reduce((sum, t) => sum + t.cost, 0);
            monthlyTotalSpan.textContent = `$${monthlyTotal.toFixed(2)}`;

            const startOfYear = normalizeDateToStartOfDay(new Date(now.getFullYear(), 0, 1));
            const annualTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime());
            const annualTotal = annualTransfers.reduce((sum, t) => sum + t.cost, 0);
            annualTotalSpan.textContent = `$${annualTotal.toFixed(2)}`;

            updateCompanyCharts();
            updateDepartmentCharts();
            renderDepartmentStats();
        }

        function updateCompanyCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyCompanyExpenses = {};
            monthlyTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                monthlyCompanyExpenses[company] = (monthlyCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualCompanyExpenses = {};
            annualTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                annualCompanyExpenses[company] = (annualCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Gr√°fico mensual
            const monthlyCompanyLabels = Object.keys(monthlyCompanyExpenses);
            const monthlyCompanyData = Object.values(monthlyCompanyExpenses);
            
            if (monthlyCompanyChart) { monthlyCompanyChart.destroy(); }
            monthlyCompanyChart = new Chart(monthlyCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyCompanyLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyCompanyData,
                        backgroundColor: '#5CE1E6',
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        borderRadius: 6,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });

            // Gr√°fico anual
            const annualCompanyLabels = Object.keys(annualCompanyExpenses);
            const annualCompanyData = Object.values(annualCompanyExpenses);
            
            if (annualCompanyChart) { annualCompanyChart.destroy(); }
            annualCompanyChart = new Chart(annualCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: annualCompanyLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualCompanyData,
                        backgroundColor: '#005BAA',
                        borderColor: '#003366',
                        borderWidth: 1,
                        borderRadius: 6,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#FFFFFF',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        function updateDepartmentCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyDepartmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                monthlyDepartmentExpenses[department] = (monthlyDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualDepartmentExpenses = {};
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                annualDepartmentExpenses[department] = (annualDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Gr√°fico mensual
            const monthlyDepartmentLabels = Object.keys(monthlyDepartmentExpenses);
            const monthlyDepartmentData = Object.values(monthlyDepartmentExpenses);
            
            if (monthlyDepartmentChart) { monthlyDepartmentChart.destroy(); }
            monthlyDepartmentChart = new Chart(monthlyDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        borderRadius: 6,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Gr√°fico anual
            const annualDepartmentLabels = Object.keys(annualDepartmentExpenses);
            const annualDepartmentData = Object.values(annualDepartmentExpenses);
            
            if (annualDepartmentChart) { annualDepartmentChart.destroy(); }
            annualDepartmentChart = new Chart(annualDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: annualDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        borderRadius: 6,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderDepartmentStats() {
            departmentStatsTableBody.innerHTML = '';
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );

            const departmentStats = {};

            // Procesar datos mensuales
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        serviceType: serviceType.text,
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].monthlyCount++;
                departmentStats[department].monthlyCost += transfer.cost;
            });

            // Procesar datos anuales
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        serviceType: serviceType.text,
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].annualCount++;
                departmentStats[department].annualCost += transfer.cost;
            });

            const departments = Object.keys(departmentStats).sort();
            
            if (departments.length === 0) {
                noStatsMessage.classList.remove('hidden');
            } else {
                noStatsMessage.classList.add('hidden');
                departments.forEach(department => {
                    const stats = departmentStats[department];
                    const badgeClass = stats.serviceType === 'MSO' ? 'badge-mso' : 'badge-ccs';
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${department}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            <span class="service-type-badge ${badgeClass}">${stats.serviceType}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${stats.monthlyCount}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-inter-primary">$${stats.monthlyCost.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${stats.annualCount}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium text-inter-primary">$${stats.annualCost.toFixed(2)}</td>
                    `;
                    departmentStatsTableBody.appendChild(row);
                });
            }
        }

        // Funci√≥n para obtener las fechas seg√∫n el tipo de periodo seleccionado
        function getReportDates() {
            const periodType = reportPeriodType.value;
            const year = parseInt(reportYearSelect.value);
            
            let startDate, endDate;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    startDate = new Date(year, month, 1);
                    endDate = new Date(year, month + 1, 0);
                    break;
                    
                case 'week':
                    // Obtener valores de fecha del formulario
                    const weekStartStr = reportWeekStart.value;
                    const weekEndStr = reportWeekEnd.value;
                    
                    if (!weekStartStr || !weekEndStr) {
                        // Si no hay fechas seleccionadas, usar la semana actual
                        setCurrentWeek();
                        startDate = new Date(reportWeekStart.value);
                        endDate = new Date(reportWeekEnd.value);
                    } else {
                        startDate = new Date(weekStartStr);
                        endDate = new Date(weekEndStr);
                    }
                    break;
                    
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    
                    if (fortnight === 'first') {
                        startDate = new Date(year, fortnightMonth, 1);
                        endDate = new Date(year, fortnightMonth, 15);
                    } else {
                        startDate = new Date(year, fortnightMonth, 16);
                        endDate = new Date(year, fortnightMonth + 1, 0);
                    }
                    break;
                    
                case 'custom':
                    // Obtener valores de fecha del formulario
                    const customStartStr = reportCustomStart.value;
                    const customEndStr = reportCustomEnd.value;
                    
                    if (!customStartStr || !customEndStr) {
                        // Si no hay fechas seleccionadas, usar √∫ltimos 30 d√≠as
                        setLast30Days();
                        startDate = new Date(reportCustomStart.value);
                        endDate = new Date(reportCustomEnd.value);
                    } else {
                        startDate = new Date(customStartStr);
                        endDate = new Date(customEndStr);
                    }
                    break;
            }
            
            // Asegurarse de que las fechas sean v√°lidas
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                // Si las fechas no son v√°lidas, usar el mes actual como respaldo
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            }
            
            // Normalizar fechas (inicio a las 00:00, fin a las 23:59:59)
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            return { startDate, endDate };
        }

        // Funci√≥n para actualizar el texto del periodo
        function updatePeriodText() {
            const { startDate, endDate } = getReportDates();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let periodTextStr = '';
            
            switch(reportPeriodType.value) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    periodTextStr = `${monthNames[month]} ${reportYearSelect.value}`;
                    break;
                    
                case 'week':
                    // Usar el formato dd/mm/yyyy para fechas
                    const formatDate = (date) => {
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    };
                    periodTextStr = `Semana del ${formatDate(startDate)} al ${formatDate(endDate)}`;
                    break;
                    
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const monthName = monthNames[fortnightMonth];
                    const endDay = endDate.getDate();
                    if (fortnight === 'first') {
                        periodTextStr = `Primera quincena de ${monthName} ${reportYearSelect.value} (1-15)`;
                    } else {
                        periodTextStr = `Segunda quincena de ${monthName} ${reportYearSelect.value} (16-${endDay})`;
                    }
                    break;
                    
                case 'custom':
                    // Usar el formato dd/mm/yyyy para fechas personalizadas
                    const formatDateCustom = (date) => {
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    };
                    periodTextStr = `Personalizado: ${formatDateCustom(startDate)} - ${formatDateCustom(endDate)}`;
                    break;
            }
            
            periodText.textContent = periodTextStr;
            periodDisplay.classList.remove('hidden');
            
            // Actualizar objeto currentReportPeriod
            currentReportPeriod = {
                type: reportPeriodType.value,
                startDate: normalizeDateToStartOfDay(startDate),
                endDate: normalizeDateToStartOfDay(endDate),
                month: reportPeriodType.value === 'month' ? parseInt(reportMonthSelect.value) : null,
                year: parseInt(reportYearSelect.value)
            };
        }

        // Funci√≥n para manejar cambio de tipo de periodo
        function handlePeriodTypeChange() {
            const periodType = reportPeriodType.value;
            
            // Ocultar todos los contenedores
            monthYearContainer.classList.add('hidden');
            weekContainer.classList.add('hidden');
            fortnightContainer.classList.add('hidden');
            customRangeContainer.classList.add('hidden');
            
            // Mostrar el contenedor correspondiente
            switch(periodType) {
                case 'month':
                    monthYearContainer.classList.remove('hidden');
                    break;
                case 'week':
                    weekContainer.classList.remove('hidden');
                    // Establecer semana actual por defecto si no hay fechas
                    if (!reportWeekStart.value || !reportWeekEnd.value) {
                        setCurrentWeek();
                    }
                    break;
                case 'fortnight':
                    fortnightContainer.classList.remove('hidden');
                    // Establecer mes actual por defecto
                    const currentMonth = new Date().getMonth();
                    reportFortnightMonth.value = currentMonth.toString();
                    break;
                case 'custom':
                    customRangeContainer.classList.remove('hidden');
                    // Establecer √∫ltimos 30 d√≠as por defecto si no hay fechas
                    if (!reportCustomStart.value || !reportCustomEnd.value) {
                        setLast30Days();
                    }
                    break;
            }
            
            // Actualizar inmediatamente el texto del periodo
            updatePeriodText();
        }

        // Funci√≥n para establecer semana actual
        function setCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            // Ajustar para que la semana empiece el Lunes
            const startOfWeek = new Date(today);
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Si es domingo, retroceder 6 d√≠as
            startOfWeek.setDate(today.getDate() + diff);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // Formatear fechas como YYYY-MM-DD para el input type="date"
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            reportWeekStart.value = formatDateForInput(startOfWeek);
            reportWeekEnd.value = formatDateForInput(endOfWeek);
            
            // Actualizar el texto del periodo inmediatamente
            updatePeriodText();
        }

        // Funci√≥n para establecer √∫ltimos 30 d√≠as
        function setLast30Days() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            // Formatear fechas como YYYY-MM-DD para el input type="date"
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            reportCustomStart.value = formatDateForInput(thirtyDaysAgo);
            reportCustomEnd.value = formatDateForInput(today);
            
            // Actualizar el texto del periodo inmediatamente
            updatePeriodText();
        }

        // Funci√≥n para generar reporte financiero
        function generateReport() {
            // Obtener fechas del formulario
            const { startDate, endDate } = getReportDates();
            
            // Actualizar texto del periodo (esto mostrar√° las fechas exactas)
            updatePeriodText();
            
            // Filtrar traslados por periodo seleccionado
            const filteredTransfers = transfers.filter(transfer => {
                const transferDate = transfer.dateTime;
                // Asegurarse de que las fechas se comparen correctamente
                const transferDateObj = new Date(transferDate);
                transferDateObj.setHours(0, 0, 0, 0);
                
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                
                const endDateObj = new Date(endDate);
                endDateObj.setHours(23, 59, 59, 999);
                
                return transferDateObj >= startDateObj && transferDateObj <= endDateObj;
            });
            
            // MODIFICADO: Calcular totales por departamento con detalle de MSO
            const departmentTotals = {};
            let totalCCSAmount = 0;
            let totalMSOAmount = 0;
            
            filteredTransfers.forEach(transfer => {
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (serviceType.type === 'MSO') {
                    // Usar el departamento MSO espec√≠fico si existe
                    const deptKey = msoDepartment ? `MSO - ${msoDepartment}` : 'MSO - Sin especificar';
                    
                    if (!departmentTotals[deptKey]) {
                        departmentTotals[deptKey] = {
                            name: deptKey,
                            type: 'MSO',
                            amount: 0
                        };
                    }
                    departmentTotals[deptKey].amount += cost;
                    totalMSOAmount += cost;
                } else {
                    // Es CCS - usar el departamento original
                    if (department) {
                        if (!departmentTotals[department]) {
                            departmentTotals[department] = {
                                name: department.toUpperCase(),
                                type: 'CCS',
                                amount: 0
                            };
                        }
                        departmentTotals[department].amount += cost;
                        totalCCSAmount += cost;
                    }
                }
            });
            
            // MODIFICADO: Actualizar tabla de departamentos con detalle de MSO
            departmentsReportTableBody.innerHTML = '';
            
            // Ordenar departamentos: primero CCS, luego MSO
            const sortedDepartments = Object.keys(departmentTotals).sort((a, b) => {
                if (departmentTotals[a].type === departmentTotals[b].type) {
                    return a.localeCompare(b);
                }
                return departmentTotals[a].type === 'CCS' ? -1 : 1;
            });
            
            sortedDepartments.forEach(deptKey => {
                const dept = departmentTotals[deptKey];
                const row = document.createElement('tr');
                const isMSO = dept.type === 'MSO';
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${dept.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${isMSO ? 'MSO' : 'UN CCS'}</td>
                    <td class="px-6 py-3 text-left text-sm font-medium text-inter-primary">$${dept.amount.toFixed(2)}</td>
                `;
                departmentsReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de departamentos
            totalCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            totalMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            const totalCCSMSOTotal = totalCCSAmount + totalMSOAmount;
            totalCCSMSO.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
            
            // Calcular totales por empresa - DISCRIMINADO POR CCS Y MSO
            const companyStats = {};
            let totalCCSServicesCount = 0;
            let totalCCSAmountServices = 0;
            let totalMSOServicesCount = 0;
            let totalMSOAmountServices = 0;
            
            // Inicializar estructura para cada empresa
            reportCompanies.forEach(company => {
                companyStats[company.code] = {
                    name: company.name,
                    ccsCount: 0,
                    ccsAmount: 0,
                    msoCount: 0,
                    msoAmount: 0,
                    totalCount: 0,
                    totalAmount: 0
                };
            });
            
            // Procesar cada traslado
            filteredTransfers.forEach(transfer => {
                const company = transfer.companyName;
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (company && companyStats.hasOwnProperty(company)) {
                    // Determinar si es CCS o MSO
                    if (serviceType.type === 'MSO') {
                        companyStats[company].msoCount++;
                        companyStats[company].msoAmount += cost;
                        totalMSOServicesCount++;
                        totalMSOAmountServices += cost;
                    } else {
                        companyStats[company].ccsCount++;
                        companyStats[company].ccsAmount += cost;
                        totalCCSServicesCount++;
                        totalCCSAmountServices += cost;
                    }
                    
                    // Actualizar totales
                    companyStats[company].totalCount++;
                    companyStats[company].totalAmount += cost;
                }
            });
            
            // Actualizar tabla de empresas
            companiesReportTableBody.innerHTML = '';
            
            reportCompanies.forEach((company, index) => {
                const stats = companyStats[company.code];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm font-medium text-gray-900">${company.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">
                        ${stats.ccsCount} servicio${stats.ccsCount !== 1 ? 's' : ''}<br>
                        <span class="font-medium text-inter-primary">$${stats.ccsAmount.toFixed(2)}</span>
                    </td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">
                        ${stats.msoCount} servicio${stats.msoCount !== 1 ? 's' : ''}<br>
                        <span class="font-medium text-inter-primary">$${stats.msoAmount.toFixed(2)}</span>
                    </td>
                    <td class="px-6 py-3 text-left text-sm font-medium text-gray-900">
                        ${stats.totalCount} servicio${stats.totalCount !== 1 ? 's' : ''}<br>
                        <span class="font-bold text-inter-primary">$${stats.totalAmount.toFixed(2)}</span>
                    </td>
                `;
                companiesReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de empresas
            totalCCSServices.textContent = `${totalCCSServicesCount} servicio${totalCCSServicesCount !== 1 ? 's' : ''} - $${totalCCSAmountServices.toFixed(2)}`;
            totalMSOServices.textContent = `${totalMSOServicesCount} servicio${totalMSOServicesCount !== 1 ? 's' : ''} - $${totalMSOAmountServices.toFixed(2)}`;
            const totalServicesCount = totalCCSServicesCount + totalMSOServicesCount;
            const totalServicesAmount = totalCCSAmountServices + totalMSOAmountServices;
            totalCompanies.textContent = `${totalServicesCount} servicio${totalServicesCount !== 1 ? 's' : ''} - $${totalServicesAmount.toFixed(2)}`;
            
            // Actualizar resumen por unidad
            unitCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            unitMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            unitTotal.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
            
            showMessage(`‚úÖ Reporte generado para el periodo: ${periodText.textContent}`, "success");
        }

        // Funci√≥n para exportar reporte a Excel
        function exportReportToExcel() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Obtener fechas del formulario (igual que en generateReport)
            const { startDate, endDate } = getReportDates();
            
            // Filtrar traslados por periodo seleccionado (igual que en generateReport)
            const filteredTransfers = transfers.filter(transfer => {
                const transferDate = transfer.dateTime;
                const transferDateObj = new Date(transferDate);
                transferDateObj.setHours(0, 0, 0, 0);
                
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                
                const endDateObj = new Date(endDate);
                endDateObj.setHours(23, 59, 59, 999);
                
                return transferDateObj >= startDateObj && transferDateObj <= endDateObj;
            });
            
            // MODIFICADO: Calcular departmentTotals con detalle de MSO
            const departmentTotals = {};
            let totalCCSAmount = 0;
            let totalMSOAmount = 0;
            
            filteredTransfers.forEach(transfer => {
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (serviceType.type === 'MSO') {
                    // Usar el departamento MSO espec√≠fico si existe
                    const deptKey = msoDepartment ? `MSO - ${msoDepartment}` : 'MSO - Sin especificar';
                    
                    if (!departmentTotals[deptKey]) {
                        departmentTotals[deptKey] = {
                            name: deptKey,
                            type: 'MSO',
                            amount: 0
                        };
                    }
                    departmentTotals[deptKey].amount += cost;
                    totalMSOAmount += cost;
                } else {
                    // Es CCS - usar el departamento original
                    if (department) {
                        if (!departmentTotals[department]) {
                            departmentTotals[department] = {
                                name: department.toUpperCase(),
                                type: 'CCS',
                                amount: 0
                            };
                        }
                        departmentTotals[department].amount += cost;
                        totalCCSAmount += cost;
                    }
                }
            });
            
            // Crear workbook
            const workbook = XLSX.utils.book_new();
            
            // MODIFICADO: Hoja 1: Departamentos con detalle de MSO
            const departmentsData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO'],
                ['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']
            ];
            
            // Ordenar departamentos: primero CCS, luego MSO
            const sortedDepartments = Object.keys(departmentTotals).sort((a, b) => {
                if (departmentTotals[a].type === departmentTotals[b].type) {
                    return a.localeCompare(b);
                }
                return departmentTotals[a].type === 'CCS' ? -1 : 1;
            });
            
            // Agregar filas de departamentos
            sortedDepartments.forEach(deptKey => {
                const dept = departmentTotals[deptKey];
                const isMSO = dept.type === 'MSO';
                departmentsData.push([dept.name, isMSO ? 'MSO' : 'UN CCS', dept.amount]);
            });
            
            // Agregar totales
            departmentsData.push(['TOTAL CCS', '', totalCCSAmount]);
            departmentsData.push(['MSO', 'MSO', totalMSOAmount]);
            departmentsData.push(['TOTAL, CCS + MSO', '', totalCCSAmount + totalMSOAmount]);
            
            const departmentsSheet = XLSX.utils.aoa_to_sheet(departmentsData);
            XLSX.utils.book_append_sheet(workbook, departmentsSheet, 'Departamentos');
            
            // Hoja 2: Empresas - con formato separado
            const companiesData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO'],
                ['EMPRESA', 'SERVICIOS A CCS', 'SERVICIOS A MSO', 'TOTAL']
            ];
            
            // Calcular companyStats (igual que en generateReport)
            const companyStats = {};
            let totalCCSServicesCount = 0;
            let totalCCSAmountServices = 0;
            let totalMSOServicesCount = 0;
            let totalMSOAmountServices = 0;
            
            reportCompanies.forEach(company => {
                companyStats[company.code] = {
                    name: company.name,
                    ccsCount: 0,
                    ccsAmount: 0,
                    msoCount: 0,
                    msoAmount: 0,
                    totalCount: 0,
                    totalAmount: 0
                };
            });
            
            filteredTransfers.forEach(transfer => {
                const company = transfer.companyName;
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (company && companyStats.hasOwnProperty(company)) {
                    if (serviceType.type === 'MSO') {
                        companyStats[company].msoCount++;
                        companyStats[company].msoAmount += cost;
                        totalMSOServicesCount++;
                        totalMSOAmountServices += cost;
                    } else {
                        companyStats[company].ccsCount++;
                        companyStats[company].ccsAmount += cost;
                        totalCCSServicesCount++;
                        totalCCSAmountServices += cost;
                    }
                    
                    companyStats[company].totalCount++;
                    companyStats[company].totalAmount += cost;
                }
            });
            
            // Agregar filas de empresas con formato mejorado
            reportCompanies.forEach((company) => {
                const stats = companyStats[company.code];
                
                companiesData.push([
                    company.name,
                    `${stats.ccsCount} servicio${stats.ccsCount !== 1 ? 's' : ''}\n$${stats.ccsAmount.toFixed(2)}`,
                    `${stats.msoCount} servicio${stats.msoCount !== 1 ? 's' : ''}\n$${stats.msoAmount.toFixed(2)}`,
                    `${stats.totalCount} servicio${stats.totalCount !== 1 ? 's' : ''}\n$${stats.totalAmount.toFixed(2)}`
                ]);
            });
            
            // Agregar totales con formato
            const totalCCSServicesText = `${totalCCSServicesCount} servicios - $${totalCCSAmountServices.toFixed(2)}`;
            const totalMSOServicesText = `${totalMSOServicesCount} servicios - $${totalMSOAmountServices.toFixed(2)}`;
            const totalServicesCount = totalCCSServicesCount + totalMSOServicesCount;
            const totalServicesAmount = totalCCSAmountServices + totalMSOAmountServices;
            const totalCompaniesText = `${totalServicesCount} servicios - $${totalServicesAmount.toFixed(2)}`;
            
            companiesData.push([
                'TOTALES', 
                totalCCSServicesText.replace(' - ', '\n'),
                totalMSOServicesText.replace(' - ', '\n'),
                totalCompaniesText.replace(' - ', '\n')
            ]);
            
            const companiesSheet = XLSX.utils.aoa_to_sheet(companiesData);
            
            // Ajustar ancho de columnas
            const wscols = [
                {wch: 20}, // Empresa
                {wch: 25}, // Servicios CCS
                {wch: 25}, // Servicios MSO
                {wch: 25}  // Total
            ];
            companiesSheet['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(workbook, companiesSheet, 'Empresas');
            
            // Hoja 3: Resumen por unidad
            const unitData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['RESUMEN POR UNIDAD'],
                ['UNIDAD', 'IMPORTE'],
                ['CCS', totalCCSAmount],
                ['MSO', totalMSOAmount],
                ['TOTAL', totalCCSAmount + totalMSOAmount]
            ];
            
            const unitSheet = XLSX.utils.aoa_to_sheet(unitData);
            XLSX.utils.book_append_sheet(workbook, unitSheet, 'Resumen Unidad');
            
            // Generar nombre de archivo seg√∫n el tipo de periodo
            let fileName = '';
            const periodType = reportPeriodType.value;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    fileName = `Reporte_Mensual_${monthNames[month]}_${reportYearSelect.value}.xlsx`;
                    break;
                case 'week':
                    const weekStart = new Date(reportWeekStart.value).toISOString().slice(0,10);
                    const weekEnd = new Date(reportWeekEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Semanal_${weekStart}_a_${weekEnd}.xlsx`;
                    break;
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const fortnightText = fortnight === 'first' ? 'PrimeraQuincena' : 'SegundaQuincena';
                    fileName = `Reporte_Quincena_${fortnightText}_${monthNames[fortnightMonth]}_${reportYearSelect.value}.xlsx`;
                    break;
                case 'custom':
                    const customStart = new Date(reportCustomStart.value).toISOString().slice(0,10);
                    const customEnd = new Date(reportCustomEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Personalizado_${customStart}_a_${customEnd}.xlsx`;
                    break;
            }
            
            // Descargar archivo
            XLSX.writeFile(workbook, fileName);
            
            showMessage(`‚úÖ Reporte exportado a Excel: ${fileName}`, "success");
        }

        // Funci√≥n para exportar reporte a PDF con formato mejorado
        function exportReportToPDF() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Obtener fechas del formulario (igual que en generateReport)
            const { startDate, endDate } = getReportDates();
            
            // Filtrar traslados por periodo seleccionado (igual que en generateReport)
            const filteredTransfers = transfers.filter(transfer => {
                const transferDate = transfer.dateTime;
                const transferDateObj = new Date(transferDate);
                transferDateObj.setHours(0, 0, 0, 0);
                
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                
                const endDateObj = new Date(endDate);
                endDateObj.setHours(23, 59, 59, 999);
                
                return transferDateObj >= startDateObj && transferDateObj <= endDateObj;
            });
            
            // MODIFICADO: Calcular departmentTotals con detalle de MSO
            const departmentTotals = {};
            let totalCCSAmount = 0;
            let totalMSOAmount = 0;
            
            filteredTransfers.forEach(transfer => {
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (serviceType.type === 'MSO') {
                    // Usar el departamento MSO espec√≠fico si existe
                    const deptKey = msoDepartment ? `MSO - ${msoDepartment}` : 'MSO - Sin especificar';
                    
                    if (!departmentTotals[deptKey]) {
                        departmentTotals[deptKey] = {
                            name: deptKey,
                            type: 'MSO',
                            amount: 0
                        };
                    }
                    departmentTotals[deptKey].amount += cost;
                    totalMSOAmount += cost;
                } else {
                    // Es CCS - usar el departamento original
                    if (department) {
                        if (!departmentTotals[department]) {
                            departmentTotals[department] = {
                                name: department.toUpperCase(),
                                type: 'CCS',
                                amount: 0
                            };
                        }
                        departmentTotals[department].amount += cost;
                        totalCCSAmount += cost;
                    }
                }
            });
            
            // Crear nuevo documento PDF
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // T√≠tulo principal
            doc.setFontSize(16);
            doc.setTextColor(0, 91, 170);
            doc.text('REPORTE FINANCIERO DE TRASLADOS', 105, 20, null, null, 'center');
            
            // Periodo
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('PERIODO: ' + periodText.textContent, 105, 30, null, null, 'center');
            
            let yPos = 40;
            
            // MODIFICADO: Secci√≥n 1: Departamentos que utilizan servicio de traslado con detalle MSO
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Ordenar departamentos: primero CCS, luego MSO
            const sortedDepartments = Object.keys(departmentTotals).sort((a, b) => {
                if (departmentTotals[a].type === departmentTotals[b].type) {
                    return a.localeCompare(b);
                }
                return departmentTotals[a].type === 'CCS' ? -1 : 1;
            });
            
            // Tabla de departamentos
            const departmentsData = [];
            sortedDepartments.forEach(deptKey => {
                const dept = departmentTotals[deptKey];
                const isMSO = dept.type === 'MSO';
                departmentsData.push([
                    dept.name,
                    isMSO ? 'MSO' : 'UN CCS',
                    `$${dept.amount.toFixed(2)}`
                ]);
            });
            
            // Agregar totales a la tabla
            departmentsData.push([
                'TOTAL CCS',
                '',
                `$${totalCCSAmount.toFixed(2)}`
            ]);
            departmentsData.push([
                'MSO',
                'MSO',
                `$${totalMSOAmount.toFixed(2)}`
            ]);
            departmentsData.push([
                'TOTAL, CCS + MSO',
                '',
                `$${(totalCCSAmount + totalMSOAmount).toFixed(2)}`
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']],
                body: departmentsData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 91, 170], 
                    textColor: [255, 255, 255],
                    fontSize: 10
                },
                bodyStyles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 40 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('P√°gina ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Secci√≥n 2: Empresas proveedoras - con formato de dos l√≠neas
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Calcular companyStats (igual que en generateReport)
            const companyStats = {};
            let totalCCSServicesCount = 0;
            let totalCCSAmountServices = 0;
            let totalMSOServicesCount = 0;
            let totalMSOAmountServices = 0;
            
            reportCompanies.forEach(company => {
                companyStats[company.code] = {
                    name: company.name,
                    ccsCount: 0,
                    ccsAmount: 0,
                    msoCount: 0,
                    msoAmount: 0,
                    totalCount: 0,
                    totalAmount: 0
                };
            });
            
            filteredTransfers.forEach(transfer => {
                const company = transfer.companyName;
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (company && companyStats.hasOwnProperty(company)) {
                    if (serviceType.type === 'MSO') {
                        companyStats[company].msoCount++;
                        companyStats[company].msoAmount += cost;
                        totalMSOServicesCount++;
                        totalMSOAmountServices += cost;
                    } else {
                        companyStats[company].ccsCount++;
                        companyStats[company].ccsAmount += cost;
                        totalCCSServicesCount++;
                        totalCCSAmountServices += cost;
                    }
                    
                    companyStats[company].totalCount++;
                    companyStats[company].totalAmount += cost;
                }
            });
            
            // Tabla de empresas con formato de dos l√≠neas
            const companiesData = [];
            
            // Procesar cada empresa
            reportCompanies.forEach((company) => {
                const stats = companyStats[company.code];
                
                companiesData.push([
                    company.name,
                    `${stats.ccsCount} servicio${stats.ccsCount !== 1 ? 's' : ''}\n$${stats.ccsAmount.toFixed(2)}`,
                    `${stats.msoCount} servicio${stats.msoCount !== 1 ? 's' : ''}\n$${stats.msoAmount.toFixed(2)}`,
                    `${stats.totalCount} servicio${stats.totalCount !== 1 ? 's' : ''}\n$${stats.totalAmount.toFixed(2)}`
                ]);
            });
            
            // Agregar totales con formato de dos l√≠neas
            const totalCCSServicesText = `${totalCCSServicesCount} servicios - $${totalCCSAmountServices.toFixed(2)}`;
            const totalMSOServicesText = `${totalMSOServicesCount} servicios - $${totalMSOAmountServices.toFixed(2)}`;
            const totalServicesCount = totalCCSServicesCount + totalMSOServicesCount;
            const totalServicesAmount = totalCCSAmountServices + totalMSOAmountServices;
            const totalCompaniesText = `${totalServicesCount} servicios - $${totalServicesAmount.toFixed(2)}`;
            
            companiesData.push([
                'TOTALES',
                totalCCSServicesText.replace(' - ', '\n'),
                totalMSOServicesText.replace(' - ', '\n'),
                totalCompaniesText.replace(' - ', '\n')
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['EMPRESA', 'SERVICIOS A CCS', 'SERVICIOS A MSO', 'TOTAL']],
                body: companiesData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [92, 225, 230], 
                    textColor: [0, 0, 0],
                    fontSize: 9
                },
                bodyStyles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    lineHeight: 1.2
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 35 }
                },
                styles: {
                    overflow: 'linebreak',
                    cellPadding: 2,
                    lineWidth: 0.1,
                    lineColor: [200, 200, 200]
                },
                didDrawCell: function(data) {
                    // Centrar verticalmente el contenido de dos l√≠neas
                    if (data.column.index > 0 && data.cell.section === 'body') {
                        const lines = data.cell.text[0].split('\n');
                        if (lines.length > 1) {
                            doc.setFontSize(7);
                            const textHeight = 7;
                            const cellHeight = data.cell.height;
                            const totalTextHeight = lines.length * textHeight;
                            const startY = data.cell.y + (cellHeight - totalTextHeight) / 2 + textHeight;
                            
                            lines.forEach((line, i) => {
                                doc.text(line.trim(), data.cell.x + 2, startY + (i * textHeight));
                            });
                            
                            return false; // Evitar que autoTable dibuje el texto por defecto
                        }
                    }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('P√°gina ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Secci√≥n 3: Resumen por unidad
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('RESUMEN POR UNIDAD', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de resumen por unidad
            const unitData = [
                ['CCS', `$${totalCCSAmount.toFixed(2)}`],
                ['MSO', `$${totalMSOAmount.toFixed(2)}`],
                ['TOTAL', `$${(totalCCSAmount + totalMSOAmount).toFixed(2)}`]
            ];
            
            doc.autoTable({
                startY: yPos,
                head: [['UNIDAD', 'IMPORTE']],
                body: unitData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 91, 170], 
                    textColor: [255, 255, 255],
                    fontSize: 10
                },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 50 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('P√°gina ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            // Informaci√≥n de generaci√≥n
            const finalY = doc.autoTable.previous.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 105, finalY, null, null, 'center');
            doc.text('Sistema de Control de Traslados de Taxi - Inter', 105, finalY + 5, null, null, 'center');
            
            // Generar nombre de archivo seg√∫n el tipo de periodo
            let fileName = '';
            const periodType = reportPeriodType.value;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    fileName = `Reporte_Mensual_${monthNames[month]}_${reportYearSelect.value}.pdf`;
                    break;
                case 'week':
                    const weekStart = new Date(reportWeekStart.value).toISOString().slice(0,10);
                    const weekEnd = new Date(reportWeekEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Semanal_${weekStart}_a_${weekEnd}.pdf`;
                    break;
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const fortnightText = fortnight === 'first' ? 'PrimeraQuincena' : 'SegundaQuincena';
                    fileName = `Reporte_Quincena_${fortnightText}_${monthNames[fortnightMonth]}_${reportYearSelect.value}.pdf`;
                    break;
                case 'custom':
                    const customStart = new Date(reportCustomStart.value).toISOString().slice(0,10);
                    const customEnd = new Date(reportCustomEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Personalizado_${customStart}_a_${customEnd}.pdf`;
                    break;
            }
            
            // Guardar PDF
            doc.save(fileName);
            
            showMessage(`‚úÖ Reporte exportado a PDF: ${fileName}`, "success");
        }

        // Event Listeners para pesta√±as
        tabDashboard.addEventListener('click', () => {
            tabDashboard.classList.add('btn-primary');
            tabDashboard.classList.remove('bg-gray-100', 'text-gray-700');
            tabReports.classList.remove('btn-primary');
            tabReports.classList.add('bg-gray-100', 'text-gray-700');
            dashboardContent.classList.remove('hidden');
            reportsContent.classList.add('hidden');
        });

        tabReports.addEventListener('click', () => {
            tabReports.classList.add('btn-primary');
            tabReports.classList.remove('bg-gray-100', 'text-gray-700');
            tabDashboard.classList.remove('btn-primary');
            tabDashboard.classList.add('bg-gray-100', 'text-gray-700');
            reportsContent.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            generateReport();
        });

        // Event Listeners para filtros
        toggleFiltersBtn.addEventListener('click', () => {
            if (filtersSection.classList.contains('collapsed')) {
                filtersSection.classList.remove('collapsed');
                filtersSection.classList.add('expanded');
                toggleFiltersText.textContent = 'üîç Ocultar Filtros';
                toggleFiltersIcon.textContent = '‚ñ≤';
            } else {
                filtersSection.classList.remove('expanded');
                filtersSection.classList.add('collapsed');
                toggleFiltersText.textContent = 'üîç Mostrar Filtros';
                toggleFiltersIcon.textContent = '‚ñº';
            }
        });

        applyFiltersBtn.addEventListener('click', applyFilters);
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        toggleViewBtn.addEventListener('click', toggleView);

        // Event Listeners para filtros en tiempo real
        filterName.addEventListener('input', debounce(applyFilters, 300));
        filterDepartment.addEventListener('change', applyFilters);
        filterCompany.addEventListener('change', applyFilters);
        filterAuthorizer.addEventListener('change', applyFilters);
        filterMinCost.addEventListener('input', debounce(applyFilters, 500));
        filterMaxCost.addEventListener('input', debounce(applyFilters, 500));

        // Funci√≥n debounce para evitar m√∫ltiples llamadas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Event Listeners para reportes
        reportPeriodType.addEventListener('change', handlePeriodTypeChange);
        reportMonthSelect.addEventListener('change', updatePeriodText);
        reportYearSelect.addEventListener('change', updatePeriodText);
        reportWeekStart.addEventListener('change', updatePeriodText);
        reportWeekEnd.addEventListener('change', updatePeriodText);
        reportFortnight.addEventListener('change', updatePeriodText);
        reportFortnightMonth.addEventListener('change', updatePeriodText);
        reportCustomStart.addEventListener('change', updatePeriodText);
        reportCustomEnd.addEventListener('change', updatePeriodText);
        
        setCurrentWeekBtn.addEventListener('click', setCurrentWeek);
        setLast30DaysBtn.addEventListener('click', setLast30Days);
        
        generateReportBtn.addEventListener('click', generateReport);
        exportReportExcelBtn.addEventListener('click', exportReportToExcel);
        exportReportPDFBtn.addEventListener('click', exportReportToPDF);

        // Event Listeners del Dashboard
        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = submitButton;
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'üíæ Guardando...';
            document.body.classList.add('loading');

            try {
                // Parsear correctamente la fecha del input
                const dateValue = transferDateInput.value;
                const [year, month, day] = dateValue.split('-').map(Number);
                const dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));

                const transferData = {
                    requesterName: requesterNameInput.value.trim(),
                    department: departmentInput.value,
                    msoDepartment: msoDepartmentInput.value || '',
                    originPlace: originPlaceInput.value.trim(),
                    destinationPlace: destinationPlaceInput.value.trim(),
                    returnAddress: returnAddressInput.value.trim(),
                    returnDestination: returnDestinationInput.value.trim(),
                    dateTime: dateTime, // Usar fecha corregida
                    cost: parseFloat(costInput.value),
                    authorizerName: authorizerNameInput.value,
                    companyName: companyNameInput.value
                };

                const success = await saveTransfer(transferData);
                if (success) {
                    transferForm.reset();
                    msoDepartmentsContainer.classList.add('hidden');
                    msoDepartmentInput.required = false;
                    serviceTypeBadge.classList.add('hidden');
                    
                    // Establecer fecha actual
                    const today = new Date();
                    const currentYear = today.getFullYear();
                    const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
                    const currentDay = String(today.getDate()).padStart(2, '0');
                    transferDateInput.value = `${currentYear}-${currentMonth}-${currentDay}`;
                    
                    // Restablecer autorizador por defecto seg√∫n el departamento seleccionado
                    const department = departmentInput.value;
                    if (department) {
                        const serviceType = getServiceTypeWithMSO(department, '');
                        if (serviceType.type === 'MSO') {
                            authorizerNameInput.value = 'Mario Fernandez';
                        } else {
                            authorizerNameInput.value = 'Jorge Basualdo';
                        }
                    } else {
                        authorizerNameInput.value = '';
                    }
                    if (editingId) {
                        cancelEdit();
                    }
                }
            } catch (error) {
                console.error("Error al procesar el formulario:", error);
                showMessage("‚ùå Error al procesar la solicitud.", "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                document.body.classList.remove('loading');
            }
        });

        exportCsvBtn.addEventListener('click', () => {
            // Filtrar traslados seg√∫n los filtros aplicados
            let transfersToExport = [...transfers];
            
            // Aplicar mismos filtros que en la vista
            if (currentFilters.name) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(currentFilters.name)
                );
            }
            
            if (currentFilters.department) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.department === currentFilters.department
                );
            }
            
            if (currentFilters.company) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.companyName === currentFilters.company
                );
            }
            
            if (currentFilters.authorizer) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.authorizerName === currentFilters.authorizer
                );
            }
            
            if (currentFilters.dateStart && currentFilters.dateEnd) {
                transfersToExport = transfersToExport.filter(transfer => {
                    const transferDate = transfer.dateTime;
                    return transferDate >= currentFilters.dateStart && transferDate <= currentFilters.dateEnd;
                });
            }
            
            if (currentFilters.minCost !== null) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.cost >= currentFilters.minCost
                );
            }
            
            if (currentFilters.maxCost !== null) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.cost <= currentFilters.maxCost
                );
            }

            if (transfersToExport.length === 0) {
                showMessage("‚ùå No hay datos para exportar con los filtros actuales.", "error");
                return;
            }
        
            const dataToExport = transfersToExport.map(t => {
                const serviceType = getServiceTypeWithMSO(t.department, t.msoDepartment);
                return {
                    'Fecha': t.dateTime.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    'Solicitante': t.requesterName,
                    'Departamento': t.department,
                    'Tipo Servicio': serviceType.text,
                    'Depto. MSO': t.msoDepartment || '',
                    'Origen Partida': t.originPlace || '',
                    'Origen Destino': t.destinationPlace || '',
                    'Vuelta Partida': t.returnAddress || '',
                    'Vuelta Destino': t.returnDestination || '',
                    'Qui√©n Autoriza': t.authorizerName,
                    'Empresa de Traslado': t.companyName,
                    'Costo ($)': t.cost
                };
            });

            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const monthlyTransfers = transfersToExport.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            
            const departmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                departmentExpenses[department] = (departmentExpenses[department] || 0) + transfer.cost;
            });

            const departmentSummaryData = Object.entries(departmentExpenses).map(([department, cost]) => {
                const serviceType = department.includes('MSO') ? 'MSO' : 'CCS';
                return {
                    'Departamento': department,
                    'Tipo Servicio': serviceType,
                    'Gasto Mensual Total ($)': cost
                };
            });
            
            const mainWorksheet = XLSX.utils.json_to_sheet(dataToExport);
            const summaryWorksheet = XLSX.utils.json_to_sheet(departmentSummaryData);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, mainWorksheet, 'Historial');
            XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'Resumen por Departamento');
            XLSX.writeFile(workbook, `traslados_taxi_${new Date().toISOString().slice(0,10)}.xlsx`);
            
            showMessage("‚úÖ Datos exportados exitosamente a Excel", "success");
        });

        importExcelBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Saltar la fila de encabezado y procesar datos
                const importedTransfers = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 11) {
                        const [dateStr, requesterName, department, msoDepartment, originPlace, destinationPlace, returnAddress, returnDestination, authorizerName, companyName, cost] = row;
                        
                        // Parsear fecha correctamente
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else if (dateStr.includes('-')) {
                            const [year, month, day] = dateStr.split('-').map(Number);
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: msoDepartment?.toString() || '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: destinationPlace?.toString() || '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: returnDestination?.toString() || '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    } else if (row.length >= 8) {
                        // Formato antiguo (compatibilidad con archivos antiguos)
                        const [dateStr, requesterName, department, originPlace, returnAddress, authorizerName, companyName, cost] = row;
                        
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else if (dateStr.includes('-')) {
                            const [year, month, day] = dateStr.split('-').map(Number);
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    }
                }

                // Guardar todos los traslados importados
                let successCount = 0;
                for (const transfer of importedTransfers) {
                    const success = await saveTransfer(transfer);
                    if (success) successCount++;
                }

                showMessage(`‚úÖ Importaci√≥n completada: ${successCount}/${importedTransfers.length} traslados importados.`, "success");
                fileInput.value = '';

            } catch (error) {
                console.error("Error al importar archivo:", error);
                showMessage("‚ùå Error al importar el archivo. Verifica el formato.", "error");
            }
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage("‚ùå Por favor, selecciona al menos un traslado para eliminar.", "error");
                return;
            }

            if (!confirm(`‚ö†Ô∏è ¬øEst√°s seguro de que deseas eliminar ${checkboxes.length} traslado(s)? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }

            const idsToDelete = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            const success = await deleteTransfers(idsToDelete);
            if (success) {
                selectAllCheckboxes.checked = false;
                updateSelectedCount();
            }
        });

        selectAllCheckboxes.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
            updateSelectedCount();
        });

        // Redimensionar tabla cuando cambie el tama√±o de la ventana
        window.addEventListener('resize', debounce(renderTransfers, 250));

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            // Establecer fecha actual correctamente
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            transferDateInput.value = `${year}-${month}-${day}`;
            
            // Establecer mes actual en el selector de reportes
            const currentMonth = new Date().getMonth();
            reportMonthSelect.value = currentMonth.toString();
            
            // Establecer a√±o actual en el selector de reportes
            const currentYear = new Date().getFullYear();
            reportYearSelect.value = currentYear.toString();
            
            // Inicializar flatpickr
            initDateRangePicker();
            
            // Manejar cambio inicial del tipo de periodo
            handlePeriodTypeChange();
            
            loadTransfers();
        });

        // Limpiar suscripci√≥n al cerrar la p√°gina
        window.addEventListener('beforeunload', () => {
            if (unsubscribeTransfers) {
                unsubscribeTransfers();
            }
        });

        // Hacer las funciones accesibles globalmente
        window.startEditTransfer = startEditTransfer;
        window.toggleRowExpansion = toggleRowExpansion;
        window.toggleRowDetails = toggleRowDetails;
        window.updateSelectedCount = updateSelectedCount;
    </script>
</body>
</html>
