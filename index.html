<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Traslados de Taxi - Inter</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS desde CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js y dependencias -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK (versión CDN) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- jsPDF para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <!-- Flatpickr para selección de fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .bg-inter-primary { background-color: #005BAA; }
        .bg-inter-accent-light { background-color: #5CE1E6; }
        .bg-inter-accent-yellow { background-color: #FDD000; }
        .text-inter-primary { color: #005BAA; }
        .text-inter-accent-light { color: #5CE1E6; }
        .text-inter-accent-yellow { color: #FDD000; }
        .border-inter-primary { border-color: #005BAA; }
        .border-inter-accent-light { border-color: #5CE1E6; }
        .focus\:ring-inter-primary:focus { --tw-ring-color: #005BAA; }
        #transferTableBody tr:nth-child(even) {
            background-color: #f8f8f8;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .tab-button {
            transition: all 0.3s ease;
        }
        .tab-button.active {
            background-color: #005BAA;
            color: white;
            font-weight: bold;
        }
        .compact-row {
            max-height: 60px;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }
        .compact-row.expanded {
            max-height: 500px;
        }
        .compact-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .compact-cell.expanded {
            max-width: none;
            white-space: normal;
            word-wrap: break-word;
        }
        .expand-btn {
            cursor: pointer;
            color: #005BAA;
            font-size: 12px;
        }
        .filter-section {
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .filter-section.collapsed {
            max-height: 60px;
        }
        .filter-section.expanded {
            max-height: 500px;
        }
        .date-range-display {
            font-size: 0.875rem;
            color: #666;
            margin-top: 4px;
        }
        .service-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 5px;
        }
        .badge-ccs {
            background-color: #005BAA;
            color: white;
        }
        .badge-mso {
            background-color: #FDD000;
            color: #333;
        }
        @media (max-width: 768px) {
            .responsive-table {
                display: block;
            }
            .responsive-table thead {
                display: none;
            }
            .responsive-table tbody tr {
                display: block;
                margin-bottom: 1rem;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1rem;
            }
            .responsive-table tbody td {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #f3f4f6;
            }
            .responsive-table tbody td:last-child {
                border-bottom: none;
            }
            .responsive-table tbody td::before {
                content: attr(data-label);
                font-weight: 600;
                color: #005BAA;
                min-width: 120px;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-2 md:p-4 min-h-screen flex flex-col items-center">
    <div class="w-full max-w-7xl bg-white rounded-xl shadow-lg p-4 md:p-6 lg:p-8 mb-8">
        <header class="text-center mb-6 bg-inter-primary rounded-t-xl py-4 md:py-6 relative overflow-hidden">
            <h1 class="text-2xl md:text-3xl lg:text-4xl font-extrabold text-white mb-2 relative z-10">
                Control de Traslados de Taxi
            </h1>
            <p class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-lg md:text-xl lg:text-2xl font-extrabold text-white opacity-10 whitespace-nowrap select-none pointer-events-none z-0">
                Inter Tu mundo, nuestro compromiso.
            </p>
            <p class="text-xs md:text-sm text-white mt-2 relative z-10">Registro y gestión de solicitudes de traslados de taxi</p>
            <div id="connectionStatus" class="absolute top-2 md:top-4 right-2 md:right-4 flex items-center">
                <span class="text-white text-xs md:text-sm mr-2">Conectado</span>
                <div class="w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full animate-pulse"></div>
            </div>
        </header>

        <!-- Pestañas de navegación -->
        <div class="mb-4 md:mb-6 flex space-x-1 md:space-x-2 border-b border-gray-200">
            <button id="tabDashboard" class="tab-button active px-3 py-1 md:px-4 md:py-2 rounded-t-lg bg-inter-primary text-white font-semibold text-sm md:text-base">
                Dashboard
            </button>
            <button id="tabReports" class="tab-button px-3 py-1 md:px-4 md:py-2 rounded-t-lg bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 text-sm md:text-base">
                Reportes Financieros
            </button>
        </div>

        <!-- Contenido del Dashboard (pestaña principal) -->
        <div id="dashboardContent">
            <section id="registerSection" class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4">Registrar Nuevo Traslado</h2>
                <form id="transferForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 md:gap-4">
                    
                    <div>
                        <label for="requesterName" class="block text-sm font-medium text-gray-700 mb-1">
                            Nombre del Solicitante
                        </label>
                        <input type="text" id="requesterName" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Juan Pérez">
                    </div>
                    <div>
                        <label for="department" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento/Área
                        </label>
                        <select id="department" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                            <option value="" disabled selected>Selecciona un Departamento</option>
                            <option value="Administracion">Administración</option>
                            <option value="Area Comercial">Área Comercial</option>
                            <option value="Area tecnica">Área Técnica</option>
                            <option value="Obras">Obras</option>
                            <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                            <option value="Sistemas">Sistemas</option>
                            <option value="Gerencia Senior">Gerencia Senior</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Colaboradores">Colaboradores</option>
                            <option value="MSO">MSO</option>
                        </select>
                        <div id="serviceTypeBadge" class="mt-1 text-xs font-semibold hidden">
                            Tipo de servicio: 
                            <span id="serviceTypeText" class="service-type-badge"></span>
                        </div>
                    </div>
                    <div id="msoDepartmentsContainer" class="hidden col-span-1 md:col-span-3">
                        <label for="msoDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                            Departamento MSO (Observaciones)
                        </label>
                        <select id="msoDepartment"
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                            <option value="" disabled selected>Selecciona departamento MSO</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Presidencia">Presidencia</option>
                            <option value="Interconexiones">Interconexiones</option>
                            <option value="Importaciones">Importaciones</option>
                            <option value="RRHH MSO">RRHH MSO</option>
                            <option value="Documentacion de obras">Documentación de Obras</option>
                            <option value="Limpieza">Limpieza</option>
                            <option value="Colaboradores">Colaboradores</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="originPlace" class="block text-sm font-medium text-gray-700 mb-1">
                            Lugar de Origen - Punto de Partida
                        </label>
                        <input type="text" id="originPlace" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Sede Principal, Cliente X, Aeropuerto">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="destinationPlace" class="block text-sm font-medium text-gray-700 mb-1">
                            Lugar de Origen - Punto de Llegada
                        </label>
                        <input type="text" id="destinationPlace" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Oficina Central, Hotel, Terminal">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="returnAddress" class="block text-sm font-medium text-gray-700 mb-1">
                            Dirección de Vuelta - Punto de Partida
                        </label>
                        <input type="text" id="returnAddress"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label for="returnDestination" class="block text-sm font-medium text-gray-700 mb-1">
                            Dirección de Vuelta - Destino Final
                        </label>
                        <input type="text" id="returnDestination"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                               placeholder="Ej. Domicilio particular, Otro cliente, N/A">
                    </div>
                    <div>
                        <label for="transferDate" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha del Traslado
                        </label>
                        <input type="date" id="transferDate" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                    </div>
                    <div>
                        <label for="cost" class="block text-sm font-medium text-gray-700 mb-1">
                            Costo del Traslado (USD $)
                        </label>
                        <input type="number" id="cost" step="0.01" min="0" value="0.00" required
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                    </div>
                    <div>
                        <label for="authorizerName" class="block text-sm font-medium text-gray-700 mb-1">
                            Quién Autoriza
                        </label>
                        <select id="authorizerName" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                            <option value="" disabled selected>Selecciona Autorizador</option>
                            <option value="Jorge Basualdo">Jorge Basualdo</option>
                        </select>
                    </div>
                    <div>
                        <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">
                            Empresa de Traslado
                        </label>
                        <select id="companyName" required
                                class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                            <option value="" disabled selected>Selecciona Empresa</option>
                            <option value="Yummy">Yummy</option>
                            <option value="Andrew">Andrew</option>
                            <option value="Oscar">Oscar</option>
                            <option value="Neomar">Neomar</option>
                            <option value="Jose">Jose</option>
                        </select>
                    </div>
                    <div class="col-span-1 md:col-span-3 flex justify-end space-x-2 md:space-x-4">
                        <button type="button" id="cancelEditBtn"
                                class="hidden bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm md:text-base">
                            Cancelar
                        </button>
                        <button type="submit" id="submitButton"
                                class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 md:px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 text-sm md:text-base">
                            Registrar Traslado
                        </button>
                    </div>
                </form>
                <div id="messageBox" class="mt-4 p-3 rounded-md text-sm hidden"></div>
            </section>

            <section class="mb-6 md:mb-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4">Resumen de Gastos de Traslados</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 text-center">
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-sm md:text-lg font-semibold text-gray-700">Gastos Diarios</h3>
                        <p id="dailyTotal" class="text-xl md:text-2xl lg:text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-sm md:text-lg font-semibold text-gray-700">Gastos Semanales</h3>
                        <p id="weeklyTotal" class="text-xl md:text-2xl lg:text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-sm md:text-lg font-semibold text-gray-700">Gastos Mensuales</h3>
                        <p id="monthlyTotal" class="text-xl md:text-2xl lg:text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-3 md:p-4 rounded-lg shadow-md">
                        <h3 class="text-sm md:text-lg font-semibold text-gray-700">Gastos Anuales</h3>
                        <p id="annualTotal" class="text-xl md:text-2xl lg:text-3xl font-extrabold text-inter-primary mt-2">$0.00</p>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN DE FILTROS MEJORADA -->
            <section class="p-4 md:p-6 bg-white rounded-lg border border-inter-primary shadow-lg mb-4 md:mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl md:text-2xl font-bold text-inter-primary">Historial de Traslados</h2>
                    <button id="toggleFiltersBtn" class="bg-inter-accent-light hover:bg-cyan-600 text-gray-800 hover:text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                        <span id="toggleFiltersText">Mostrar Filtros</span>
                        <span id="toggleFiltersIcon">▼</span>
                    </button>
                </div>

                <!-- Filtros avanzados - Colapsable -->
                <div id="filtersSection" class="filter-section collapsed mb-4 p-4 bg-blue-50 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <!-- Filtro por nombre/apellido -->
                        <div>
                            <label for="filterName" class="block text-sm font-medium text-gray-700 mb-1">
                                Nombre/Apellido
                            </label>
                            <input type="text" id="filterName"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                   placeholder="Buscar por nombre o apellido">
                        </div>
                        
                        <!-- Filtro por departamento -->
                        <div>
                            <label for="filterDepartment" class="block text-sm font-medium text-gray-700 mb-1">
                                Departamento
                            </label>
                            <select id="filterDepartment" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                                <option value="">Todos los departamentos</option>
                                <option value="Administracion">Administración</option>
                                <option value="Area Comercial">Área Comercial</option>
                                <option value="Area tecnica">Área Técnica</option>
                                <option value="Obras">Obras</option>
                                <option value="RRHH y Seguridad Laboral">RRHH y Seguridad Laboral</option>
                                <option value="Sistemas">Sistemas</option>
                                <option value="Gerencia Senior">Gerencia Senior</option>
                                <option value="Limpieza">Limpieza</option>
                                <option value="Colaboradores">Colaboradores</option>
                                <option value="MSO">MSO</option>
                            </select>
                        </div>
                        
                        <!-- Filtro por empresa -->
                        <div>
                            <label for="filterCompany" class="block text-sm font-medium text-gray-700 mb-1">
                                Empresa de Traslado
                            </label>
                            <select id="filterCompany" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                                <option value="">Todas las empresas</option>
                                <option value="Yummy">Yummy</option>
                                <option value="Andrew">Andrew</option>
                                <option value="Oscar">Oscar</option>
                                <option value="Neomar">Neomar</option>
                                <option value="Jose">Jose</option>
                            </select>
                        </div>
                        
                        <!-- Filtro por autorizador -->
                        <div>
                            <label for="filterAuthorizer" class="block text-sm font-medium text-gray-700 mb-1">
                                Quién Autoriza
                            </label>
                            <select id="filterAuthorizer" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base">
                                <option value="">Todos los autorizadores</option>
                                <option value="Jorge Basualdo">Jorge Basualdo</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Filtro por rango de fechas -->
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4">
                        <div>
                            <label for="filterDateRange" class="block text-sm font-medium text-gray-700 mb-1">
                                Rango de Fechas
                            </label>
                            <input type="text" id="filterDateRange"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                   placeholder="Seleccionar rango de fechas">
                            <div id="dateRangeDisplay" class="date-range-display"></div>
                        </div>
                        
                        <!-- Filtro por costo -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">
                                Rango de Costo ($)
                            </label>
                            <div class="flex space-x-2">
                                <input type="number" id="filterMinCost" step="0.01" min="0"
                                       class="w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                       placeholder="Mínimo">
                                <input type="number" id="filterMaxCost" step="0.01" min="0"
                                       class="w-1/2 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary text-sm md:text-base"
                                       placeholder="Máximo">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Botones de acción de filtros -->
                    <div class="mt-4 flex flex-wrap gap-2 md:gap-4">
                        <button id="applyFiltersBtn" class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            Aplicar Filtros
                        </button>
                        <button id="clearAllFiltersBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            Limpiar Todos los Filtros
                        </button>
                        <button id="toggleViewBtn" class="bg-inter-accent-yellow hover:bg-yellow-600 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            <span id="toggleViewText">Vista Compacta</span>
                        </button>
                    </div>
                </div>

                <!-- Barra de herramientas -->
                <div class="mb-4 p-3 md:p-4 bg-blue-50 rounded-lg flex flex-col md:flex-row items-center gap-2 md:gap-4">
                    <div class="text-sm text-gray-700 font-medium">
                        Resultados: <span id="resultsCount">0</span> traslados
                    </div>
                    <div class="flex-grow"></div>
                    <div class="flex flex-wrap gap-2 md:gap-4">
                        <button id="exportCsvBtn"
                                class="bg-inter-accent-light hover:bg-cyan-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            Exportar a Excel
                        </button>
                        <button id="importExcelBtn"
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            Importar
                        </button>
                        <input type="file" id="fileInput" class="hidden" accept=".csv, .xlsx">
                        <button id="deleteSelectedBtn"
                                class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-3 md:px-4 rounded-lg shadow-md transition duration-300 ease-in-out text-sm md:text-base">
                            Eliminar Seleccionados
                        </button>
                    </div>
                </div>

                <!-- Tabla de historial - MEJORADA PARA RESPONSIVE -->
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200 responsive-table">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">
                                    <input type="checkbox" id="selectAllCheckboxes" class="form-checkbox h-4 w-4 text-inter-primary rounded">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Solicitante</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo Servicio</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Origen</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Destino</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Empresa</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Costo ($)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transferTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="noTransfersMessage" class="text-center text-gray-500 mt-4 hidden">No hay traslados registrados aún.</p>
            </section>
            
            <!-- Secciones de gráficos (mantenidas igual) -->
            <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4">Gastos por Empresa de Traslado</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gasto Mensual por Empresa</h3>
                        <div class="w-full h-48 md:h-64">
                            <canvas id="monthlyCompanyChart"></canvas>
                        </div>
                    </div>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gasto Anual por Empresa</h3>
                        <div class="w-full h-48 md:h-64">
                            <canvas id="annualCompanyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>
            
            <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4">Gastos por Departamento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gasto Mensual por Departamento</h3>
                        <div class="w-full h-48 md:h-64">
                            <canvas id="monthlyDepartmentChart"></canvas>
                        </div>
                    </div>
                    <div class="p-3 md:p-4 bg-gray-50 rounded-lg shadow-inner flex flex-col items-center">
                        <h3 class="text-lg md:text-xl font-bold text-inter-primary mb-3 md:mb-4 text-center">Gasto Anual por Departamento</h3>
                        <div class="w-full h-48 md:h-64">
                            <canvas id="annualDepartmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <section class="mt-6 md:mt-8 p-4 md:p-6 bg-white rounded-lg border border-inter-accent-light shadow-lg">
                <h2 class="text-xl md:text-2xl font-bold text-inter-primary mb-4">Estadísticas de Traslados por Departamento</h2>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-blue-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Departamento</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Tipo Servicio</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Traslados Mensuales</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Mensual ($)</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider">Traslados Anuales</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-inter-primary uppercase tracking-wider">Gasto Anual ($)</th>
                            </tr>
                        </thead>
                        <tbody id="departmentStatsTableBody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <p id="noStatsMessage" class="text-center text-gray-500 mt-4 hidden">No hay datos de estadísticas disponibles.</p>
            </section>
        </div>

        <!-- Contenido de Reportes Financieros (pestaña secundaria - MODIFICADA) -->
        <div id="reportsContent" class="hidden">
            <section class="mb-8 p-6 bg-white rounded-lg border border-inter-primary shadow-lg">
                <h2 class="text-2xl font-bold text-inter-primary mb-4">Reportes Financieros de Traslados</h2>
                
                <!-- NUEVO: Selector de tipo de periodo -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reportPeriodType" class="block text-sm font-medium text-gray-700 mb-1">
                            Tipo de Periodo
                        </label>
                        <select id="reportPeriodType" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="month" selected>Mes</option>
                            <option value="week">Semana</option>
                            <option value="fortnight">Quincena</option>
                            <option value="custom">Personalizado</option>
                        </select>
                    </div>
                    <div id="monthYearContainer">
                        <label for="reportMonth" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Mes
                        </label>
                        <select id="reportMonth" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                
                <!-- NUEVO: Contenedor para semana -->
                <div id="weekContainer" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                    <div>
                        <label for="reportWeekStart" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha Inicio Semana
                        </label>
                        <input type="date" id="reportWeekStart" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div>
                        <label for="reportWeekEnd" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha Fin Semana
                        </label>
                        <input type="date" id="reportWeekEnd" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div class="flex items-end">
                        <button id="setCurrentWeekBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full">
                            Semana Actual
                        </button>
                    </div>
                </div>
                
                <!-- NUEVO: Contenedor para quincena -->
                <div id="fortnightContainer" class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div>
                        <label for="reportFortnight" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Quincena
                        </label>
                        <select id="reportFortnight" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="first">Primera Quincena (1-15)</option>
                            <option value="second">Segunda Quincena (16-fin de mes)</option>
                        </select>
                    </div>
                    <div>
                        <label for="reportFortnightMonth" class="block text-sm font-medium text-gray-700 mb-1">
                            Mes
                        </label>
                        <select id="reportFortnightMonth" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="0">Enero</option>
                            <option value="1">Febrero</option>
                            <option value="2">Marzo</option>
                            <option value="3">Abril</option>
                            <option value="4">Mayo</option>
                            <option value="5">Junio</option>
                            <option value="6">Julio</option>
                            <option value="7">Agosto</option>
                            <option value="8">Septiembre</option>
                            <option value="9">Octubre</option>
                            <option value="10">Noviembre</option>
                            <option value="11">Diciembre</option>
                        </select>
                    </div>
                </div>
                
                <!-- NUEVO: Contenedor para rango personalizado -->
                <div id="customRangeContainer" class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
                    <div>
                        <label for="reportCustomStart" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha Inicio
                        </label>
                        <input type="date" id="reportCustomStart" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div>
                        <label for="reportCustomEnd" class="block text-sm font-medium text-gray-700 mb-1">
                            Fecha Fin
                        </label>
                        <input type="date" id="reportCustomEnd" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                    </div>
                    <div class="flex items-end">
                        <button id="setLast30DaysBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out w-full">
                            Últimos 30 días
                        </button>
                    </div>
                </div>
                
                <!-- Contenedor para año (común a todos) -->
                <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="reportYear" class="block text-sm font-medium text-gray-700 mb-1">
                            Seleccionar Año
                        </label>
                        <select id="reportYear" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-inter-primary focus:border-inter-primary">
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="generateReportBtn" class="bg-inter-primary hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out w-full">
                            Generar Reporte
                        </button>
                    </div>
                </div>
                
                <!-- Display del periodo seleccionado -->
                <div id="periodDisplay" class="mb-4 p-3 bg-blue-50 rounded-lg">
                    <h3 class="text-lg font-bold text-inter-primary mb-2">Periodo del Reporte:</h3>
                    <p id="periodText" class="text-gray-700">No se ha seleccionado ningún periodo</p>
                </div>

                <!-- Botones de exportación -->
                <div class="mb-6 flex flex-wrap gap-4">
                    <button id="exportReportExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Exportar a Excel
                    </button>
                    <button id="exportReportPDFBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Exportar a PDF
                    </button>
                </div>

                <!-- Reporte: Departamentos que utilizan servicio de traslado -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 40%;">DEPARTAMENTOS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">UN CCS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 30%;">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody id="departmentsReportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Datos se cargarán aquí -->
                            </tbody>
                            <tfoot class="bg-gray-100">
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL CCS</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                    <td id="totalCCS" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">MSO</td>
                                    <td id="totalMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                                <tr class="bg-inter-accent-light">
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTAL, CCS + MSO</td>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900"></td>
                                    <td id="totalCCSMSO" class="px-6 py-3 text-left text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Reporte: Empresas proveedoras de servicio CCS y MSO -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">EMPRESA</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">SERVICIOS A CCS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">SERVICIOS A MSO</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 25%;">TOTAL</th>
                                </tr>
                            </thead>
                            <tbody id="companiesReportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Datos se cargarán aquí -->
                            </tbody>
                            <tfoot class="bg-inter-accent-light">
                                <tr>
                                    <td class="px-6 py-3 text-left text-sm font-bold text-gray-900">TOTALES</td>
                                    <td id="totalCCSServices" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                    <td id="totalMSOServices" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                    <td id="totalCompanies" class="px-6 py-3 text-left text-sm font-bold text-gray-900">0 servicios - $0.00</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

                <!-- Resumen por unidad -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-inter-primary mb-4">RESUMEN POR UNIDAD</h3>
                    <div class="overflow-x-auto rounded-lg shadow-md">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-blue-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">UNIDAD</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-inter-primary uppercase tracking-wider" style="width: 50%;">IMPORTE</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">CCS</td>
                                    <td id="unitCCS" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">MSO</td>
                                    <td id="unitMSO" class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">$0.00</td>
                                </tr>
                                <tr class="bg-inter-accent-light">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">TOTAL</td>
                                    <td id="unitTotal" class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">$0.00</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script>
        // Inicializar Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCfEP2_MYdPRCb4gKnXLEV-tUNNFkQmkOo",
            authDomain: "gestion-de-traslados.firebaseapp.com",
            projectId: "gestion-de-traslados",
            storageBucket: "gestion-de-traslados.firebasestorage.app",
            messagingSenderId: "547255399573",
            appId: "1:547255399573:web:c636870e286428fb81979c"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Inicializar jsPDF
        const { jsPDF } = window.jspdf;
        
        Chart.register(ChartDataLabels);
        
        // Elementos del Dashboard
        const transferForm = document.getElementById('transferForm');
        const requesterNameInput = document.getElementById('requesterName');
        const departmentInput = document.getElementById('department');
        const serviceTypeBadge = document.getElementById('serviceTypeBadge');
        const serviceTypeText = document.getElementById('serviceTypeText');
        const msoDepartmentsContainer = document.getElementById('msoDepartmentsContainer');
        const msoDepartmentInput = document.getElementById('msoDepartment');
        const originPlaceInput = document.getElementById('originPlace');
        const destinationPlaceInput = document.getElementById('destinationPlace');
        const returnAddressInput = document.getElementById('returnAddress');
        const returnDestinationInput = document.getElementById('returnDestination');
        const transferDateInput = document.getElementById('transferDate');
        const costInput = document.getElementById('cost');
        const authorizerNameInput = document.getElementById('authorizerName');
        const companyNameInput = document.getElementById('companyName');
        const messageBox = document.getElementById('messageBox');
        const transferTableBody = document.getElementById('transferTableBody');
        const departmentStatsTableBody = document.getElementById('departmentStatsTableBody');
        const dailyTotalSpan = document.getElementById('dailyTotal');
        const weeklyTotalSpan = document.getElementById('weeklyTotal');
        const monthlyTotalSpan = document.getElementById('monthlyTotal');
        const annualTotalSpan = document.getElementById('annualTotal');
        const noTransfersMessage = document.getElementById('noTransfersMessage');
        const noStatsMessage = document.getElementById('noStatsMessage');
        const submitButton = document.getElementById('submitButton');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const registerSection = document.getElementById('registerSection');
        const connectionStatus = document.getElementById('connectionStatus');

        // Elementos de pestañas
        const tabDashboard = document.getElementById('tabDashboard');
        const tabReports = document.getElementById('tabReports');
        const dashboardContent = document.getElementById('dashboardContent');
        const reportsContent = document.getElementById('reportsContent');

        // Elementos de reportes MODIFICADOS
        const reportPeriodType = document.getElementById('reportPeriodType');
        const monthYearContainer = document.getElementById('monthYearContainer');
        const weekContainer = document.getElementById('weekContainer');
        const fortnightContainer = document.getElementById('fortnightContainer');
        const customRangeContainer = document.getElementById('customRangeContainer');
        const reportMonthSelect = document.getElementById('reportMonth');
        const reportYearSelect = document.getElementById('reportYear');
        const reportWeekStart = document.getElementById('reportWeekStart');
        const reportWeekEnd = document.getElementById('reportWeekEnd');
        const reportFortnight = document.getElementById('reportFortnight');
        const reportFortnightMonth = document.getElementById('reportFortnightMonth');
        const reportCustomStart = document.getElementById('reportCustomStart');
        const reportCustomEnd = document.getElementById('reportCustomEnd');
        const setCurrentWeekBtn = document.getElementById('setCurrentWeekBtn');
        const setLast30DaysBtn = document.getElementById('setLast30DaysBtn');
        const generateReportBtn = document.getElementById('generateReportBtn');
        const exportReportExcelBtn = document.getElementById('exportReportExcelBtn');
        const exportReportPDFBtn = document.getElementById('exportReportPDFBtn');
        const periodDisplay = document.getElementById('periodDisplay');
        const periodText = document.getElementById('periodText');
        
        const departmentsReportTableBody = document.getElementById('departmentsReportTableBody');
        const companiesReportTableBody = document.getElementById('companiesReportTableBody');
        const totalCCS = document.getElementById('totalCCS');
        const totalMSO = document.getElementById('totalMSO');
        const totalCCSMSO = document.getElementById('totalCCSMSO');
        const totalCCSServices = document.getElementById('totalCCSServices');
        const totalMSOServices = document.getElementById('totalMSOServices');
        const totalCompanies = document.getElementById('totalCompanies');
        const unitCCS = document.getElementById('unitCCS');
        const unitMSO = document.getElementById('unitMSO');
        const unitTotal = document.getElementById('unitTotal');

        // Elementos de filtros MEJORADOS
        const toggleFiltersBtn = document.getElementById('toggleFiltersBtn');
        const toggleFiltersText = document.getElementById('toggleFiltersText');
        const toggleFiltersIcon = document.getElementById('toggleFiltersIcon');
        const filtersSection = document.getElementById('filtersSection');
        const filterName = document.getElementById('filterName');
        const filterDepartment = document.getElementById('filterDepartment');
        const filterCompany = document.getElementById('filterCompany');
        const filterAuthorizer = document.getElementById('filterAuthorizer');
        const filterDateRange = document.getElementById('filterDateRange');
        const dateRangeDisplay = document.getElementById('dateRangeDisplay');
        const filterMinCost = document.getElementById('filterMinCost');
        const filterMaxCost = document.getElementById('filterMaxCost');
        const applyFiltersBtn = document.getElementById('applyFiltersBtn');
        const clearAllFiltersBtn = document.getElementById('clearAllFiltersBtn');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const toggleViewText = document.getElementById('toggleViewText');
        const resultsCount = document.getElementById('resultsCount');

        // Gráficos
        const monthlyCompanyChartCtx = document.getElementById('monthlyCompanyChart').getContext('2d');
        const annualCompanyChartCtx = document.getElementById('annualCompanyChart').getContext('2d');
        const monthlyDepartmentChartCtx = document.getElementById('monthlyDepartmentChart').getContext('2d');
        const annualDepartmentChartCtx = document.getElementById('annualDepartmentChart').getContext('2d');
        
        let monthlyCompanyChart;
        let annualCompanyChart;
        let monthlyDepartmentChart;
        let annualDepartmentChart;

        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const importExcelBtn = document.getElementById('importExcelBtn');
        const fileInput = document.getElementById('fileInput');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const selectAllCheckboxes = document.getElementById('selectAllCheckboxes');

        let transfers = [];
        let editingId = null;
        let unsubscribeTransfers = null;
        let currentFilters = {
            name: '',
            department: '',
            company: '',
            authorizer: '',
            dateStart: null,
            dateEnd: null,
            minCost: null,
            maxCost: null
        };
        let isCompactView = true;
        let expandedRows = new Set();
        
        // Variables para reportes
        let currentReportPeriod = {
            type: 'month',
            startDate: null,
            endDate: null,
            month: null,
            year: null
        };

        // Lista de departamentos para reportes (actualizada con Limpieza y Colaboradores en ambos CCS y MSO)
        const reportDepartments = [
            { name: "ADMINISTRACION", code: "Administracion", serviceType: "CCS" },
            { name: "AREA COMERCIAL", code: "Area Comercial", serviceType: "CCS" },
            { name: "AREA TECNICA", code: "Area tecnica", serviceType: "CCS" },
            { name: "DPTO DE OBRAS", code: "Obras", serviceType: "CCS" },
            { name: "RRHH y Seguridad Laboral", code: "RRHH y Seguridad Laboral", serviceType: "CCS" },
            { name: "SISTEMAS", code: "Sistemas", serviceType: "CCS" },
            { name: "G. SENIOR", code: "Gerencia Senior", serviceType: "CCS" },
            { name: "LIMPIEZA", code: "Limpieza", serviceType: "CCS" },
            { name: "COLABORADORES", code: "Colaboradores", serviceType: "CCS" },
            { name: "MSO", code: "MSO", serviceType: "MSO" }
        ];

        // Lista de empresas para reportes
        const reportCompanies = [
            { name: "YUMMY", code: "Yummy" },
            { name: "ANDREW", code: "Andrew" },
            { name: "NEOMAR", code: "Neomar" },
            { name: "OSCAR", code: "Oscar" },
            { name: "JOSE", code: "Jose" }
        ];

        // Función para determinar si un departamento es MSO o CCS
        function getServiceType(department) {
            if (department === 'MSO') {
                return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
            } else {
                return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
            }
        }

        // Función para determinar si un traslado con msoDepartment es MSO o CCS
        function getServiceTypeWithMSO(department, msoDepartment) {
            // Si el departamento principal es MSO, entonces es MSO
            if (department === 'MSO') {
                return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
            }
            // Si el departamento principal es Limpieza o Colaboradores
            else if (department === 'Limpieza' || department === 'Colaboradores') {
                // Si tiene msoDepartment especificado, entonces es MSO
                if (msoDepartment) {
                    return { type: 'MSO', text: 'MSO', badgeClass: 'badge-mso' };
                } else {
                    return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
                }
            }
            // Todos los demás departamentos son CCS
            else {
                return { type: 'CCS', text: 'CCS', badgeClass: 'badge-ccs' };
            }
        }

        function showMessage(message, type = 'info', box = messageBox) {
            box.textContent = message;
            box.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700', 'bg-yellow-100', 'text-yellow-700');
            if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-700');
            } else if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-700');
            } else {
                box.classList.add('bg-yellow-100', 'text-yellow-700');
            }
            box.classList.remove('hidden');
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        }

        function normalizeDateToStartOfDay(date) {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            return d;
        }

        // Inicializar flatpickr para rango de fechas
        let dateRangePicker;
        function initDateRangePicker() {
            dateRangePicker = flatpickr(filterDateRange, {
                mode: "range",
                dateFormat: "d/m/Y",
                locale: "es",
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length === 2) {
                        const startDate = selectedDates[0];
                        const endDate = selectedDates[1];
                        currentFilters.dateStart = normalizeDateToStartOfDay(startDate);
                        currentFilters.dateEnd = normalizeDateToStartOfDay(endDate);
                        
                        // Mostrar el rango seleccionado
                        dateRangeDisplay.textContent = `${startDate.toLocaleDateString('es-ES')} - ${endDate.toLocaleDateString('es-ES')}`;
                    } else {
                        currentFilters.dateStart = null;
                        currentFilters.dateEnd = null;
                        dateRangeDisplay.textContent = '';
                    }
                }
            });
        }

        // Manejar cambio en departamento - actualizar tipo de servicio
        departmentInput.addEventListener('change', function() {
            const department = this.value;
            
            if (department === 'MSO') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.required = true;
                serviceTypeBadge.classList.remove('hidden');
                serviceTypeText.textContent = 'MSO';
                serviceTypeText.className = 'service-type-badge badge-mso';
            } 
            else if (department === 'Limpieza' || department === 'Colaboradores') {
                // Mostrar selector MSO para Limpieza y Colaboradores
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.required = false;
                serviceTypeBadge.classList.remove('hidden');
                serviceTypeText.textContent = 'CCS'; // Por defecto CCS
                serviceTypeText.className = 'service-type-badge badge-ccs';
            }
            else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
                msoDepartmentInput.value = '';
                
                if (department) {
                    serviceTypeBadge.classList.remove('hidden');
                    serviceTypeText.textContent = 'CCS';
                    serviceTypeText.className = 'service-type-badge badge-ccs';
                } else {
                    serviceTypeBadge.classList.add('hidden');
                }
            }
        });

        // Manejar cambio en departamento MSO para Limpieza/Colaboradores
        msoDepartmentInput.addEventListener('change', function() {
            const department = departmentInput.value;
            const msoDepartment = this.value;
            
            if ((department === 'Limpieza' || department === 'Colaboradores') && msoDepartment) {
                // Si se selecciona un departamento MSO para Limpieza/Colaboradores, es MSO
                serviceTypeText.textContent = 'MSO';
                serviceTypeText.className = 'service-type-badge badge-mso';
            }
        });

        // Función para cargar traslados desde Firestore
        function loadTransfers() {
            try {
                showMessage("Conectando a la base de datos...", "info");
                
                // Usar Firestore directamente
                const transfersRef = db.collection('transfers');
                
                // Suscribirse a cambios en tiempo real
                unsubscribeTransfers = transfersRef.orderBy('dateTime', 'asc')
                    .onSnapshot((querySnapshot) => {
                        transfers = [];
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            transfers.push({
                                id: doc.id,
                                ...data,
                                dateTime: normalizeDateToStartOfDay(new Date(data.dateTime))
                            });
                        });
                        
                        renderTransfers();
                        updateSummaries();
                        updateConnectionStatus(true);
                        showMessage("Datos cargados correctamente", "success");
                        
                        // Generar reporte del mes actual por defecto
                        generateReport();
                    }, (error) => {
                        console.error("Error en tiempo real:", error);
                        updateConnectionStatus(false);
                        showMessage("Error de conexión con la base de datos", "error");
                    });

            } catch (e) {
                console.error("Error al cargar datos de Firestore:", e);
                showMessage("Error al cargar datos. Verifica tu conexión a internet.", "error");
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const statusText = connectionStatus.querySelector('span');
            const statusDot = connectionStatus.querySelector('div');
            
            if (connected) {
                statusText.textContent = 'Conectado';
                statusDot.className = 'w-3 h-3 bg-green-500 rounded-full animate-pulse';
            } else {
                statusText.textContent = 'Desconectado';
                statusDot.className = 'w-3 h-3 bg-red-500 rounded-full';
            }
        }

        // Función para guardar un traslado en Firestore
        async function saveTransfer(transferData) {
            try {
                // Determinar tipo de servicio (CCS o MSO) considerando msoDepartment
                const serviceType = getServiceTypeWithMSO(transferData.department, transferData.msoDepartment);
                
                // Convertir fecha a string ISO para Firestore
                const dataToSave = {
                    ...transferData,
                    dateTime: transferData.dateTime.toISOString(),
                    serviceType: serviceType.type,
                    serviceTypeText: serviceType.text
                };
                
                if (editingId) {
                    // Actualizar documento existente
                    await db.collection('transfers').doc(editingId).update(dataToSave);
                    showMessage("¡Traslado actualizado con éxito!", "success");
                } else {
                    // Crear nuevo documento
                    await db.collection('transfers').add(dataToSave);
                    showMessage("¡Traslado registrado con éxito!", "success");
                }
                
                return true;
            } catch (e) {
                console.error("Error al guardar en Firestore:", e);
                showMessage("Error al guardar los datos. Verifica tu conexión.", "error");
                return false;
            }
        }

        // Función para eliminar traslados de Firestore - CORREGIDA
        async function deleteTransfers(ids) {
            try {
                const deletePromises = ids.map(id => {
                    return db.collection('transfers').doc(id).delete();
                });
                
                await Promise.all(deletePromises);
                showMessage("Traslados eliminados con éxito.", "success");
                
                // CORRECCIÓN IMPORTANTE: Actualizar el reporte inmediatamente después de eliminar
                // Esto asegura que los reportes se actualicen en tiempo real
                generateReport();
                
                return true;
            } catch (e) {
                console.error("Error al eliminar de Firestore:", e);
                showMessage("Error al eliminar los datos. Verifica tu conexión.", "error");
                return false;
            }
        }

        // Función para aplicar filtros
        function applyFilters() {
            // Capturar valores de los filtros
            currentFilters.name = filterName.value.trim().toLowerCase();
            currentFilters.department = filterDepartment.value;
            currentFilters.company = filterCompany.value;
            currentFilters.authorizer = filterAuthorizer.value;
            
            // Capturar filtro de costo
            currentFilters.minCost = filterMinCost.value ? parseFloat(filterMinCost.value) : null;
            currentFilters.maxCost = filterMaxCost.value ? parseFloat(filterMaxCost.value) : null;
            
            renderTransfers();
        }

        // Función para limpiar todos los filtros
        function clearAllFilters() {
            filterName.value = '';
            filterDepartment.value = '';
            filterCompany.value = '';
            filterAuthorizer.value = '';
            filterMinCost.value = '';
            filterMaxCost.value = '';
            filterDateRange.value = '';
            dateRangeDisplay.textContent = '';
            
            // Resetear flatpickr
            if (dateRangePicker) {
                dateRangePicker.clear();
            }
            
            // Resetear filtros actuales
            currentFilters = {
                name: '',
                department: '',
                company: '',
                authorizer: '',
                dateStart: null,
                dateEnd: null,
                minCost: null,
                maxCost: null
            };
            
            renderTransfers();
            showMessage("Todos los filtros han sido limpiados", "success");
        }

        // Función para alternar vista compacta/detallada
        function toggleView() {
            isCompactView = !isCompactView;
            toggleViewText.textContent = isCompactView ? 'Vista Compacta' : 'Vista Detallada';
            
            // Actualizar todas las filas visibles
            document.querySelectorAll('.compact-row').forEach(row => {
                if (isCompactView) {
                    row.classList.add('compact-row');
                    row.classList.remove('expanded');
                    row.querySelectorAll('.compact-cell').forEach(cell => {
                        cell.classList.add('compact-cell');
                        cell.classList.remove('expanded');
                    });
                } else {
                    row.classList.remove('compact-row');
                    row.classList.add('expanded');
                    row.querySelectorAll('.compact-cell').forEach(cell => {
                        cell.classList.remove('compact-cell');
                        cell.classList.add('expanded');
                    });
                }
            });
            
            // Resetear filas expandidas
            if (!isCompactView) {
                expandedRows.clear();
            }
        }

        // Función para expandir/contraer fila individual
        function toggleRowExpansion(rowId) {
            const row = document.querySelector(`tr[data-id="${rowId}"]`);
            if (!row) return;
            
            if (expandedRows.has(rowId)) {
                // Contraer
                expandedRows.delete(rowId);
                row.classList.remove('expanded');
                row.querySelectorAll('.compact-cell').forEach(cell => {
                    cell.classList.remove('expanded');
                });
            } else {
                // Expandir
                expandedRows.add(rowId);
                row.classList.add('expanded');
                row.querySelectorAll('.compact-cell').forEach(cell => {
                    cell.classList.add('expanded');
                });
            }
        }

        function renderTransfers() {
            transferTableBody.innerHTML = '';
            selectAllCheckboxes.checked = false;
            expandedRows.clear();

            // Aplicar filtros
            let filteredTransfers = [...transfers];
            
            // Filtrar por nombre/apellido
            if (currentFilters.name) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(currentFilters.name)
                );
            }
            
            // Filtrar por departamento
            if (currentFilters.department) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.department === currentFilters.department
                );
            }
            
            // Filtrar por empresa
            if (currentFilters.company) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.companyName === currentFilters.company
                );
            }
            
            // Filtrar por autorizador
            if (currentFilters.authorizer) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.authorizerName === currentFilters.authorizer
                );
            }
            
            // Filtrar por rango de fechas
            if (currentFilters.dateStart && currentFilters.dateEnd) {
                filteredTransfers = filteredTransfers.filter(transfer => {
                    const transferDate = transfer.dateTime;
                    return transferDate >= currentFilters.dateStart && transferDate <= currentFilters.dateEnd;
                });
            }
            
            // Filtrar por rango de costo
            if (currentFilters.minCost !== null) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.cost >= currentFilters.minCost
                );
            }
            
            if (currentFilters.maxCost !== null) {
                filteredTransfers = filteredTransfers.filter(transfer =>
                    transfer.cost <= currentFilters.maxCost
                );
            }

            // Actualizar contador de resultados
            resultsCount.textContent = filteredTransfers.length;

            // Ordenar por fecha (más reciente primero)
            const sortedTransfers = filteredTransfers.sort((a, b) => b.dateTime.getTime() - a.dateTime.getTime());

            if (sortedTransfers.length === 0) {
                noTransfersMessage.classList.remove('hidden');
            } else {
                noTransfersMessage.classList.add('hidden');
                
                // Detectar si es móvil
                const isMobile = window.innerWidth < 768;
                
                sortedTransfers.forEach((transfer, index) => {
                    const row = document.createElement('tr');
                    row.setAttribute('data-id', transfer.id);
                    
                    const formattedDate = transfer.dateTime.toLocaleDateString('es-ES', {
                        year: 'numeric', month: '2-digit', day: '2-digit'
                    });

                    // Obtener tipo de servicio considerando msoDepartment
                    const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                    
                    if (isMobile) {
                        // Vista móvil: diseño vertical
                        row.innerHTML = `
                            <td data-label="Seleccionar">
                                <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${transfer.id}">
                            </td>
                            <td data-label="Fecha">${formattedDate}</td>
                            <td data-label="Solicitante">${transfer.requesterName}</td>
                            <td data-label="Departamento">${transfer.department || 'N/A'}</td>
                            <td data-label="Tipo Servicio">
                                <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span>
                            </td>
                            <td data-label="Origen">${transfer.originPlace || 'N/A'}</td>
                            <td data-label="Destino">${transfer.destinationPlace || 'N/A'}</td>
                            <td data-label="Empresa">${transfer.companyName || 'N/A'}</td>
                            <td data-label="Costo" class="text-right">$${transfer.cost.toFixed(2)}</td>
                            <td data-label="Acciones">
                                <button onclick="startEditTransfer('${transfer.id}')" 
                                    class="text-inter-primary hover:text-blue-700 font-bold text-xs py-1 px-2 rounded-md border border-inter-primary hover:border-blue-700 transition duration-150">
                                    Editar
                                </button>
                                <div class="mt-2">
                                    <button onclick="toggleRowDetails('${transfer.id}')" class="expand-btn text-xs">
                                        <span id="expandIcon-${transfer.id}">▼</span> Más info
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        // Agregar fila de detalles para móvil
                        const detailsRow = document.createElement('tr');
                        detailsRow.id = `details-${transfer.id}`;
                        detailsRow.classList.add('hidden', 'bg-gray-50');
                        detailsRow.innerHTML = `
                            <td colspan="10" class="p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <strong>Departamento MSO:</strong> ${transfer.msoDepartment || 'N/A'}<br>
                                        <strong>Vuelta Partida:</strong> ${transfer.returnAddress || 'N/A'}<br>
                                        <strong>Vuelta Destino:</strong> ${transfer.returnDestination || 'N/A'}
                                    </div>
                                    <div>
                                        <strong>Autoriza:</strong> ${transfer.authorizerName || 'N/A'}<br>
                                        <strong>Tipo Servicio:</strong> 
                                        <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span><br>
                                        <strong>ID:</strong> ${transfer.id.substring(0, 8)}...
                                    </div>
                                </div>
                            </td>
                        `;
                        transferTableBody.appendChild(row);
                        transferTableBody.appendChild(detailsRow);
                    } else {
                        // Vista escritorio: diseño de tabla normal con filas expandibles
                        const isExpanded = expandedRows.has(transfer.id);
                        const rowClass = isCompactView && !isExpanded ? 'compact-row' : 'expanded';
                        
                        row.innerHTML = `
                            <td class="px-4 py-3 whitespace-nowrap">
                                <input type="checkbox" class="row-checkbox h-4 w-4 text-inter-primary rounded" data-id="${transfer.id}">
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">${formattedDate}</td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.requesterName}
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.department || 'N/A'}
                                ${transfer.msoDepartment ? `<br><small class="text-gray-500">${transfer.msoDepartment}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span class="service-type-badge ${serviceType.badgeClass}">${serviceType.text}</span>
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.originPlace || 'N/A'}
                                ${transfer.returnAddress ? `<br><small class="text-gray-500">Vuelta: ${transfer.returnAddress}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 ${isCompactView && !isExpanded ? 'compact-cell' : 'expanded'}">
                                ${transfer.destinationPlace || 'N/A'}
                                ${transfer.returnDestination ? `<br><small class="text-gray-500">Destino vuelta: ${transfer.returnDestination}</small>` : ''}
                            </td>
                            <td class="px-4 py-3 whitespace-nowrap">${transfer.companyName || 'N/A'}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-right font-medium">$${transfer.cost.toFixed(2)}</td>
                            <td class="px-4 py-3 whitespace-nowrap">
                                <div class="flex flex-col space-y-2">
                                    <button onclick="startEditTransfer('${transfer.id}')" 
                                        class="text-inter-primary hover:text-blue-700 font-bold text-xs py-1 px-2 rounded-md border border-inter-primary hover:border-blue-700 transition duration-150">
                                        Editar
                                    </button>
                                    <button onclick="toggleRowExpansion('${transfer.id}')" class="expand-btn text-xs">
                                        <span id="expandIcon-${transfer.id}">${isExpanded ? '▲' : '▼'}</span> ${isExpanded ? 'Menos' : 'Más'}
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        if (isCompactView && !isExpanded) {
                            row.classList.add('compact-row');
                        } else {
                            row.classList.add('expanded');
                        }
                        
                        transferTableBody.appendChild(row);
                    }
                });
            }
        }

        // Función para mostrar/ocultar detalles en móvil
        function toggleRowDetails(rowId) {
            const detailsRow = document.getElementById(`details-${rowId}`);
            const expandIcon = document.getElementById(`expandIcon-${rowId}`);
            
            if (detailsRow.classList.contains('hidden')) {
                detailsRow.classList.remove('hidden');
                expandIcon.textContent = '▲';
            } else {
                detailsRow.classList.add('hidden');
                expandIcon.textContent = '▼';
            }
        }
        
        function startEditTransfer(id) {
            const transfer = transfers.find(t => t.id === id);
            if (!transfer) {
                showMessage("Error: Traslado no encontrado.", "error");
                return;
            }

            // Cargar datos en el formulario
            requesterNameInput.value = transfer.requesterName;
            departmentInput.value = transfer.department;
            
            // Determinar tipo de servicio para mostrar
            const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
            if (transfer.department) {
                serviceTypeBadge.classList.remove('hidden');
                serviceTypeText.textContent = serviceType.text;
                serviceTypeText.className = `service-type-badge ${serviceType.badgeClass}`;
            }
            
            // Manejar departamentos especiales (Limpieza, Colaboradores, MSO)
            if (transfer.department === 'MSO' || transfer.department === 'Limpieza' || transfer.department === 'Colaboradores') {
                msoDepartmentsContainer.classList.remove('hidden');
                msoDepartmentInput.value = transfer.msoDepartment || '';
                if (transfer.department === 'MSO') {
                    msoDepartmentInput.required = true;
                } else {
                    msoDepartmentInput.required = false;
                }
            } else {
                msoDepartmentsContainer.classList.add('hidden');
                msoDepartmentInput.required = false;
            }
            
            originPlaceInput.value = transfer.originPlace || '';
            destinationPlaceInput.value = transfer.destinationPlace || '';
            returnAddressInput.value = transfer.returnAddress || '';
            returnDestinationInput.value = transfer.returnDestination || '';
            transferDateInput.value = transfer.dateTime.toISOString().slice(0, 10);
            costInput.value = transfer.cost.toFixed(2);
            authorizerNameInput.value = transfer.authorizerName;
            companyNameInput.value = transfer.companyName;

            // Establecer el modo edición
            editingId = id;
            submitButton.textContent = 'Guardar Cambios';
            cancelEditBtn.classList.remove('hidden');

            // Desplazarse al formulario
            registerSection.scrollIntoView({ behavior: 'smooth' });
            showMessage(`Modo Edición: Editando traslado de ${transfer.requesterName}.`, "info");
        }

        function cancelEdit() {
            editingId = null;
            transferForm.reset();
            submitButton.textContent = 'Registrar Traslado';
            cancelEditBtn.classList.add('hidden');
            msoDepartmentsContainer.classList.add('hidden');
            msoDepartmentInput.required = false;
            serviceTypeBadge.classList.add('hidden');
            transferDateInput.value = new Date().toISOString().slice(0, 10);
            showMessage("Modo de registro restaurado.", "success");
        }

        cancelEditBtn.addEventListener('click', cancelEdit);

        function updateSummaries() {
            const now = new Date();
            const todayStart = normalizeDateToStartOfDay(now);
            const dailyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() === todayStart.getTime());
            const dailyTotal = dailyTransfers.reduce((sum, t) => sum + t.cost, 0);
            dailyTotalSpan.textContent = `$${dailyTotal.toFixed(2)}`;
            
            const dayOfWeek = (now.getDay() + 6) % 7;
            const startOfWeek = normalizeDateToStartOfDay(now);
            startOfWeek.setDate(now.getDate() - dayOfWeek);
            const weeklyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfWeek.getTime());
            const weeklyTotal = weeklyTransfers.reduce((sum, t) => sum + t.cost, 0);
            weeklyTotalSpan.textContent = `$${weeklyTotal.toFixed(2)}`;

            const startOfMonth = normalizeDateToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
            const monthlyTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            const monthlyTotal = monthlyTransfers.reduce((sum, t) => sum + t.cost, 0);
            monthlyTotalSpan.textContent = `$${monthlyTotal.toFixed(2)}`;

            const startOfYear = normalizeDateToStartOfDay(new Date(now.getFullYear(), 0, 1));
            const annualTransfers = transfers.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime());
            const annualTotal = annualTransfers.reduce((sum, t) => sum + t.cost, 0);
            annualTotalSpan.textContent = `$${annualTotal.toFixed(2)}`;

            updateCompanyCharts();
            updateDepartmentCharts();
            renderDepartmentStats();
        }

        function updateCompanyCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyCompanyExpenses = {};
            monthlyTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                monthlyCompanyExpenses[company] = (monthlyCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualCompanyExpenses = {};
            annualTransfers.forEach(transfer => {
                const company = transfer.companyName || 'Desconocido';
                annualCompanyExpenses[company] = (annualCompanyExpenses[company] || 0) + transfer.cost;
            });

            // Gráfico mensual
            const monthlyCompanyLabels = Object.keys(monthlyCompanyExpenses);
            const monthlyCompanyData = Object.values(monthlyCompanyExpenses);
            
            if (monthlyCompanyChart) { monthlyCompanyChart.destroy(); }
            monthlyCompanyChart = new Chart(monthlyCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyCompanyLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyCompanyData,
                        backgroundColor: '#5CE1E6',
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });

            // Gráfico anual
            const annualCompanyLabels = Object.keys(annualCompanyExpenses);
            const annualCompanyData = Object.values(annualCompanyExpenses);
            
            if (annualCompanyChart) { annualCompanyChart.destroy(); }
            annualCompanyChart = new Chart(annualCompanyChartCtx, {
                type: 'bar',
                data: {
                    labels: annualCompanyLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualCompanyData,
                        backgroundColor: '#005BAA',
                        borderColor: '#003366',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#FFFFFF',
                            font: { weight: 'bold', size: 10 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Empresa de Traslado', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { font: { family: 'Inter' } }
                        }
                    }
                }
            });
        }

        function updateDepartmentCharts() {
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            // Datos mensuales
            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const monthlyDepartmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                monthlyDepartmentExpenses[department] = (monthlyDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Datos anuales
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );
            const annualDepartmentExpenses = {};
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                annualDepartmentExpenses[department] = (annualDepartmentExpenses[department] || 0) + transfer.cost;
            });

            // Gráfico mensual
            const monthlyDepartmentLabels = Object.keys(monthlyDepartmentExpenses);
            const monthlyDepartmentData = Object.values(monthlyDepartmentExpenses);
            
            if (monthlyDepartmentChart) { monthlyDepartmentChart.destroy(); }
            monthlyDepartmentChart = new Chart(monthlyDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: monthlyDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Mensual ($)',
                        data: monthlyDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });

            // Gráfico anual
            const annualDepartmentLabels = Object.keys(annualDepartmentExpenses);
            const annualDepartmentData = Object.values(annualDepartmentExpenses);
            
            if (annualDepartmentChart) { annualDepartmentChart.destroy(); }
            annualDepartmentChart = new Chart(annualDepartmentChartCtx, {
                type: 'bar',
                data: {
                    labels: annualDepartmentLabels,
                    datasets: [{
                        label: 'Gasto Anual ($)',
                        data: annualDepartmentData,
                        backgroundColor: [
                            '#005BAA', '#5CE1E6', '#FDD000', '#FF6384', '#36A2EB', 
                            '#FF9F40', '#4BC0C0', '#9966FF', '#C9CBCF', '#FF99C8'
                        ],
                        borderColor: '#005BAA',
                        borderWidth: 1,
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: (value) => `$${value.toFixed(2)}`,
                            color: '#000000',
                            font: { weight: 'bold', size: 9 }
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `$${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true, text: 'Costo (USD $)', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: {
                                callback: function (value) { return `$${value.toFixed(0)}`; },
                                font: { family: 'Inter' }
                            }
                        },
                        x: {
                            title: {
                                display: true, text: 'Departamento', font: { family: 'Inter', size: 14, weight: 'bold' }, color: '#005BAA'
                            },
                            ticks: { 
                                font: { family: 'Inter', size: 10 },
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        function renderDepartmentStats() {
            departmentStatsTableBody.innerHTML = '';
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const startOfYear = normalizeDateToStartOfDay(new Date(currentYear, 0, 1));

            const monthlyTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime()
            );
            const annualTransfers = transfers.filter(t => 
                normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfYear.getTime()
            );

            const departmentStats = {};

            // Procesar datos mensuales
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        serviceType: serviceType.text,
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].monthlyCount++;
                departmentStats[department].monthlyCost += transfer.cost;
            });

            // Procesar datos anuales
            annualTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                if (!departmentStats[department]) {
                    departmentStats[department] = {
                        serviceType: serviceType.text,
                        monthlyCount: 0,
                        monthlyCost: 0,
                        annualCount: 0,
                        annualCost: 0
                    };
                }
                departmentStats[department].annualCount++;
                departmentStats[department].annualCost += transfer.cost;
            });

            const departments = Object.keys(departmentStats).sort();
            
            if (departments.length === 0) {
                noStatsMessage.classList.remove('hidden');
            } else {
                noStatsMessage.classList.add('hidden');
                departments.forEach(department => {
                    const stats = departmentStats[department];
                    const badgeClass = stats.serviceType === 'MSO' ? 'badge-mso' : 'badge-ccs';
                    
                    const row = document.createElement('tr');
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${department}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                            <span class="service-type-badge ${badgeClass}">${stats.serviceType}</span>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${stats.monthlyCount}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${stats.monthlyCost.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${stats.annualCount}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm text-gray-900">$${stats.annualCost.toFixed(2)}</td>
                    `;
                    departmentStatsTableBody.appendChild(row);
                });
            }
        }

        // NUEVA: Función para obtener las fechas según el tipo de periodo seleccionado - CORREGIDA
        function getReportDates() {
            const periodType = reportPeriodType.value;
            const year = parseInt(reportYearSelect.value);
            
            let startDate, endDate;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    startDate = new Date(year, month, 1);
                    endDate = new Date(year, month + 1, 0);
                    break;
                    
                case 'week':
                    // Obtener valores de fecha del formulario
                    const weekStartStr = reportWeekStart.value;
                    const weekEndStr = reportWeekEnd.value;
                    
                    if (!weekStartStr || !weekEndStr) {
                        // Si no hay fechas seleccionadas, usar la semana actual
                        setCurrentWeek();
                        startDate = new Date(reportWeekStart.value);
                        endDate = new Date(reportWeekEnd.value);
                    } else {
                        startDate = new Date(weekStartStr);
                        endDate = new Date(weekEndStr);
                    }
                    break;
                    
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    
                    if (fortnight === 'first') {
                        startDate = new Date(year, fortnightMonth, 1);
                        endDate = new Date(year, fortnightMonth, 15);
                    } else {
                        startDate = new Date(year, fortnightMonth, 16);
                        endDate = new Date(year, fortnightMonth + 1, 0);
                    }
                    break;
                    
                case 'custom':
                    // Obtener valores de fecha del formulario
                    const customStartStr = reportCustomStart.value;
                    const customEndStr = reportCustomEnd.value;
                    
                    if (!customStartStr || !customEndStr) {
                        // Si no hay fechas seleccionadas, usar últimos 30 días
                        setLast30Days();
                        startDate = new Date(reportCustomStart.value);
                        endDate = new Date(reportCustomEnd.value);
                    } else {
                        startDate = new Date(customStartStr);
                        endDate = new Date(customEndStr);
                    }
                    break;
            }
            
            // Asegurarse de que las fechas sean válidas
            if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                // Si las fechas no son válidas, usar el mes actual como respaldo
                const now = new Date();
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            }
            
            // Normalizar fechas (inicio a las 00:00, fin a las 23:59:59)
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            return { startDate, endDate };
        }

        // NUEVA: Función para actualizar el texto del periodo - CORREGIDA
        function updatePeriodText() {
            const { startDate, endDate } = getReportDates();
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            let periodTextStr = '';
            
            switch(reportPeriodType.value) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    periodTextStr = `${monthNames[month]} ${reportYearSelect.value}`;
                    break;
                    
                case 'week':
                    // Usar el formato dd/mm/yyyy para fechas
                    const formatDate = (date) => {
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    };
                    periodTextStr = `Semana del ${formatDate(startDate)} al ${formatDate(endDate)}`;
                    break;
                    
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const monthName = monthNames[fortnightMonth];
                    const endDay = endDate.getDate();
                    if (fortnight === 'first') {
                        periodTextStr = `Primera quincena de ${monthName} ${reportYearSelect.value} (1-15)`;
                    } else {
                        periodTextStr = `Segunda quincena de ${monthName} ${reportYearSelect.value} (16-${endDay})`;
                    }
                    break;
                    
                case 'custom':
                    // Usar el formato dd/mm/yyyy para fechas personalizadas
                    const formatDateCustom = (date) => {
                        const day = date.getDate().toString().padStart(2, '0');
                        const month = (date.getMonth() + 1).toString().padStart(2, '0');
                        const year = date.getFullYear();
                        return `${day}/${month}/${year}`;
                    };
                    periodTextStr = `Personalizado: ${formatDateCustom(startDate)} - ${formatDateCustom(endDate)}`;
                    break;
            }
            
            periodText.textContent = periodTextStr;
            periodDisplay.classList.remove('hidden');
            
            // Actualizar objeto currentReportPeriod
            currentReportPeriod = {
                type: reportPeriodType.value,
                startDate: normalizeDateToStartOfDay(startDate),
                endDate: normalizeDateToStartOfDay(endDate),
                month: reportPeriodType.value === 'month' ? parseInt(reportMonthSelect.value) : null,
                year: parseInt(reportYearSelect.value)
            };
        }

        // NUEVA: Función para manejar cambio de tipo de periodo
        function handlePeriodTypeChange() {
            const periodType = reportPeriodType.value;
            
            // Ocultar todos los contenedores
            monthYearContainer.classList.add('hidden');
            weekContainer.classList.add('hidden');
            fortnightContainer.classList.add('hidden');
            customRangeContainer.classList.add('hidden');
            
            // Mostrar el contenedor correspondiente
            switch(periodType) {
                case 'month':
                    monthYearContainer.classList.remove('hidden');
                    break;
                case 'week':
                    weekContainer.classList.remove('hidden');
                    // Establecer semana actual por defecto si no hay fechas
                    if (!reportWeekStart.value || !reportWeekEnd.value) {
                        setCurrentWeek();
                    }
                    break;
                case 'fortnight':
                    fortnightContainer.classList.remove('hidden');
                    // Establecer mes actual por defecto
                    const currentMonth = new Date().getMonth();
                    reportFortnightMonth.value = currentMonth.toString();
                    break;
                case 'custom':
                    customRangeContainer.classList.remove('hidden');
                    // Establecer últimos 30 días por defecto si no hay fechas
                    if (!reportCustomStart.value || !reportCustomEnd.value) {
                        setLast30Days();
                    }
                    break;
            }
            
            // Actualizar inmediatamente el texto del periodo
            updatePeriodText();
        }

        // NUEVA: Función para establecer semana actual
        function setCurrentWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // 0 = Domingo, 1 = Lunes, etc.
            
            // Ajustar para que la semana empiece el Lunes
            const startOfWeek = new Date(today);
            const diff = dayOfWeek === 0 ? -6 : 1 - dayOfWeek; // Si es domingo, retroceder 6 días
            startOfWeek.setDate(today.getDate() + diff);
            
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // Formatear fechas como YYYY-MM-DD para el input type="date"
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            reportWeekStart.value = formatDateForInput(startOfWeek);
            reportWeekEnd.value = formatDateForInput(endOfWeek);
            
            // Actualizar el texto del periodo inmediatamente
            updatePeriodText();
        }

        // NUEVA: Función para establecer últimos 30 días
        function setLast30Days() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            
            // Formatear fechas como YYYY-MM-DD para el input type="date"
            const formatDateForInput = (date) => {
                return date.toISOString().split('T')[0];
            };
            
            reportCustomStart.value = formatDateForInput(thirtyDaysAgo);
            reportCustomEnd.value = formatDateForInput(today);
            
            // Actualizar el texto del periodo inmediatamente
            updatePeriodText();
        }

        // Función para generar reporte financiero MODIFICADA - CORREGIDA
        function generateReport() {
            // Obtener fechas del formulario
            const { startDate, endDate } = getReportDates();
            
            // Actualizar texto del periodo (esto mostrará las fechas exactas)
            updatePeriodText();
            
            // Mostrar mensaje de depuración
            console.log("Generando reporte para:", {
                startDate: startDate.toLocaleDateString('es-ES'),
                endDate: endDate.toLocaleDateString('es-ES'),
                transfersCount: transfers.length
            });
            
            // Filtrar traslados por periodo seleccionado
            const filteredTransfers = transfers.filter(transfer => {
                const transferDate = transfer.dateTime;
                // Asegurarse de que las fechas se comparen correctamente
                const transferDateObj = new Date(transferDate);
                transferDateObj.setHours(0, 0, 0, 0);
                
                const startDateObj = new Date(startDate);
                startDateObj.setHours(0, 0, 0, 0);
                
                const endDateObj = new Date(endDate);
                endDateObj.setHours(23, 59, 59, 999);
                
                return transferDateObj >= startDateObj && transferDateObj <= endDateObj;
            });
            
            console.log("Traslados filtrados:", filteredTransfers.length);
            
            // Calcular totales por departamento
            const departmentTotals = {};
            let totalCCSAmount = 0;
            let totalMSOAmount = 0;
            
            reportDepartments.forEach(dept => {
                departmentTotals[dept.code] = 0;
            });
            
            filteredTransfers.forEach(transfer => {
                const department = transfer.department;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, transfer.msoDepartment);
                
                if (department && departmentTotals.hasOwnProperty(department)) {
                    departmentTotals[department] += cost;
                    
                    // Sumar a CCS o MSO según corresponda
                    if (serviceType.type === 'MSO') {
                        totalMSOAmount += cost;
                    } else {
                        totalCCSAmount += cost;
                    }
                }
            });
            
            // Actualizar tabla de departamentos
            departmentsReportTableBody.innerHTML = '';
            reportDepartments.forEach(dept => {
                const amount = departmentTotals[dept.code] || 0;
                const isMSO = dept.serviceType === 'MSO';
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${dept.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">${isMSO ? 'MSO' : 'UN CCS'}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">$${amount.toFixed(2)}</td>
                `;
                departmentsReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de departamentos
            totalCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            totalMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            const totalCCSMSOTotal = totalCCSAmount + totalMSOAmount;
            totalCCSMSO.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
            
            // Calcular totales por empresa - DISCRIMINADO POR CCS Y MSO
            const companyStats = {};
            let totalCCSServicesCount = 0;
            let totalCCSAmountServices = 0;
            let totalMSOServicesCount = 0;
            let totalMSOAmountServices = 0;
            
            // Inicializar estructura para cada empresa
            reportCompanies.forEach(company => {
                companyStats[company.code] = {
                    name: company.name,
                    ccsCount: 0,
                    ccsAmount: 0,
                    msoCount: 0,
                    msoAmount: 0,
                    totalCount: 0,
                    totalAmount: 0
                };
            });
            
            // Procesar cada traslado
            filteredTransfers.forEach(transfer => {
                const company = transfer.companyName;
                const department = transfer.department;
                const msoDepartment = transfer.msoDepartment;
                const cost = transfer.cost || 0;
                const serviceType = getServiceTypeWithMSO(department, msoDepartment);
                
                if (company && companyStats.hasOwnProperty(company)) {
                    // Determinar si es CCS o MSO
                    if (serviceType.type === 'MSO') {
                        companyStats[company].msoCount++;
                        companyStats[company].msoAmount += cost;
                        totalMSOServicesCount++;
                        totalMSOAmountServices += cost;
                    } else {
                        companyStats[company].ccsCount++;
                        companyStats[company].ccsAmount += cost;
                        totalCCSServicesCount++;
                        totalCCSAmountServices += cost;
                    }
                    
                    // Actualizar totales
                    companyStats[company].totalCount++;
                    companyStats[company].totalAmount += cost;
                }
            });
            
            // Actualizar tabla de empresas
            companiesReportTableBody.innerHTML = '';
            
            reportCompanies.forEach(company => {
                const stats = companyStats[company.code];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td class="px-6 py-3 text-left text-sm font-medium text-gray-900">${company.name}</td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">
                        ${stats.ccsCount} servicio${stats.ccsCount !== 1 ? 's' : ''}<br>
                        <span class="font-medium">$${stats.ccsAmount.toFixed(2)}</span>
                    </td>
                    <td class="px-6 py-3 text-left text-sm text-gray-900">
                        ${stats.msoCount} servicio${stats.msoCount !== 1 ? 's' : ''}<br>
                        <span class="font-medium">$${stats.msoAmount.toFixed(2)}</span>
                    </td>
                    <td class="px-6 py-3 text-left text-sm font-medium text-gray-900">
                        ${stats.totalCount} servicio${stats.totalCount !== 1 ? 's' : ''}<br>
                        <span class="font-bold">$${stats.totalAmount.toFixed(2)}</span>
                    </td>
                `;
                companiesReportTableBody.appendChild(row);
            });
            
            // Actualizar totales de empresas
            totalCCSServices.textContent = `${totalCCSServicesCount} servicio${totalCCSServicesCount !== 1 ? 's' : ''} - $${totalCCSAmountServices.toFixed(2)}`;
            totalMSOServices.textContent = `${totalMSOServicesCount} servicio${totalMSOServicesCount !== 1 ? 's' : ''} - $${totalMSOAmountServices.toFixed(2)}`;
            const totalServicesCount = totalCCSServicesCount + totalMSOServicesCount;
            const totalServicesAmount = totalCCSAmountServices + totalMSOAmountServices;
            totalCompanies.textContent = `${totalServicesCount} servicio${totalServicesCount !== 1 ? 's' : ''} - $${totalServicesAmount.toFixed(2)}`;
            
            // Actualizar resumen por unidad
            unitCCS.textContent = `$${totalCCSAmount.toFixed(2)}`;
            unitMSO.textContent = `$${totalMSOAmount.toFixed(2)}`;
            unitTotal.textContent = `$${totalCCSMSOTotal.toFixed(2)}`;
            
            showMessage(`Reporte generado para el periodo: ${periodText.textContent}`, "success");
        }

        // Función para exportar reporte a Excel MODIFICADA
        function exportReportToExcel() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Crear workbook
            const workbook = XLSX.utils.book_new();
            
            // Hoja 1: Departamentos
            const departmentsData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO'],
                ['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']
            ];
            
            // Agregar filas de departamentos
            reportDepartments.forEach(dept => {
                const amount = parseFloat(document.querySelector(`#departmentsReportTableBody tr:nth-child(${reportDepartments.indexOf(dept) + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                const isMSO = dept.serviceType === 'MSO';
                departmentsData.push([dept.name, isMSO ? 'MSO' : 'UN CCS', amount]);
            });
            
            // Agregar totales
            departmentsData.push(['TOTAL CCS', '', parseFloat(totalCCS.textContent.replace('$', '')) || 0]);
            departmentsData.push(['MSO', 'MSO', parseFloat(totalMSO.textContent.replace('$', '')) || 0]);
            departmentsData.push(['TOTAL, CCS + MSO', '', parseFloat(totalCCSMSO.textContent.replace('$', '')) || 0]);
            
            const departmentsSheet = XLSX.utils.aoa_to_sheet(departmentsData);
            XLSX.utils.book_append_sheet(workbook, departmentsSheet, 'Departamentos');
            
            // Hoja 2: Empresas - MEJORADA con formato separado
            const companiesData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO'],
                ['EMPRESA', 'SERVICIOS A CCS', 'SERVICIOS A MSO', 'TOTAL']
            ];
            
            // Agregar filas de empresas con formato mejorado
            reportCompanies.forEach((company, index) => {
                const row = document.querySelector(`#companiesReportTableBody tr:nth-child(${index + 1})`);
                if (row) {
                    const empresa = row.cells[0].textContent;
                    const ccsCell = row.cells[1];
                    const msoCell = row.cells[2];
                    const totalCell = row.cells[3];
                    
                    // Extraer datos de los spans
                    const ccsText = ccsCell.textContent.split('\n');
                    const msoText = msoCell.textContent.split('\n');
                    const totalText = totalCell.textContent.split('\n');
                    
                    companiesData.push([
                        empresa,
                        `${ccsText[0]}\n${ccsText[1] || ''}`,
                        `${msoText[0]}\n${msoText[1] || ''}`,
                        `${totalText[0]}\n${totalText[1] || ''}`
                    ]);
                }
            });
            
            // Agregar totales con formato
            const totalCCSServicesText = totalCCSServices.textContent;
            const totalMSOServicesText = totalMSOServices.textContent;
            const totalCompaniesText = totalCompanies.textContent;
            
            companiesData.push([
                'TOTALES', 
                totalCCSServicesText.replace(' - ', '\n'),
                totalMSOServicesText.replace(' - ', '\n'),
                totalCompaniesText.replace(' - ', '\n')
            ]);
            
            const companiesSheet = XLSX.utils.aoa_to_sheet(companiesData);
            
            // Ajustar ancho de columnas
            const wscols = [
                {wch: 20}, // Empresa
                {wch: 25}, // Servicios CCS
                {wch: 25}, // Servicios MSO
                {wch: 25}  // Total
            ];
            companiesSheet['!cols'] = wscols;
            
            XLSX.utils.book_append_sheet(workbook, companiesSheet, 'Empresas');
            
            // Hoja 3: Resumen por unidad
            const unitData = [
                ['PERIODO:', periodText.textContent],
                [],
                ['RESUMEN POR UNIDAD'],
                ['UNIDAD', 'IMPORTE'],
                ['CCS', parseFloat(unitCCS.textContent.replace('$', '')) || 0],
                ['MSO', parseFloat(unitMSO.textContent.replace('$', '')) || 0],
                ['TOTAL', parseFloat(unitTotal.textContent.replace('$', '')) || 0]
            ];
            
            const unitSheet = XLSX.utils.aoa_to_sheet(unitData);
            XLSX.utils.book_append_sheet(workbook, unitSheet, 'Resumen Unidad');
            
            // Generar nombre de archivo según el tipo de periodo
            let fileName = '';
            const periodType = reportPeriodType.value;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    fileName = `Reporte_Mensual_${monthNames[month]}_${reportYearSelect.value}.xlsx`;
                    break;
                case 'week':
                    const weekStart = new Date(reportWeekStart.value).toISOString().slice(0,10);
                    const weekEnd = new Date(reportWeekEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Semanal_${weekStart}_a_${weekEnd}.xlsx`;
                    break;
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const fortnightText = fortnight === 'first' ? 'PrimeraQuincena' : 'SegundaQuincena';
                    fileName = `Reporte_Quincena_${fortnightText}_${monthNames[fortnightMonth]}_${reportYearSelect.value}.xlsx`;
                    break;
                case 'custom':
                    const customStart = new Date(reportCustomStart.value).toISOString().slice(0,10);
                    const customEnd = new Date(reportCustomEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Personalizado_${customStart}_a_${customEnd}.xlsx`;
                    break;
            }
            
            // Descargar archivo
            XLSX.writeFile(workbook, fileName);
            
            showMessage(`Reporte exportado a Excel: ${fileName}`, "success");
        }

        // Función para exportar reporte a PDF MODIFICADA con formato mejorado
        function exportReportToPDF() {
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                               'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            
            // Crear nuevo documento PDF
            const doc = new jsPDF('p', 'mm', 'a4');
            
            // Título principal
            doc.setFontSize(16);
            doc.setTextColor(0, 91, 170);
            doc.text('REPORTE FINANCIERO DE TRASLADOS', 105, 20, null, null, 'center');
            
            // Periodo
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text('PERIODO: ' + periodText.textContent, 105, 30, null, null, 'center');
            
            let yPos = 40;
            
            // Sección 1: Departamentos que utilizan servicio de traslado
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('DEPARTAMENTOS QUE UTILIZAN SERVICIO DE TRASLADO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de departamentos
            const departmentsData = [];
            reportDepartments.forEach(dept => {
                const amount = parseFloat(document.querySelector(`#departmentsReportTableBody tr:nth-child(${reportDepartments.indexOf(dept) + 1}) td:last-child`).textContent.replace('$', '')) || 0;
                const isMSO = dept.serviceType === 'MSO';
                departmentsData.push([
                    dept.name,
                    isMSO ? 'MSO' : 'UN CCS',
                    `$${amount.toFixed(2)}`
                ]);
            });
            
            // Agregar totales a la tabla
            departmentsData.push([
                'TOTAL CCS',
                '',
                totalCCS.textContent
            ]);
            departmentsData.push([
                'MSO',
                'MSO',
                totalMSO.textContent
            ]);
            departmentsData.push([
                'TOTAL, CCS + MSO',
                '',
                totalCCSMSO.textContent
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['DEPARTAMENTOS', 'UN CCS', 'IMPORTE']],
                body: departmentsData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 91, 170], 
                    textColor: [255, 255, 255],
                    fontSize: 10
                },
                bodyStyles: { fontSize: 9 },
                columnStyles: {
                    0: { cellWidth: 70 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 40 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Sección 2: Empresas proveedoras - MEJORADA con formato de dos líneas
            if (yPos > 220) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('EMPRESAS PROVEEDORAS DE SERVICIO CCS Y MSO', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de empresas con formato de dos líneas
            const companiesData = [];
            
            // Procesar cada empresa
            reportCompanies.forEach((company, index) => {
                const row = document.querySelector(`#companiesReportTableBody tr:nth-child(${index + 1})`);
                if (row) {
                    const empresa = row.cells[0].textContent;
                    const ccsCell = row.cells[1];
                    const msoCell = row.cells[2];
                    const totalCell = row.cells[3];
                    
                    // Extraer datos como dos líneas separadas
                    const ccsLines = ccsCell.innerHTML.replace(/<br>/g, '\n').split('\n');
                    const msoLines = msoCell.innerHTML.replace(/<br>/g, '\n').split('\n');
                    const totalLines = totalCell.innerHTML.replace(/<br>/g, '\n').split('\n');
                    
                    companiesData.push([
                        empresa,
                        `${ccsLines[0] || ''}\n${ccsLines[1] || ''}`,
                        `${msoLines[0] || ''}\n${msoLines[1] || ''}`,
                        `${totalLines[0] || ''}\n${totalLines[1] || ''}`
                    ]);
                }
            });
            
            // Agregar totales con formato de dos líneas
            const totalCCSServicesText = totalCCSServices.textContent;
            const totalMSOServicesText = totalMSOServices.textContent;
            const totalCompaniesText = totalCompanies.textContent;
            
            companiesData.push([
                'TOTALES',
                totalCCSServicesText.replace(' - ', '\n'),
                totalMSOServicesText.replace(' - ', '\n'),
                totalCompaniesText.replace(' - ', '\n')
            ]);
            
            doc.autoTable({
                startY: yPos,
                head: [['EMPRESA', 'SERVICIOS A CCS', 'SERVICIOS A MSO', 'TOTAL']],
                body: companiesData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [92, 225, 230], 
                    textColor: [0, 0, 0],
                    fontSize: 9
                },
                bodyStyles: { 
                    fontSize: 8,
                    cellPadding: 2,
                    lineHeight: 1.2
                },
                columnStyles: {
                    0: { cellWidth: 35 },
                    1: { cellWidth: 40 },
                    2: { cellWidth: 40 },
                    3: { cellWidth: 35 }
                },
                styles: {
                    overflow: 'linebreak',
                    cellPadding: 2,
                    lineWidth: 0.1,
                    lineColor: [200, 200, 200]
                },
                didDrawCell: function(data) {
                    // Centrar verticalmente el contenido de dos líneas
                    if (data.column.index > 0 && data.cell.section === 'body') {
                        const lines = data.cell.text[0].split('\n');
                        if (lines.length > 1) {
                            doc.setFontSize(7);
                            const textHeight = 7;
                            const cellHeight = data.cell.height;
                            const totalTextHeight = lines.length * textHeight;
                            const startY = data.cell.y + (cellHeight - totalTextHeight) / 2 + textHeight;
                            
                            lines.forEach((line, i) => {
                                doc.text(line.trim(), data.cell.x + 2, startY + (i * textHeight));
                            });
                            
                            return false; // Evitar que autoTable dibuje el texto por defecto
                        }
                    }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            yPos = doc.autoTable.previous.finalY + 15;
            
            // Sección 3: Resumen por unidad
            if (yPos > 250) {
                doc.addPage();
                yPos = 20;
            }
            
            doc.setFontSize(14);
            doc.setTextColor(0, 91, 170);
            doc.text('RESUMEN POR UNIDAD', 105, yPos, null, null, 'center');
            yPos += 10;
            
            // Tabla de resumen por unidad
            const unitData = [
                ['CCS', unitCCS.textContent],
                ['MSO', unitMSO.textContent],
                ['TOTAL', unitTotal.textContent]
            ];
            
            doc.autoTable({
                startY: yPos,
                head: [['UNIDAD', 'IMPORTE']],
                body: unitData,
                theme: 'striped',
                headStyles: { 
                    fillColor: [0, 91, 170], 
                    textColor: [255, 255, 255],
                    fontSize: 10
                },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    0: { cellWidth: 80 },
                    1: { cellWidth: 50 }
                },
                didDrawPage: function(data) {
                    // Footer
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Página ' + doc.internal.getNumberOfPages(), data.settings.margin.left, doc.internal.pageSize.height - 10);
                }
            });
            
            // Información de generación
            const finalY = doc.autoTable.previous.finalY + 20;
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generado el: ${new Date().toLocaleDateString('es-ES')}`, 105, finalY, null, null, 'center');
            doc.text('Sistema de Control de Traslados de Taxi - Inter', 105, finalY + 5, null, null, 'center');
            
            // Generar nombre de archivo según el tipo de periodo
            let fileName = '';
            const periodType = reportPeriodType.value;
            
            switch(periodType) {
                case 'month':
                    const month = parseInt(reportMonthSelect.value);
                    fileName = `Reporte_Mensual_${monthNames[month]}_${reportYearSelect.value}.pdf`;
                    break;
                case 'week':
                    const weekStart = new Date(reportWeekStart.value).toISOString().slice(0,10);
                    const weekEnd = new Date(reportWeekEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Semanal_${weekStart}_a_${weekEnd}.pdf`;
                    break;
                case 'fortnight':
                    const fortnightMonth = parseInt(reportFortnightMonth.value);
                    const fortnight = reportFortnight.value;
                    const fortnightText = fortnight === 'first' ? 'PrimeraQuincena' : 'SegundaQuincena';
                    fileName = `Reporte_Quincena_${fortnightText}_${monthNames[fortnightMonth]}_${reportYearSelect.value}.pdf`;
                    break;
                case 'custom':
                    const customStart = new Date(reportCustomStart.value).toISOString().slice(0,10);
                    const customEnd = new Date(reportCustomEnd.value).toISOString().slice(0,10);
                    fileName = `Reporte_Personalizado_${customStart}_a_${customEnd}.pdf`;
                    break;
            }
            
            // Guardar PDF
            doc.save(fileName);
            
            showMessage(`Reporte exportado a PDF: ${fileName}`, "success");
        }

        // Event Listeners para pestañas
        tabDashboard.addEventListener('click', () => {
            tabDashboard.classList.add('active', 'bg-inter-primary', 'text-white');
            tabDashboard.classList.remove('bg-gray-200', 'text-gray-700');
            tabReports.classList.remove('active', 'bg-inter-primary', 'text-white');
            tabReports.classList.add('bg-gray-200', 'text-gray-700');
            dashboardContent.classList.remove('hidden');
            reportsContent.classList.add('hidden');
        });

        tabReports.addEventListener('click', () => {
            tabReports.classList.add('active', 'bg-inter-primary', 'text-white');
            tabReports.classList.remove('bg-gray-200', 'text-gray-700');
            tabDashboard.classList.remove('active', 'bg-inter-primary', 'text-white');
            tabDashboard.classList.add('bg-gray-200', 'text-gray-700');
            reportsContent.classList.remove('hidden');
            dashboardContent.classList.add('hidden');
            generateReport();
        });

        // Event Listeners para filtros MEJORADOS
        toggleFiltersBtn.addEventListener('click', () => {
            if (filtersSection.classList.contains('collapsed')) {
                filtersSection.classList.remove('collapsed');
                filtersSection.classList.add('expanded');
                toggleFiltersText.textContent = 'Ocultar Filtros';
                toggleFiltersIcon.textContent = '▲';
            } else {
                filtersSection.classList.remove('expanded');
                filtersSection.classList.add('collapsed');
                toggleFiltersText.textContent = 'Mostrar Filtros';
                toggleFiltersIcon.textContent = '▼';
            }
        });

        applyFiltersBtn.addEventListener('click', applyFilters);
        clearAllFiltersBtn.addEventListener('click', clearAllFilters);
        toggleViewBtn.addEventListener('click', toggleView);

        // Event Listeners para filtros en tiempo real
        filterName.addEventListener('input', debounce(applyFilters, 300));
        filterDepartment.addEventListener('change', applyFilters);
        filterCompany.addEventListener('change', applyFilters);
        filterAuthorizer.addEventListener('change', applyFilters);
        filterMinCost.addEventListener('input', debounce(applyFilters, 500));
        filterMaxCost.addEventListener('input', debounce(applyFilters, 500));

        // Función debounce para evitar múltiples llamadas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // NUEVOS Event Listeners para reportes
        reportPeriodType.addEventListener('change', handlePeriodTypeChange);
        reportMonthSelect.addEventListener('change', updatePeriodText);
        reportYearSelect.addEventListener('change', updatePeriodText);
        reportWeekStart.addEventListener('change', updatePeriodText);
        reportWeekEnd.addEventListener('change', updatePeriodText);
        reportFortnight.addEventListener('change', updatePeriodText);
        reportFortnightMonth.addEventListener('change', updatePeriodText);
        reportCustomStart.addEventListener('change', updatePeriodText);
        reportCustomEnd.addEventListener('change', updatePeriodText);
        
        setCurrentWeekBtn.addEventListener('click', setCurrentWeek);
        setLast30DaysBtn.addEventListener('click', setLast30Days);
        
        generateReportBtn.addEventListener('click', generateReport);
        exportReportExcelBtn.addEventListener('click', exportReportToExcel);
        exportReportPDFBtn.addEventListener('click', exportReportToPDF);

        // Event Listeners del Dashboard
        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = submitButton;
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Guardando...';
            document.body.classList.add('loading');

            try {
                const transferData = {
                    requesterName: requesterNameInput.value.trim(),
                    department: departmentInput.value,
                    msoDepartment: msoDepartmentInput.value || '',
                    originPlace: originPlaceInput.value.trim(),
                    destinationPlace: destinationPlaceInput.value.trim(),
                    returnAddress: returnAddressInput.value.trim(),
                    returnDestination: returnDestinationInput.value.trim(),
                    dateTime: normalizeDateToStartOfDay(new Date(transferDateInput.value)),
                    cost: parseFloat(costInput.value),
                    authorizerName: authorizerNameInput.value,
                    companyName: companyNameInput.value
                };

                const success = await saveTransfer(transferData);
                if (success) {
                    transferForm.reset();
                    msoDepartmentsContainer.classList.add('hidden');
                    msoDepartmentInput.required = false;
                    serviceTypeBadge.classList.add('hidden');
                    transferDateInput.value = new Date().toISOString().slice(0, 10);
                    if (editingId) {
                        cancelEdit();
                    }
                }
            } catch (error) {
                console.error("Error al procesar el formulario:", error);
                showMessage("Error al procesar la solicitud.", "error");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
                document.body.classList.remove('loading');
            }
        });

        exportCsvBtn.addEventListener('click', () => {
            // Filtrar traslados según los filtros aplicados
            let transfersToExport = [...transfers];
            
            // Aplicar mismos filtros que en la vista
            if (currentFilters.name) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.requesterName.toLowerCase().includes(currentFilters.name)
                );
            }
            
            if (currentFilters.department) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.department === currentFilters.department
                );
            }
            
            if (currentFilters.company) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.companyName === currentFilters.company
                );
            }
            
            if (currentFilters.authorizer) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.authorizerName === currentFilters.authorizer
                );
            }
            
            if (currentFilters.dateStart && currentFilters.dateEnd) {
                transfersToExport = transfersToExport.filter(transfer => {
                    const transferDate = transfer.dateTime;
                    return transferDate >= currentFilters.dateStart && transferDate <= currentFilters.dateEnd;
                });
            }
            
            if (currentFilters.minCost !== null) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.cost >= currentFilters.minCost
                );
            }
            
            if (currentFilters.maxCost !== null) {
                transfersToExport = transfersToExport.filter(transfer =>
                    transfer.cost <= currentFilters.maxCost
                );
            }

            if (transfersToExport.length === 0) {
                showMessage("No hay datos para exportar con los filtros actuales.", "error");
                return;
            }
        
            const dataToExport = transfersToExport.map(t => {
                const serviceType = getServiceTypeWithMSO(t.department, t.msoDepartment);
                return {
                    'Fecha': t.dateTime.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                    'Solicitante': t.requesterName,
                    'Departamento': t.department,
                    'Tipo Servicio': serviceType.text,
                    'Depto. MSO': t.msoDepartment || '',
                    'Origen Partida': t.originPlace || '',
                    'Origen Destino': t.destinationPlace || '',
                    'Vuelta Partida': t.returnAddress || '',
                    'Vuelta Destino': t.returnDestination || '',
                    'Quién Autoriza': t.authorizerName,
                    'Empresa de Traslado': t.companyName,
                    'Costo ($)': t.cost
                };
            });

            const now = new Date();
            const currentYear = now.getFullYear();
            const startOfMonth = normalizeDateToStartOfDay(new Date(currentYear, now.getMonth(), 1));
            const monthlyTransfers = transfersToExport.filter(t => normalizeDateToStartOfDay(t.dateTime).getTime() >= startOfMonth.getTime());
            
            const departmentExpenses = {};
            monthlyTransfers.forEach(transfer => {
                let department = transfer.department || 'Desconocido';
                const serviceType = getServiceTypeWithMSO(transfer.department, transfer.msoDepartment);
                
                if ((department === 'Limpieza' || department === 'Colaboradores') && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                } else if (department === 'MSO' && transfer.msoDepartment) {
                    department = `MSO - ${transfer.msoDepartment}`;
                }
                
                departmentExpenses[department] = (departmentExpenses[department] || 0) + transfer.cost;
            });

            const departmentSummaryData = Object.entries(departmentExpenses).map(([department, cost]) => {
                const serviceType = department.includes('MSO') ? 'MSO' : 'CCS';
                return {
                    'Departamento': department,
                    'Tipo Servicio': serviceType,
                    'Gasto Mensual Total ($)': cost
                };
            });
            
            const mainWorksheet = XLSX.utils.json_to_sheet(dataToExport);
            const summaryWorksheet = XLSX.utils.json_to_sheet(departmentSummaryData);
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, mainWorksheet, 'Historial');
            XLSX.utils.book_append_sheet(workbook, summaryWorksheet, 'Resumen por Departamento');
            XLSX.writeFile(workbook, `traslados_taxi_${new Date().toISOString().slice(0,10)}.xlsx`);
        });

        importExcelBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data);
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                // Saltar la fila de encabezado y procesar datos
                const importedTransfers = [];
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length >= 11) {
                        const [dateStr, requesterName, department, msoDepartment, originPlace, destinationPlace, returnAddress, returnDestination, authorizerName, companyName, cost] = row;
                        
                        // Parsear fecha
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: msoDepartment?.toString() || '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: destinationPlace?.toString() || '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: returnDestination?.toString() || '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    } else if (row.length >= 8) {
                        // Formato antiguo (compatibilidad con archivos antiguos)
                        const [dateStr, requesterName, department, originPlace, returnAddress, authorizerName, companyName, cost] = row;
                        
                        let dateTime;
                        if (dateStr.includes('/')) {
                            const [day, month, year] = dateStr.split('/');
                            dateTime = normalizeDateToStartOfDay(new Date(year, month - 1, day));
                        } else {
                            dateTime = normalizeDateToStartOfDay(new Date(dateStr));
                        }

                        if (!isNaN(dateTime.getTime())) {
                            importedTransfers.push({
                                requesterName: requesterName?.toString() || '',
                                department: department?.toString() || '',
                                msoDepartment: '',
                                originPlace: originPlace?.toString() || '',
                                destinationPlace: '',
                                returnAddress: returnAddress?.toString() || '',
                                returnDestination: '',
                                dateTime: dateTime,
                                cost: parseFloat(cost) || 0,
                                authorizerName: authorizerName?.toString() || '',
                                companyName: companyName?.toString() || ''
                            });
                        }
                    }
                }

                // Guardar todos los traslados importados
                let successCount = 0;
                for (const transfer of importedTransfers) {
                    const success = await saveTransfer(transfer);
                    if (success) successCount++;
                }

                showMessage(`Importación completada: ${successCount}/${importedTransfers.length} traslados importados.`, "success");
                fileInput.value = '';

            } catch (error) {
                console.error("Error al importar archivo:", error);
                showMessage("Error al importar el archivo. Verifica el formato.", "error");
            }
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            if (checkboxes.length === 0) {
                showMessage("Por favor, selecciona al menos un traslado para eliminar.", "error");
                return;
            }

            if (!confirm(`¿Estás seguro de que deseas eliminar ${checkboxes.length} traslado(s)? Esta acción no se puede deshacer.`)) {
                return;
            }

            const idsToDelete = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            const success = await deleteTransfers(idsToDelete);
            if (success) {
                selectAllCheckboxes.checked = false;
            }
        });

        selectAllCheckboxes.addEventListener('change', (e) => {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(cb => cb.checked = e.target.checked);
        });

        // Redimensionar tabla cuando cambie el tamaño de la ventana
        window.addEventListener('resize', debounce(renderTransfers, 250));

        // Inicialización
        document.addEventListener('DOMContentLoaded', () => {
            transferDateInput.value = new Date().toISOString().slice(0, 10);
            
            // Establecer mes actual en el selector de reportes
            const currentMonth = new Date().getMonth();
            reportMonthSelect.value = currentMonth.toString();
            
            // Inicializar flatpickr
            initDateRangePicker();
            
            // Manejar cambio inicial del tipo de periodo
            handlePeriodTypeChange();
            
            loadTransfers();
        });

        // Limpiar suscripción al cerrar la página
        window.addEventListener('beforeunload', () => {
            if (unsubscribeTransfers) {
                unsubscribeTransfers();
            }
        });

        // Hacer las funciones accesibles globalmente
        window.startEditTransfer = startEditTransfer;
        window.toggleRowExpansion = toggleRowExpansion;
        window.toggleRowDetails = toggleRowDetails;
    </script>
</body>
</html>
